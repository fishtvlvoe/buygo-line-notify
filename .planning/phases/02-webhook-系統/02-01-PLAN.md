---
phase: 02-webhook-系統
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/api/class-line-webhook-api.php
  - includes/services/class-webhook-handler.php
autonomous: true

must_haves:
  truths:
    - "POST /wp-json/buygo-line-notify/v1/webhook 返回 200"
    - "無效簽名的請求返回 401"
    - "Verify Event（replyToken: 32 個 0）被正確識別"
    - "相同 webhookEventId 只處理一次"
    - "事件處理會觸發 do_action hooks"
    - "FastCGI 環境使用 shutdown hook + fastcgi_finish_request()"
    - "非 FastCGI 環境使用 wp_schedule_single_event()"
  artifacts:
    - path: "includes/api/class-line-webhook-api.php"
      provides: "REST API endpoint 和簽名驗證"
      min_lines: 100
      exports: ["LineWebhookApi"]
    - path: "includes/services/class-webhook-handler.php"
      provides: "事件去重和 Hooks 觸發"
      min_lines: 60
      exports: ["WebhookHandler"]
  key_links:
    - from: "includes/api/class-line-webhook-api.php"
      to: "includes/services/class-webhook-handler.php"
      via: "WebhookHandler 實例化"
      pattern: "new.*WebhookHandler"
    - from: "includes/api/class-line-webhook-api.php"
      to: "includes/services/class-settings-service.php"
      via: "SettingsService::get('channel_secret')"
      pattern: "SettingsService::get"
---

<objective>
實作 LINE Webhook 接收端點和事件處理系統

Purpose: 提供 LINE Messaging API 的 Webhook 接收能力，讓 LINE 平台可以將事件（message、follow、unfollow 等）傳送到 WordPress 網站
Output: REST API endpoint + Webhook Handler（含事件去重和 Hooks 機制）
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-webhook-系統/02-RESEARCH.md

# Phase 1 提供的基礎設施
@.planning/phases/01-基礎設施與設定/01-02-SUMMARY.md

# 現有實作參考
@/Users/fishtv/Development/buygo-plus-one-dev/includes/api/class-line-webhook-api.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 Webhook REST API Endpoint</name>
  <files>includes/api/class-line-webhook-api.php</files>
  <action>
**前置步驟：建立目錄**
```bash
mkdir -p includes/api
```

建立 `BuygoLineNotify\Api\LineWebhookApi` 類別：

1. **register_routes() 方法**
   - 命名空間：`buygo-line-notify/v1`
   - 路由：`/webhook`
   - 方法：POST
   - permission_callback：`__return_true`（不驗證 WP 權限，改用簽名驗證）

2. **handle_webhook() 方法**
   - 呼叫 verify_signature() 驗證簽名
   - 失敗返回 WP_Error（401）
   - 解析 JSON body 取得 events array
   - 檢查 Verify Event：若 replyToken === '00000000000000000000000000000000'，記錄 log 並跳過處理
   - **實例化 WebhookHandler 並呼叫處理：**
     ```php
     $handler = new \BuygoLineNotify\Services\WebhookHandler();
     ```
   - **背景處理策略（判斷 FastCGI）：**
     - 若 `function_exists('fastcgi_finish_request')`：
       - 先返回 response
       - 使用 `register_shutdown_function` + `fastcgi_finish_request()` 執行 `$handler->process_events($events)`
     - 否則（非 FastCGI）：
       - 使用 `wp_schedule_single_event(time(), 'buygo_process_line_webhook', [$events])`
   - 立即返回 rest_ensure_response(['success' => true])

3. **verify_signature() 方法**
   - 使用小寫 header key：`$request->get_header('x-line-signature')`
   - 從 SettingsService::get('channel_secret') 取得 secret
   - 使用 hash_hmac('sha256', $body, $secret, true) 計算簽名
   - 使用 hash_equals() 比較（防時序攻擊）
   - 開發環境且無 secret 時可選擇跳過驗證（呼叫 is_development_mode()）

4. **is_development_mode() 方法**
   - 檢查 WP_DEBUG 常數
   - 檢查 wp_get_environment_type()（WordPress 5.5+，返回 'local' 或 'development' 時為開發模式）
   - 檢查 SERVER_NAME（包含 'localhost'、'.local'、'127.0.0.1' 時為開發模式）
   - 任一條件符合即返回 true
  </action>
  <verify>
```bash
# 確認目錄已建立
ls -la includes/api/

# 檢查檔案存在且有正確的 namespace
grep -n "namespace BuygoLineNotify" includes/api/class-line-webhook-api.php

# 檢查 REST route 註冊
grep -n "register_rest_route" includes/api/class-line-webhook-api.php

# 檢查簽名驗證
grep -n "x-line-signature" includes/api/class-line-webhook-api.php
grep -n "hash_equals" includes/api/class-line-webhook-api.php

# 檢查 Verify Event 處理（32 個 0 的 replyToken）
grep -n "00000000000000000000000000000000" includes/api/class-line-webhook-api.php

# 檢查 FastCGI 判斷
grep -n "fastcgi_finish_request" includes/api/class-line-webhook-api.php
grep -n "register_shutdown_function" includes/api/class-line-webhook-api.php

# 檢查開發模式函數
grep -n "is_development_mode" includes/api/class-line-webhook-api.php
grep -n "wp_get_environment_type" includes/api/class-line-webhook-api.php

# 檢查 WebhookHandler 實例化和呼叫
grep -n "new.*WebhookHandler" includes/api/class-line-webhook-api.php
grep -n "process_events" includes/api/class-line-webhook-api.php
```
  </verify>
  <done>
- includes/api/ 目錄已建立
- LineWebhookApi 類別已建立
- register_routes() 註冊 POST /webhook
- verify_signature() 使用 HMAC-SHA256 和 hash_equals()
- handle_webhook() 正確處理 Verify Event（32 個 0 的 replyToken）
- handle_webhook() 實例化 WebhookHandler 並呼叫 process_events()
- FastCGI 環境使用 shutdown hook + fastcgi_finish_request()
- 非 FastCGI 環境使用 wp_schedule_single_event()
- is_development_mode() 函數存在並檢查 WP_DEBUG / wp_get_environment_type() / SERVER_NAME
  </done>
</task>

<task type="auto">
  <name>Task 2: 建立 Webhook Handler 事件處理器</name>
  <files>includes/services/class-webhook-handler.php</files>
  <action>
建立 `BuygoLineNotify\Services\WebhookHandler` 類別：

1. **process_events($events, $return_response = true) 方法**
   - 呼叫 ignore_user_abort(true) 和 set_time_limit(0)
   - 迴圈處理每個 event
   - 去重檢查：
     - 取得 webhookEventId
     - 檢查 transient `buygo_line_event_{id}`
     - 存在則 continue
     - 不存在則 set_transient（60 秒）
   - 呼叫 handle_event()

2. **handle_event($event) 方法**
   - 取得 event type
   - 觸發通用 hook：`do_action('buygo_line_notify/webhook/event', $event)`
   - 根據 type 觸發特定 hooks：
     - message → `buygo_line_notify/webhook/message`
     - follow → `buygo_line_notify/webhook/follow`
     - unfollow → `buygo_line_notify/webhook/unfollow`
     - postback → `buygo_line_notify/webhook/postback`
     - join → `buygo_line_notify/webhook/join`
     - leave → `buygo_line_notify/webhook/leave`

3. **Hook 命名規範**
   - 統一使用 `buygo_line_notify/webhook/{type}` 格式
   - 參數只傳 $event（完整 event 物件）
   - 其他外掛透過 add_action 註冊處理器
  </action>
  <verify>
```bash
# 檢查檔案存在且有正確的 hooks
grep -n "namespace BuygoLineNotify" includes/services/class-webhook-handler.php
grep -n "do_action" includes/services/class-webhook-handler.php
grep -n "buygo_line_notify/webhook" includes/services/class-webhook-handler.php
grep -n "get_transient\|set_transient" includes/services/class-webhook-handler.php
```
  </verify>
  <done>
- WebhookHandler 類別已建立
- process_events() 實作事件去重（transient 60 秒）
- handle_event() 觸發 6 個以上的 action hooks
- 其他外掛可透過 add_action 註冊處理器
  </done>
</task>

</tasks>

<verification>
**程式碼檢查：**
```bash
# 確認兩個檔案都存在
ls -la includes/api/class-line-webhook-api.php
ls -la includes/services/class-webhook-handler.php

# 確認 namespace 和類別名稱
grep -n "class LineWebhookApi" includes/api/class-line-webhook-api.php
grep -n "class WebhookHandler" includes/services/class-webhook-handler.php

# 確認關鍵功能
grep -c "do_action" includes/services/class-webhook-handler.php  # 應 >= 6
```

**Requirements 覆蓋：**
- WEBHOOK-01: ✅ REST endpoint 已建立
- WEBHOOK-02: ✅ 簽名驗證已實作
- WEBHOOK-03: ✅ Verify Event 處理已實作
- WEBHOOK-04: ✅ 事件去重已實作
- WEBHOOK-05: ✅ 背景處理已實作
- WEBHOOK-06: ✅ Hooks 機制已實作
</verification>

<success_criteria>
1. includes/api/class-line-webhook-api.php 存在且包含 register_routes()
2. includes/services/class-webhook-handler.php 存在且包含 process_events()
3. 簽名驗證使用 hash_equals() 防止時序攻擊
4. 事件去重使用 transient（60 秒有效期）
5. 至少 6 個 action hooks（event, message, follow, unfollow, postback, join/leave）
</success_criteria>

<output>
完成後建立 `.planning/phases/02-webhook-系統/02-01-SUMMARY.md`
</output>
