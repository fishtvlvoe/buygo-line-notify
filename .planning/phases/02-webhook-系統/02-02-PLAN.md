---
phase: 02-webhook-系統
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - includes/class-plugin.php
  - buygo-line-notify.php
autonomous: false

must_haves:
  truths:
    - "外掛啟動後 /wp-json/buygo-line-notify/v1/webhook 可正常訪問"
    - "LINE Developers Console 的「驗證」按鈕點擊後顯示成功"
    - "WordPress Cron hook buygo_process_line_webhook 已註冊"
  artifacts:
    - path: "includes/class-plugin.php"
      provides: "REST routes 註冊"
      contains: "rest_api_init"
    - path: "buygo-line-notify.php"
      provides: "Cron hook 註冊"
      contains: "buygo_process_line_webhook"
  key_links:
    - from: "includes/class-plugin.php"
      to: "includes/api/class-line-webhook-api.php"
      via: "rest_api_init hook"
      pattern: "LineWebhookApi.*register_routes"
    - from: "buygo-line-notify.php"
      to: "includes/services/class-webhook-handler.php"
      via: "add_action buygo_process_line_webhook"
      pattern: "add_action.*buygo_process_line_webhook"
---

<objective>
整合 Webhook API 到外掛主流程並進行人工驗證

Purpose: 確保 Webhook endpoint 正確註冊並可被 LINE 平台存取
Output: 完整可運作的 Webhook 系統 + LINE Console 驗證通過
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-webhook-系統/02-RESEARCH.md
@.planning/phases/02-webhook-系統/02-01-SUMMARY.md

# 現有 Plugin 類別
@includes/class-plugin.php
@buygo-line-notify.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 整合 REST API 和 Cron Hook</name>
  <files>includes/class-plugin.php, buygo-line-notify.php</files>
  <action>
**修改 includes/class-plugin.php：**

1. 在 `load_dependencies()` 方法中載入新檔案：
```php
require_once BUYGOLINENOTIFY_PLUGIN_DIR . 'includes/api/class-line-webhook-api.php';
require_once BUYGOLINENOTIFY_PLUGIN_DIR . 'includes/services/class-webhook-handler.php';
```

2. 在 `register_hooks()` 方法中註冊 REST routes：
```php
add_action('rest_api_init', function() {
    $webhook_api = new \BuygoLineNotify\Api\LineWebhookApi();
    $webhook_api->register_routes();
});
```

**修改 buygo-line-notify.php：**

3. 在主檔案中註冊 Cron hook（用於非 FastCGI 環境的背景處理）：
```php
add_action('buygo_process_line_webhook', function($events) {
    $handler = new \BuygoLineNotify\Services\WebhookHandler();
    $handler->process_events($events, false);
});
```

**確保常數定義正確：**
- 檢查 BUYGOLINENOTIFY_PLUGIN_DIR 常數是否已定義
- 如果使用其他常數名稱，統一修正
  </action>
  <verify>
```bash
# 檢查 Plugin 類別載入新檔案
grep -n "class-line-webhook-api.php" includes/class-plugin.php
grep -n "class-webhook-handler.php" includes/class-plugin.php

# 檢查 REST routes 註冊
grep -n "rest_api_init" includes/class-plugin.php
grep -n "register_routes" includes/class-plugin.php

# 檢查 Cron hook 註冊
grep -n "buygo_process_line_webhook" buygo-line-notify.php
```
  </verify>
  <done>
- Plugin 類別載入 LineWebhookApi 和 WebhookHandler
- rest_api_init hook 註冊 REST routes
- buygo_process_line_webhook cron hook 註冊處理器
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
LINE Webhook 完整系統：
- REST API endpoint: /wp-json/buygo-line-notify/v1/webhook
- 簽名驗證（HMAC-SHA256）
- Verify Event 處理
- 事件去重（transient 60 秒）
- 背景處理（FastCGI / Cron）
- Hooks 機制（buygo_line_notify/webhook/*）
  </what-built>
  <how-to-verify>
**步驟 1：確認 endpoint 可訪問**
1. 打開瀏覽器訪問 https://test.buygo.me/wp-json/buygo-line-notify/v1/webhook
2. 應該看到 `{"code":"rest_no_route"...}` 或類似錯誤（因為是 GET 請求）
3. 這表示 endpoint 已註冊成功

**步驟 2：LINE Developers Console 驗證**
1. 登入 LINE Developers Console
2. 進入 Messaging API Channel
3. 在 Webhook settings 區域：
   - 設定 Webhook URL 為：`https://test.buygo.me/wp-json/buygo-line-notify/v1/webhook`
   - 點擊「Verify」按鈕
4. 應該顯示「Success」

**步驟 3（可選）：確認 Hooks 可用**
在 buygo-plus-one-dev 的 functions.php 或任意位置加入測試 hook：
```php
add_action('buygo_line_notify/webhook/message', function($event) {
    error_log('Webhook message event received: ' . json_encode($event));
}, 10, 1);
```
然後用 LINE 發送訊息，檢查 error_log 是否有記錄。
  </how-to-verify>
  <resume-signal>
回報驗證結果：
- "approved" - 所有驗證通過
- 描述遇到的問題 - 需要修正
  </resume-signal>
</task>

</tasks>

<verification>
**整合檢查：**
```bash
# 確認外掛可正常載入（無 PHP 錯誤）
php -l includes/class-plugin.php
php -l includes/api/class-line-webhook-api.php
php -l includes/services/class-webhook-handler.php
php -l buygo-line-notify.php

# 確認所有 require 路徑正確
grep -rn "require.*class-line-webhook-api" includes/
grep -rn "require.*class-webhook-handler" includes/
```

**REST API 檢查：**
- GET /wp-json/buygo-line-notify/v1/webhook → 404 或 405（方法不允許）
- POST /wp-json/buygo-line-notify/v1/webhook（無簽名）→ 401
- POST /wp-json/buygo-line-notify/v1/webhook（有效簽名）→ 200

**LINE Console 驗證：**
- 「Verify」按鈕點擊後顯示「Success」
</verification>

<success_criteria>
1. 外掛啟動後無 PHP 錯誤
2. /wp-json/buygo-line-notify/v1/webhook endpoint 存在
3. LINE Developers Console 驗證成功
4. Cron hook buygo_process_line_webhook 已註冊
</success_criteria>

<output>
完成後建立 `.planning/phases/02-webhook-系統/02-02-SUMMARY.md`
</output>
