---
phase: 08-資料表架構與查詢-api
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - includes/services/class-line-user-service.php
autonomous: true

must_haves:
  truths:
    - "getUserByLineUid() 可根據 LINE UID 查詢 WordPress User ID"
    - "getLineUidByUserId() 可根據 WordPress User ID 查詢 LINE UID"
    - "isUserLinked() 可檢查用戶是否已綁定 LINE"
    - "linkUser() 可建立用戶與 LINE 的綁定關係（支援 is_registration 參數）"
    - "unlinkUser() 可解除綁定（刪除記錄，與 Nextend 一致）"
    - "所有查詢使用新表 wp_buygo_line_users 作為單一真實來源"
  artifacts:
    - path: "includes/services/class-line-user-service.php"
      provides: "LINE 用戶查詢 API"
      exports: ["getUserByLineUid", "getLineUidByUserId", "isUserLinked", "linkUser", "unlinkUser"]
  key_links:
    - from: "includes/services/class-line-user-service.php"
      to: "wp_buygo_line_users table"
      via: "$wpdb->prepare()"
      pattern: "buygo_line_users.*WHERE"
---

<objective>
重構 LineUserService 查詢 API，使用新的 wp_buygo_line_users 資料表作為單一真實來源，提供符合 ARCH-03 需求的五個核心方法。

Purpose: 建立統一的查詢 API，取代混合儲存的查詢邏輯（user_meta + custom table），確保後續 LINE Login 流程可正確使用。
Output: 重構後的 LineUserService 類別，包含 getUserByLineUid、getLineUidByUserId、isUserLinked、linkUser、unlinkUser 五個核心方法。
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS-v0.2.md
@.planning/phases/08-資料表架構與查詢-api/08-RESEARCH.md
@.planning/phases/08-資料表架構與查詢-api/08-01-SUMMARY.md
@includes/services/class-line-user-service.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 實作新的查詢 API 方法</name>
  <files>includes/services/class-line-user-service.php</files>
  <action>
在 LineUserService 類別中新增/重構符合 ARCH-03 需求的方法：

1. getUserByLineUid(string $line_uid): ?int
   - 根據 LINE UID（identifier）查詢 WordPress User ID
   - 查詢 wp_buygo_line_users 表，條件 identifier = $line_uid AND type = 'line'
   - 返回 user_id（int）或 null

2. getLineUidByUserId(int $user_id): ?string
   - 根據 WordPress User ID 查詢 LINE UID
   - 查詢 wp_buygo_line_users 表，條件 user_id = $user_id AND type = 'line'
   - 返回 identifier（string）或 null

3. isUserLinked(int $user_id): bool
   - 檢查用戶是否已綁定 LINE
   - 呼叫 getLineUidByUserId()，返回 !is_null(result)

4. linkUser(int $user_id, string $line_uid, bool $is_registration = false): bool
   - 建立用戶與 LINE 的綁定關係
   - 檢查 LINE UID 是否已綁定其他用戶（拒絕重複綁定）
   - 檢查用戶是否已綁定其他 LINE（拒絕重複綁定）
   - 若已存在相同綁定：更新 link_date
   - 若為新綁定：插入新記錄
   - is_registration = true 時設定 register_date
   - 返回 bool

5. unlinkUser(int $user_id): bool
   - 解除用戶與 LINE 的綁定
   - 使用 DELETE（硬刪除，與 Nextend wp_social_users 一致）
   - 返回 bool

所有方法使用 $wpdb->prepare() 防止 SQL injection。
  </action>
  <verify>
檢查新 API 方法存在：
- grep "function getUserByLineUid" includes/services/class-line-user-service.php
- grep "function getLineUidByUserId" includes/services/class-line-user-service.php
- grep "function isUserLinked" includes/services/class-line-user-service.php
- grep "function linkUser" includes/services/class-line-user-service.php
- grep "function unlinkUser" includes/services/class-line-user-service.php
  </verify>
  <done>
LineUserService 包含五個核心方法：getUserByLineUid、getLineUidByUserId、isUserLinked、linkUser、unlinkUser，全部查詢 wp_buygo_line_users 表
  </done>
</task>

<task type="auto">
  <name>Task 2: 保留舊方法並標記 deprecated</name>
  <files>includes/services/class-line-user-service.php</files>
  <action>
保留現有方法但標記為 @deprecated，確保向後相容：

1. 舊方法保留清單（標記 @deprecated）：
   - bind_line_account() → 內部改呼叫 linkUser()
   - get_user_line_id() → 內部改呼叫 getLineUidByUserId()
   - get_line_user() → 維持原邏輯但查詢新表
   - get_user_binding() → 維持原邏輯但查詢新表（或重新命名為 getBinding）
   - unbind_line_account() → 內部改呼叫 unlinkUser()
   - is_user_bound() → 內部改呼叫 isUserLinked()
   - is_line_uid_bound() → 使用 getUserByLineUid() 實作
   - get_user_id_by_line_uid() → 內部改呼叫 getUserByLineUid()
   - get_line_uid_by_user_id() → 內部改呼叫 getLineUidByUserId()
   - unbind_line_user() → 內部改呼叫 unlinkUser()

2. 每個舊方法加上 @deprecated 註解：
   - @deprecated 2.0.0 Use XXX() instead.

3. 舊方法內部呼叫新方法：
   - 確保行為一致
   - 方便日後移除舊方法
  </action>
  <verify>
檢查舊方法標記為 deprecated：
- grep "@deprecated" includes/services/class-line-user-service.php
- grep "Use getUserByLineUid" includes/services/class-line-user-service.php
  </verify>
  <done>
舊方法全部保留並標記 @deprecated，內部改呼叫新方法，確保向後相容
  </done>
</task>

<task type="auto">
  <name>Task 3: 新增 getBinding 輔助方法</name>
  <files>includes/services/class-line-user-service.php</files>
  <action>
新增輔助方法供進階查詢使用：

1. getBinding(int $user_id): ?object
   - 取得完整的綁定資料（包含所有欄位）
   - 返回 object（ID, type, identifier, user_id, register_date, link_date）或 null
   - 用於需要完整資料的場景（如後台顯示）

2. getBindingByLineUid(string $line_uid): ?object
   - 根據 LINE UID 取得完整綁定資料
   - 返回 object 或 null

3. 更新類別 docblock：
   - 說明這是 v0.2 重構後的新 API
   - 列出核心方法：getUserByLineUid、getLineUidByUserId、isUserLinked、linkUser、unlinkUser
   - 說明舊方法已 deprecated
  </action>
  <verify>
檢查輔助方法存在：
- grep "function getBinding" includes/services/class-line-user-service.php
- grep "function getBindingByLineUid" includes/services/class-line-user-service.php
  </verify>
  <done>
LineUserService 包含 getBinding 和 getBindingByLineUid 輔助方法，類別 docblock 已更新說明新 API
  </done>
</task>

</tasks>

<verification>
1. 五個核心方法存在且正確實作：
   - getUserByLineUid(string): ?int
   - getLineUidByUserId(int): ?string
   - isUserLinked(int): bool
   - linkUser(int, string, bool): bool
   - unlinkUser(int): bool

2. 所有查詢使用新表 wp_buygo_line_users：
   - 不再查詢 wp_buygo_line_bindings
   - 不再讀取 user_meta

3. 舊方法向後相容：
   - 保留所有舊方法
   - 標記 @deprecated
   - 內部呼叫新方法

4. 程式碼品質：
   - 使用 $wpdb->prepare() 防止 SQL injection
   - 類型提示完整（PHP 7.4+）
   - 符合現有程式碼風格
</verification>

<success_criteria>
1. getUserByLineUid() 可正確查詢 WordPress User ID
2. getLineUidByUserId() 可正確查詢 LINE UID
3. isUserLinked() 正確判斷綁定狀態
4. linkUser() 可建立新綁定並處理衝突
5. unlinkUser() 可刪除綁定記錄
6. 舊方法保留並標記 deprecated
7. 所有查詢使用 wp_buygo_line_users 表
</success_criteria>

<output>
完成後，建立 `.planning/phases/08-資料表架構與查詢-api/08-02-SUMMARY.md`
</output>
