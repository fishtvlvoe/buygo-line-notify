---
phase: 08-資料表架構與查詢-api
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-database.php
autonomous: true

must_haves:
  truths:
    - "wp_buygo_line_users 資料表已建立，包含 ID、type、identifier、user_id、register_date、link_date 欄位"
    - "資料庫版本升級為 2.0.0，記錄在 wp_options（buygo_line_db_version）"
    - "舊表 wp_buygo_line_bindings 資料已成功遷移到新表（register_date = created_at, link_date = updated_at）"
    - "遷移狀態已記錄到 wp_options（buygo_line_migration_status），舊表保留未刪除"
  artifacts:
    - path: "includes/class-database.php"
      provides: "新資料表建立與遷移邏輯"
      contains: "wp_buygo_line_users"
  key_links:
    - from: "includes/class-database.php"
      to: "wp_buygo_line_users table"
      via: "dbDelta()"
      pattern: "dbDelta.*buygo_line_users"
---

<objective>
建立 wp_buygo_line_users 專用資料表，對齊 Nextend wp_social_users 結構，並實作從舊表 wp_buygo_line_bindings 的資料遷移機制。

Purpose: 取代混合儲存架構（user_meta + custom table），建立單一真實來源，為後續 LINE Login 重構奠定資料基礎。
Output: 修改後的 Database 類別，包含新表建立和資料遷移邏輯。
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS-v0.2.md
@.planning/phases/08-資料表架構與查詢-api/08-RESEARCH.md
@includes/class-database.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 wp_buygo_line_users 資料表</name>
  <files>includes/class-database.php</files>
  <action>
修改 Database 類別，建立 wp_buygo_line_users 新資料表：

1. 更新 DB_VERSION 常數為 '2.0.0'
2. 更新版本追蹤 option 名稱為 'buygo_line_db_version'（統一命名）
3. 新增 create_line_users_table() 方法，使用 dbDelta() 建立新表：
   - ID: bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT
   - type: varchar(20) NOT NULL DEFAULT 'line'
   - identifier: varchar(255) NOT NULL（LINE UID）
   - user_id: bigint(20) UNSIGNED NOT NULL
   - register_date: datetime DEFAULT NULL（註冊時間）
   - link_date: datetime DEFAULT NULL（綁定時間）
   - PRIMARY KEY (ID)（注意：兩個空格）
   - UNIQUE KEY identifier (identifier)
   - KEY user_id (user_id)
   - KEY type (type)

4. 修改 init() 方法：
   - 檢查版本比對後呼叫 create_line_users_table()
   - 若從 1.x 升級，呼叫遷移方法

dbDelta 格式要求：
- PRIMARY KEY 後必須有兩個空格
- 使用 KEY 而非 INDEX
- 不使用 IF NOT EXISTS
- 使用 $wpdb->get_charset_collate()
  </action>
  <verify>
檢查 Database::create_line_users_table() 方法存在且 SQL 格式正確：
- grep "buygo_line_users" includes/class-database.php
- grep "PRIMARY KEY  (ID)" includes/class-database.php
- grep "DB_VERSION = '2.0.0'" includes/class-database.php
  </verify>
  <done>
Database 類別包含 create_line_users_table() 方法，SQL 使用正確的 dbDelta 格式（PRIMARY KEY 兩個空格、KEY 而非 INDEX）
  </done>
</task>

<task type="auto">
  <name>Task 2: 實作資料遷移機制</name>
  <files>includes/class-database.php</files>
  <action>
在 Database 類別中新增資料遷移方法：

1. 新增 migrate_from_bindings_table() 方法：
   - 檢查遷移狀態（get_option('buygo_line_migration_status')）
   - 若已完成（有 completed_at），直接返回
   - 檢查舊表 wp_buygo_line_bindings 是否存在
   - 若不存在，記錄 status: skipped, reason: old_table_not_found
   - 讀取舊表 active 狀態的資料

2. 遷移欄位對應：
   - type: 固定為 'line'
   - identifier: 來自 line_uid
   - user_id: 來自 user_id
   - register_date: 來自 created_at（首次綁定視為註冊）
   - link_date: 來自 updated_at（若為 NULL 則使用 created_at）

3. 遷移邏輯：
   - 遍歷每筆舊資料
   - 檢查 identifier 是否已存在於新表（避免重複）
   - 使用 $wpdb->insert() 插入新表
   - 記錄成功/失敗計數

4. 記錄遷移狀態到 wp_options：
   - status: completed 或 skipped
   - migrated_count: 成功遷移筆數
   - error_count: 失敗筆數
   - errors: 錯誤詳情陣列
   - old_table / new_table: 表名
   - completed_at: 完成時間

5. 重要：舊表保留不刪除
  </action>
  <verify>
檢查遷移方法存在且邏輯正確：
- grep "migrate_from_bindings_table" includes/class-database.php
- grep "buygo_line_migration_status" includes/class-database.php
- grep "migrated_count" includes/class-database.php
  </verify>
  <done>
migrate_from_bindings_table() 方法完成：檢查遷移狀態 → 讀取舊表 → 遍歷遷移 → 記錄狀態，舊表保留不刪除
  </done>
</task>

<task type="auto">
  <name>Task 3: 整合到初始化流程並更新 drop_tables</name>
  <files>includes/class-database.php</files>
  <action>
整合新的資料表建立和遷移到初始化流程：

1. 修改 init() 方法：
   - 版本比對使用新的 option key: 'buygo_line_db_version'
   - 若版本小於 2.0.0：
     - 先呼叫 create_line_users_table()
     - 再呼叫 migrate_from_bindings_table()
   - 更新版本號

2. 保留 create_tables() 方法（建立舊表 wp_buygo_line_bindings）：
   - 這是為了向後相容，萬一有其他程式碼依賴舊表
   - 不刪除舊表建立邏輯

3. 修改 drop_tables() 方法：
   - 新增刪除 wp_buygo_line_users 表
   - 刪除 buygo_line_db_version option
   - 刪除 buygo_line_migration_status option
   - 保留刪除舊表的邏輯

4. 新增 get_migration_status() 靜態方法：
   - 返回遷移狀態（用於後台顯示）
  </action>
  <verify>
檢查初始化流程整合正確：
- grep "buygo_line_db_version" includes/class-database.php
- grep "create_line_users_table" includes/class-database.php
- grep "get_migration_status" includes/class-database.php
  </verify>
  <done>
Database::init() 正確呼叫新表建立和遷移；drop_tables() 清理所有相關資料；get_migration_status() 可查詢遷移狀態
  </done>
</task>

</tasks>

<verification>
1. Database 類別版本更新：
   - DB_VERSION = '2.0.0'
   - 版本追蹤使用 'buygo_line_db_version'

2. 新表 SQL 格式正確：
   - 使用 dbDelta()
   - PRIMARY KEY 有兩個空格
   - 使用 KEY 而非 INDEX
   - 欄位包含 ID, type, identifier, user_id, register_date, link_date

3. 遷移邏輯完整：
   - 檢查遷移狀態避免重複執行
   - 正確對應欄位（line_uid → identifier, created_at → register_date）
   - 記錄遷移狀態到 wp_options
   - 舊表保留不刪除

4. 程式碼品質：
   - 使用 $wpdb->prepare() 防止 SQL injection
   - 類型提示完整（PHP 7.4+）
   - 符合現有程式碼風格
</verification>

<success_criteria>
1. includes/class-database.php 包含 create_line_users_table() 方法
2. includes/class-database.php 包含 migrate_from_bindings_table() 方法
3. Database::init() 在版本升級時呼叫遷移
4. SQL 使用正確的 dbDelta 格式
5. 遷移狀態記錄到 wp_options
</success_criteria>

<output>
完成後，建立 `.planning/phases/08-資料表架構與查詢-api/08-01-SUMMARY.md`
</output>
