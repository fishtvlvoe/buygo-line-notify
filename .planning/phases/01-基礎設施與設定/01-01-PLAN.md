---
phase: 01-基礎設施與設定
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/class-database.php
  - includes/services/class-line-user-service.php
  - buygo-line-notify.php
autonomous: true

must_haves:
  truths:
    - "wp_buygo_line_bindings 資料表已建立且包含所有必要欄位"
    - "外掛啟動時會自動檢查並建立資料表"
    - "可透過 LineUserService 查詢 user_id 或 line_uid 的綁定資料"
    - "綁定資料會同時寫入 user_meta 和 bindings 表（雙寫）"
  artifacts:
    - path: "includes/class-database.php"
      provides: "資料表建立與版本管理"
      min_lines: 80
    - path: "includes/services/class-line-user-service.php"
      provides: "LINE 用戶綁定與查詢 API"
      exports: ["bind_line_account", "get_user_line_id", "get_line_user"]
    - path: "buygo-line-notify.php"
      provides: "外掛啟動時呼叫資料庫初始化"
      contains: "register_activation_hook"
  key_links:
    - from: "buygo-line-notify.php"
      to: "includes/class-database.php"
      via: "register_activation_hook callback"
      pattern: "register_activation_hook.*Database::init"
    - from: "includes/services/class-line-user-service.php"
      to: "wp_buygo_line_bindings"
      via: "$wpdb->insert and $wpdb->get_row"
      pattern: "\\$wpdb->.*buygo_line_bindings"
    - from: "includes/services/class-line-user-service.php"
      to: "user_meta"
      via: "update_user_meta and get_user_meta"
      pattern: "(update|get)_user_meta.*buygo_line"
---

<objective>
建立 LINE 綁定的資料庫基礎設施，包含 wp_buygo_line_bindings 資料表和混合儲存查詢 API。

Purpose: 提供 LINE 用戶綁定資料的永久儲存，同時兼顧向後相容性（user_meta）和查詢效能（custom table）。
Output: Database class（表建立）、LineUserService（綁定/查詢 API）、外掛啟動時自動初始化。
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/REQUIREMENTS.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-基礎設施與設定/01-RESEARCH.md
@.planning/codebase/ARCHITECTURE.md

# 現有程式碼參考
@includes/class-plugin.php
@buygo-line-notify.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 Database 類別並實作 wp_buygo_line_bindings 資料表</name>
  <files>includes/class-database.php</files>
  <action>
建立 Database 類別，使用 dbDelta() 建立 wp_buygo_line_bindings 資料表。

**結構要求（參考 RESEARCH.md Pattern 1）：**
```php
namespace BuygoLineNotify;

class Database {
    const DB_VERSION = '1.0.0';

    public static function init(): void {
        // 檢查版本，決定是否需要升級
        $current_version = get_option('buygo_line_notify_db_version', '0.0.0');
        if (version_compare($current_version, self::DB_VERSION, '<')) {
            self::create_tables();
            update_option('buygo_line_notify_db_version', self::DB_VERSION);
        }
    }

    public static function create_tables(): void {
        global $wpdb;
        require_once ABSPATH . 'wp-admin/includes/upgrade.php';

        $charset_collate = $wpdb->get_charset_collate();
        $table_name = $wpdb->prefix . 'buygo_line_bindings';

        // 先檢查表是否已存在（避免重複執行 dbDelta）
        if ($wpdb->get_var("SHOW TABLES LIKE '{$table_name}'") === $table_name) {
            return;
        }

        // dbDelta 語法嚴格要求（參考 RESEARCH.md 重要說明）
        $sql = "CREATE TABLE {$table_name} (
            id bigint(20) NOT NULL AUTO_INCREMENT,
            user_id bigint(20) NOT NULL,
            line_uid varchar(100) NOT NULL,
            display_name varchar(255),
            picture_url varchar(512),
            status varchar(20) DEFAULT 'active',
            created_at datetime DEFAULT CURRENT_TIMESTAMP,
            updated_at datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            PRIMARY KEY  (id),
            UNIQUE KEY idx_user_id (user_id),
            UNIQUE KEY idx_line_uid (line_uid),
            KEY idx_status (status)
        ) {$charset_collate};";

        dbDelta($sql);
    }
}
```

**注意事項（避免 Pitfall 1）：**
- PRIMARY KEY 後必須有兩個空格
- 每個欄位獨立一行
- 不使用 `IF NOT EXISTS`（dbDelta 會自動處理）
- UNIQUE KEY 確保一個使用者只能綁定一個 LINE，一個 LINE 只能綁定一個使用者

在 buygo-line-notify.php 註冊啟動 hook：
```php
register_activation_hook(__FILE__, function() {
    \BuygoLineNotify\Database::init();
});
```

同時在 Plugin::init() 中呼叫（處理外掛更新情境）：
```php
// 在 loadDependencies() 之前
\BuygoLineNotify\Database::init();
```
  </action>
  <verify>
執行以下 SQL 檢查資料表是否建立成功：
```bash
wp db query "DESCRIBE wp_buygo_line_bindings" --path=/Users/fishtv/Local\ Sites/buygo/app/public
```

應該看到 8 個欄位：id, user_id, line_uid, display_name, picture_url, status, created_at, updated_at

檢查索引：
```bash
wp db query "SHOW INDEX FROM wp_buygo_line_bindings" --path=/Users/fishtv/Local\ Sites/buygo/app/public
```

應該看到 4 個索引：PRIMARY, idx_user_id (UNIQUE), idx_line_uid (UNIQUE), idx_status
  </verify>
  <done>
- Database class 存在於 includes/class-database.php
- wp_buygo_line_bindings 表包含所有必要欄位和索引
- buygo-line-notify.php 註冊 activation hook 呼叫 Database::init()
- buygo_line_notify_db_version option 已設定為 1.0.0
  </done>
</task>

<task type="auto">
  <name>Task 2: 建立 LineUserService 實作混合儲存 API</name>
  <files>includes/services/class-line-user-service.php</files>
  <action>
建立 LineUserService，提供 LINE 綁定的寫入和查詢 API，實作混合儲存策略（user_meta + bindings 表）。

**API 設計（參考 RESEARCH.md Pattern 4）：**
```php
namespace BuygoLineNotify\Services;

class LineUserService {

    /**
     * 綁定 LINE 帳號到 WordPress 使用者
     * 雙寫：custom table（主要）+ user_meta（相容性）
     */
    public static function bind_line_account(int $user_id, string $line_uid, array $profile): bool {
        global $wpdb;
        $table_name = $wpdb->prefix . 'buygo_line_bindings';

        // 檢查是否已綁定
        $existing = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM {$table_name} WHERE user_id = %d OR line_uid = %s",
            $user_id, $line_uid
        ));

        if ($existing) {
            // 更新現有綁定
            $wpdb->update(
                $table_name,
                [
                    'user_id' => $user_id,
                    'line_uid' => $line_uid,
                    'display_name' => $profile['displayName'] ?? '',
                    'picture_url' => $profile['pictureUrl'] ?? '',
                    'status' => 'active',
                ],
                ['id' => $existing->id],
                ['%d', '%s', '%s', '%s', '%s'],
                ['%d']
            );
        } else {
            // 新增綁定
            $wpdb->insert(
                $table_name,
                [
                    'user_id' => $user_id,
                    'line_uid' => $line_uid,
                    'display_name' => $profile['displayName'] ?? '',
                    'picture_url' => $profile['pictureUrl'] ?? '',
                    'status' => 'active',
                ],
                ['%d', '%s', '%s', '%s', '%s']
            );
        }

        // 同時寫入 user_meta（向後相容）
        update_user_meta($user_id, 'buygo_line_user_id', $line_uid);
        update_user_meta($user_id, 'buygo_line_display_name', $profile['displayName'] ?? '');
        update_user_meta($user_id, 'buygo_line_picture_url', $profile['pictureUrl'] ?? '');

        return true;
    }

    /**
     * 根據 user_id 取得 LINE UID
     * 優先從 user_meta 讀取（有快取）
     */
    public static function get_user_line_id(int $user_id): ?string {
        // 優先從 user_meta（WordPress 快取）
        $line_id = get_user_meta($user_id, 'buygo_line_user_id', true);

        if (!empty($line_id)) {
            return $line_id;
        }

        // 備用：從 custom table
        global $wpdb;
        $table_name = $wpdb->prefix . 'buygo_line_bindings';
        return $wpdb->get_var($wpdb->prepare(
            "SELECT line_uid FROM {$table_name} WHERE user_id = %d AND status = 'active'",
            $user_id
        ));
    }

    /**
     * 根據 line_uid 取得完整綁定資料
     */
    public static function get_line_user(string $line_uid): ?object {
        global $wpdb;
        $table_name = $wpdb->prefix . 'buygo_line_bindings';
        return $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM {$table_name} WHERE line_uid = %s AND status = 'active'",
            $line_uid
        ));
    }

    /**
     * 解除綁定（軟刪除）
     */
    public static function unbind_line_account(int $user_id): bool {
        global $wpdb;
        $table_name = $wpdb->prefix . 'buygo_line_bindings';

        $wpdb->update(
            $table_name,
            ['status' => 'inactive'],
            ['user_id' => $user_id],
            ['%s'],
            ['%d']
        );

        // 同時更新 user_meta
        delete_user_meta($user_id, 'buygo_line_user_id');
        delete_user_meta($user_id, 'buygo_line_display_name');
        delete_user_meta($user_id, 'buygo_line_picture_url');

        return true;
    }
}
```

在 Plugin::loadDependencies() 加入載入：
```php
include_once BuygoLineNotify_PLUGIN_DIR . 'includes/services/class-line-user-service.php';
```
  </action>
  <verify>
建立測試 PHP 腳本驗證 API：
```php
// 在 WordPress admin 執行（或使用 wp eval-file）
$user_id = 1; // 測試用戶
$line_uid = 'U1234567890abcdef';
$profile = [
    'displayName' => '測試使用者',
    'pictureUrl' => 'https://example.com/avatar.jpg'
];

// 測試綁定
$result = \BuygoLineNotify\Services\LineUserService::bind_line_account($user_id, $line_uid, $profile);
var_dump($result); // should be true

// 測試查詢（by user_id）
$line_id = \BuygoLineNotify\Services\LineUserService::get_user_line_id($user_id);
var_dump($line_id); // should be 'U1234567890abcdef'

// 測試查詢（by line_uid）
$user_data = \BuygoLineNotify\Services\LineUserService::get_line_user($line_uid);
var_dump($user_data); // should be object with all fields

// 驗證 user_meta 也有寫入
$meta_line_id = get_user_meta($user_id, 'buygo_line_user_id', true);
var_dump($meta_line_id); // should be 'U1234567890abcdef'
```
  </verify>
  <done>
- LineUserService class 存在於 includes/services/class-line-user-service.php
- bind_line_account() 可成功寫入 bindings 表和 user_meta
- get_user_line_id() 可從 user_meta 或 bindings 表查詢
- get_line_user() 可根據 line_uid 查詢完整資料
- unbind_line_account() 可軟刪除綁定
  </done>
</task>

</tasks>

<verification>
1. 停用並重新啟用外掛，檢查資料表是否自動建立
2. 執行 Task 2 的測試腳本，驗證綁定與查詢功能
3. 檢查 wp_options 中的 buygo_line_notify_db_version 是否為 1.0.0
4. 使用 phpMyAdmin 或 wp db query 檢查表結構和索引
</verification>

<success_criteria>
- [ ] wp_buygo_line_bindings 資料表已建立且結構正確
- [ ] Database::init() 在外掛啟動時自動執行
- [ ] LineUserService API 可正常綁定和查詢 LINE 帳號
- [ ] 綁定資料同時寫入 user_meta 和 bindings 表
- [ ] get_user_line_id() 優先從 user_meta 讀取（快取友好）
</success_criteria>

<output>
After completion, create `.planning/phases/01-基礎設施與設定/01-01-SUMMARY.md`
</output>
