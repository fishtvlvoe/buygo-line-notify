---
phase: 01-基礎設施與設定
plan: 03
type: execute
wave: 2
depends_on: ["01-02"]
files_modified:
  - includes/admin/class-settings-page.php
  - includes/class-plugin.php
autonomous: true

must_haves:
  truths:
    - "管理員在後台可看到 LINE 設定選單"
    - "如果 buygo-plus-one-dev 存在，選單掛在其子選單下"
    - "如果 buygo-plus-one-dev 不存在，顯示為獨立一級選單"
    - "選單偵測在 admin_menu hook 時執行（所有外掛已載入）"
  artifacts:
    - path: "includes/admin/class-settings-page.php"
      provides: "後台選單註冊與頁面渲染"
      exports: ["register_hooks", "add_admin_menu", "render_settings_page"]
      min_lines: 50
    - path: "includes/class-plugin.php"
      provides: "載入 SettingsPage 類別"
      contains: "include_once.*class-settings-page"
  key_links:
    - from: "includes/admin/class-settings-page.php"
      to: "admin_menu hook"
      via: "add_action registration"
      pattern: "add_action.*admin_menu"
    - from: "includes/admin/class-settings-page.php"
      to: "buygo-plus-one-dev"
      via: "class_exists detection"
      pattern: "class_exists.*BuyGoPlus"
---

<objective>
實作後台管理選單整合，根據父外掛（buygo-plus-one-dev）是否存在，動態決定選單位置。

Purpose: 提供統一的設定入口，與 buygo-plus-one-dev 整合時避免選單混亂，獨立運作時提供完整功能。
Output: SettingsPage class（選單註冊、條件式整合、空白設定頁面）。
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-基礎設施與設定/01-RESEARCH.md
@.planning/codebase/ARCHITECTURE.md
@.planning/phases/01-基礎設施與設定/01-02-SUMMARY.md

# 現有程式碼參考
@includes/class-plugin.php
@includes/admin/class-demo-page.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 SettingsPage 實作條件式選單整合</name>
  <files>includes/admin/class-settings-page.php</files>
  <action>
建立或更新 SettingsPage 類別，實作條件式選單掛載（參考 RESEARCH.md Pattern 3）。

**替換現有的 DemoPage：**
```php
namespace BuygoLineNotify\Admin;

class SettingsPage {

    /**
     * 註冊 WordPress hooks
     */
    public static function register_hooks(): void {
        add_action('admin_menu', [__CLASS__, 'add_admin_menu']);
    }

    /**
     * 根據父外掛是否存在，動態掛載選單
     * 在 admin_menu hook 執行時，所有外掛已載入（避免 Pitfall 3）
     */
    public static function add_admin_menu(): void {
        // 偵測 buygo-plus-one-dev 是否存在
        if (class_exists('BuyGoPlus\Plugin')) {
            // 父外掛存在：掛載為子選單
            add_submenu_page(
                'buygo-plus-one',              // 父選單 slug
                'LINE 串接通知',                // 頁面標題
                'LINE 通知',                   // 選單標題
                'manage_options',              // 權限
                'buygo-line-notify-settings',  // 選單 slug
                [__CLASS__, 'render_settings_page']
            );
        } else {
            // 父外掛不存在：建立獨立一級選單
            add_menu_page(
                'LINE 通知',                   // 頁面標題
                'LINE 通知',                   // 選單標題
                'manage_options',              // 權限
                'buygo-line-notify',           // 選單 slug
                [__CLASS__, 'render_settings_page'],
                'dashicons-format-chat',       // icon
                50                             // position
            );

            // 子選單：設定
            add_submenu_page(
                'buygo-line-notify',
                'LINE 設定',
                '設定',
                'manage_options',
                'buygo-line-notify-settings',
                [__CLASS__, 'render_settings_page']
            );
        }
    }

    /**
     * 渲染設定頁面（目前空白，Plan 01-04 實作）
     */
    public static function render_settings_page(): void {
        if (!current_user_can('manage_options')) {
            wp_die(__('您沒有權限訪問此頁面。', 'buygo-line-notify'));
        }

        ?>
        <div class="wrap">
            <h1>LINE 通知設定</h1>
            <p>設定頁面 UI 將在下一個 Plan 實作。</p>
            <p>目前選單位置：
                <?php echo class_exists('BuyGoPlus\Plugin') ? '子選單（buygo-plus-one 下）' : '獨立一級選單'; ?>
            </p>
        </div>
        <?php
    }
}
```

**更新 Plugin::loadDependencies() 和 onInit()：**

在 `includes/class-plugin.php` 中：

1. 更新 loadDependencies() 載入新檔案：
```php
if (\is_admin()) {
    include_once BuygoLineNotify_PLUGIN_DIR . 'includes/admin/class-settings-page.php';
}
```

2. 更新 onInit() 使用新類別：
```php
public function onInit(): void
{
    RetryDispatcher::register_hooks();

    if (\is_admin()) {
        \BuygoLineNotify\Admin\SettingsPage::register_hooks();
    }
}
```

3. 移除舊的 DemoPage import（如果存在）。

**重要：**
- 使用 `class_exists('BuyGoPlus\Plugin')` 而非 `is_plugin_active()`（避免載入 plugin.php）
- 在 `admin_menu` hook 執行時檢查，確保所有外掛已載入
- 兩種模式都指向相同的 `render_settings_page()` callback
  </action>
  <verify>
**測試方式 1：父外掛存在**
```bash
# 確認 buygo-plus-one-dev 已啟用
wp plugin list | grep buygo-plus-one

# 訪問後台選單
# 應該在「BuyGo +1」選單下看到「LINE 通知」子選單
```
訪問 https://test.buygo.me/wp-admin/，檢查左側選單。

**測試方式 2：父外掛不存在**
```bash
# 停用 buygo-plus-one-dev
wp plugin deactivate buygo-plus-one-dev --path=/Users/fishtv/Local\ Sites/buygo/app/public

# 刷新後台
# 應該看到獨立的「LINE 通知」一級選單（chat icon）
```

**測試方式 3：檢查選單 HTML**
```bash
# 檢查選單是否正確註冊
wp eval 'global $menu, $submenu; var_dump($menu); var_dump($submenu);'
```

點擊選單，應該看到空白設定頁面，顯示「設定頁面 UI 將在下一個 Plan 實作」。
  </verify>
  <done>
- SettingsPage class 存在於 includes/admin/class-settings-page.php
- Plugin::loadDependencies() 載入 SettingsPage
- Plugin::onInit() 呼叫 SettingsPage::register_hooks()
- 後台顯示正確的選單位置（子選單或一級選單）
- 點擊選單可看到空白設定頁面
- 舊的 DemoPage 已移除或註解
  </done>
</task>

</tasks>

<verification>
1. 在 buygo-plus-one-dev 啟用時，檢查 LINE 通知是否出現在其子選單下
2. 停用 buygo-plus-one-dev，檢查是否出現獨立一級選單
3. 點擊選單，確認可以訪問設定頁面（不會 404 或權限錯誤）
4. 使用 wp eval 檢查 $menu 和 $submenu 全域變數
</verification>

<success_criteria>
- [ ] 後台選單根據父外掛存在與否顯示不同位置
- [ ] 父外掛存在時：LINE 通知出現在 buygo-plus-one 子選單下
- [ ] 父外掛不存在時：LINE 通知顯示為獨立一級選單（dashicons-format-chat icon）
- [ ] 點擊選單可訪問設定頁面（空白頁面，顯示提示訊息）
- [ ] 舊的 DemoPage 已移除
</success_criteria>

<output>
After completion, create `.planning/phases/01-基礎設施與設定/01-03-SUMMARY.md`
</output>
