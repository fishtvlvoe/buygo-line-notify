---
phase: 01-基礎設施與設定
plan: 04
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - includes/admin/class-settings-page.php
  - includes/admin/views/settings-page.php
autonomous: false

must_haves:
  truths:
    - "管理員可在設定頁面看到所有 LINE API 設定欄位"
    - "Webhook URL 以唯讀方式顯示，附帶複製按鈕"
    - "表單提交後設定自動加密儲存"
    - "頁面載入時自動解密顯示設定值"
    - "表單有 nonce 驗證和權限檢查"
  artifacts:
    - path: "includes/admin/class-settings-page.php"
      provides: "表單處理與渲染邏輯"
      exports: ["render_settings_page", "handle_form_submission"]
      min_lines: 150
    - path: "includes/admin/views/settings-page.php"
      provides: "設定頁面 HTML 模板"
      min_lines: 200
  key_links:
    - from: "includes/admin/views/settings-page.php"
      to: "SettingsService"
      via: "表單提交時呼叫 set()"
      pattern: "SettingsService::set"
    - from: "includes/admin/views/settings-page.php"
      to: "WordPress REST API"
      via: "rest_url() 產生 Webhook URL"
      pattern: "rest_url.*webhook"
    - from: "includes/admin/class-settings-page.php"
      to: "WordPress Nonce"
      via: "wp_nonce_field and wp_verify_nonce"
      pattern: "wp_(verify_)?nonce"
---

<objective>
實作完整的設定頁面 UI，包含所有 LINE API 欄位、Webhook URL 顯示、表單驗證和儲存。

Purpose: 讓管理員可以輸入並儲存所有必要的 LINE API 金鑰，同時顯示 Webhook URL 方便複製到 LINE Developers Console。
Output: 完整的設定頁面（表單、驗證、儲存、複製按鈕）。
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-基礎設施與設定/01-RESEARCH.md
@.planning/codebase/ARCHITECTURE.md
@.planning/phases/01-基礎設施與設定/01-02-SUMMARY.md
@.planning/phases/01-基礎設施與設定/01-03-SUMMARY.md

# 參考 SettingsService API
@includes/services/class-settings-service.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 實作設定頁面表單處理邏輯</name>
  <files>includes/admin/class-settings-page.php</files>
  <action>
更新 SettingsPage::render_settings_page()，加入表單處理邏輯。

**更新內容：**
```php
namespace BuygoLineNotify\Admin;

use BuygoLineNotify\Services\SettingsService;

class SettingsPage {

    // ... 保留 register_hooks() 和 add_admin_menu() 方法 ...

    /**
     * 渲染設定頁面
     */
    public static function render_settings_page(): void {
        if (!current_user_can('manage_options')) {
            wp_die(__('您沒有權限訪問此頁面。', 'buygo-line-notify'));
        }

        // 處理表單提交
        $message = '';
        if (isset($_POST['buygo_line_settings_submit'])) {
            $message = self::handle_form_submission();
        }

        // 載入設定值
        $settings = SettingsService::get_all();

        // 產生 Webhook URL
        $webhook_url = rest_url('buygo-line-notify/v1/webhook');

        // 載入視圖檔案
        include BuygoLineNotify_PLUGIN_DIR . 'includes/admin/views/settings-page.php';
    }

    /**
     * 處理表單提交
     */
    private static function handle_form_submission(): string {
        // Nonce 驗證
        if (!isset($_POST['buygo_line_settings_nonce']) ||
            !wp_verify_nonce($_POST['buygo_line_settings_nonce'], 'buygo_line_settings_action')) {
            return '<div class="notice notice-error"><p>安全驗證失敗。</p></div>';
        }

        // 權限檢查
        if (!current_user_can('manage_options')) {
            return '<div class="notice notice-error"><p>您沒有權限修改設定。</p></div>';
        }

        // 儲存設定（SettingsService 會自動加密）
        $fields = [
            'channel_access_token',
            'channel_secret',
            'login_channel_id',
            'login_channel_secret',
            'liff_id',
            'liff_endpoint_url',
        ];

        foreach ($fields as $field) {
            $value = isset($_POST[$field]) ? sanitize_text_field($_POST[$field]) : '';
            SettingsService::set($field, $value);
        }

        return '<div class="notice notice-success"><p>設定已儲存。</p></div>';
    }
}
```

**重要：**
- 使用 `wp_verify_nonce()` 驗證表單（避免 CSRF）
- 使用 `sanitize_text_field()` 清理輸入（避免 XSS）
- SettingsService::set() 會自動加密敏感欄位
- SettingsService::get_all() 會自動解密讀取
  </action>
  <verify>
儲存後，訪問設定頁面，檢查：
```bash
# 訪問設定頁面
open https://test.buygo.me/wp-admin/admin.php?page=buygo-line-notify-settings
```

應該看到表單載入成功（即使尚未有 HTML，至少不會出現 PHP 錯誤）。
  </verify>
  <done>
- SettingsPage::render_settings_page() 包含表單處理邏輯
- handle_form_submission() 實作完成，包含 nonce 驗證
- 訪問設定頁面不會出現 PHP 錯誤
  </done>
</task>

<task type="auto">
  <name>Task 2: 建立設定頁面 HTML 模板</name>
  <files>includes/admin/views/settings-page.php</files>
  <action>
建立設定頁面 HTML 模板，包含所有欄位和 Webhook URL 複製功能。

**建立檔案（參考 RESEARCH.md Pattern 5）：**
```php
<?php
/**
 * 設定頁面模板
 *
 * Available variables:
 * @var array $settings - 設定值（已解密）
 * @var string $webhook_url - Webhook URL
 * @var string $message - 表單提交訊息
 */

if (!defined('ABSPATH')) {
    exit;
}
?>

<div class="wrap">
    <h1>LINE 通知設定</h1>

    <?php if (!empty($message)) echo $message; ?>

    <form method="post" action="">
        <?php wp_nonce_field('buygo_line_settings_action', 'buygo_line_settings_nonce'); ?>

        <table class="form-table" role="presentation">
            <tbody>
                <!-- Webhook URL（唯讀） -->
                <tr>
                    <th scope="row">
                        <label>Webhook URL</label>
                    </th>
                    <td>
                        <input type="text"
                               id="webhook-url"
                               value="<?php echo esc_url($webhook_url); ?>"
                               readonly
                               class="regular-text"
                               style="background-color: #f0f0f0;">
                        <button type="button"
                                class="button button-secondary"
                                onclick="copyWebhookUrl()">
                            複製
                        </button>
                        <p class="description">
                            請複製此 URL 到 <a href="https://developers.line.biz/console/" target="_blank">LINE Developers Console</a> 的 Webhook 設定
                        </p>
                    </td>
                </tr>

                <!-- Messaging API 設定 -->
                <tr>
                    <th scope="row">
                        <label for="channel_access_token">Channel Access Token</label>
                    </th>
                    <td>
                        <input type="text"
                               id="channel_access_token"
                               name="channel_access_token"
                               value="<?php echo esc_attr($settings['channel_access_token']); ?>"
                               class="regular-text">
                        <p class="description">LINE Messaging API 的 Channel Access Token（長期）</p>
                    </td>
                </tr>

                <tr>
                    <th scope="row">
                        <label for="channel_secret">Channel Secret</label>
                    </th>
                    <td>
                        <input type="text"
                               id="channel_secret"
                               name="channel_secret"
                               value="<?php echo esc_attr($settings['channel_secret']); ?>"
                               class="regular-text">
                        <p class="description">LINE Messaging API 的 Channel Secret（用於 Webhook 簽名驗證）</p>
                    </td>
                </tr>

                <!-- LINE Login 設定 -->
                <tr>
                    <th scope="row">
                        <label for="login_channel_id">LINE Login Channel ID</label>
                    </th>
                    <td>
                        <input type="text"
                               id="login_channel_id"
                               name="login_channel_id"
                               value="<?php echo esc_attr($settings['login_channel_id']); ?>"
                               class="regular-text">
                        <p class="description">LINE Login 的 Channel ID</p>
                    </td>
                </tr>

                <tr>
                    <th scope="row">
                        <label for="login_channel_secret">LINE Login Channel Secret</label>
                    </th>
                    <td>
                        <input type="text"
                               id="login_channel_secret"
                               name="login_channel_secret"
                               value="<?php echo esc_attr($settings['login_channel_secret']); ?>"
                               class="regular-text">
                        <p class="description">LINE Login 的 Channel Secret</p>
                    </td>
                </tr>

                <!-- LIFF 設定 -->
                <tr>
                    <th scope="row">
                        <label for="liff_id">LIFF ID</label>
                    </th>
                    <td>
                        <input type="text"
                               id="liff_id"
                               name="liff_id"
                               value="<?php echo esc_attr($settings['liff_id']); ?>"
                               class="regular-text"
                               placeholder="1234567890-abcdefgh">
                        <p class="description">LIFF App 的 ID（格式：1234567890-abcdefgh）</p>
                    </td>
                </tr>

                <tr>
                    <th scope="row">
                        <label for="liff_endpoint_url">LIFF Endpoint URL</label>
                    </th>
                    <td>
                        <input type="url"
                               id="liff_endpoint_url"
                               name="liff_endpoint_url"
                               value="<?php echo esc_attr($settings['liff_endpoint_url']); ?>"
                               class="regular-text"
                               placeholder="https://test.buygo.me/liff">
                        <p class="description">LIFF 頁面的 URL（用於 LINE 瀏覽器登入）</p>
                    </td>
                </tr>
            </tbody>
        </table>

        <?php submit_button('儲存設定', 'primary', 'buygo_line_settings_submit'); ?>
    </form>
</div>

<script>
function copyWebhookUrl() {
    const input = document.getElementById('webhook-url');
    input.select();
    input.setSelectionRange(0, 99999); // Mobile compatibility

    navigator.clipboard.writeText(input.value).then(() => {
        // 顯示成功提示
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = '已複製！';
        button.style.color = '#46b450';

        setTimeout(() => {
            button.textContent = originalText;
            button.style.color = '';
        }, 2000);
    }).catch(() => {
        // Fallback for older browsers
        alert('請手動複製 Webhook URL');
    });
}
</script>

<style>
.form-table th {
    width: 200px;
}
.form-table input[readonly] {
    cursor: not-allowed;
}
</style>
```

**建立目錄（如果不存在）：**
```bash
mkdir -p includes/admin/views
```
  </action>
  <verify>
無需執行命令，Task 3 的人工驗證會測試完整功能。
  </verify>
  <done>
- settings-page.php 檔案存在於 includes/admin/views/
- 包含所有 6 個設定欄位（SETTING-01~06）
- Webhook URL 以唯讀欄位顯示（ADMIN-05）
- 複製按鈕功能實作完成
- 表單包含 nonce 欄位
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
完整的 LINE 通知設定頁面，包含：
- 6 個設定欄位（Channel Access Token、Channel Secret、Login Channel ID、Login Channel Secret、LIFF ID、LIFF Endpoint URL）
- Webhook URL 唯讀顯示與複製功能
- 表單提交與儲存（自動加密敏感欄位）
- 向後相容（讀取舊外掛 buygo_core_settings）
  </what-built>
  <how-to-verify>
1. 訪問 https://test.buygo.me/wp-admin/

2. 檢查選單位置：
   - 如果 buygo-plus-one-dev 啟用：應該在「BuyGo +1」選單下看到「LINE 通知」
   - 如果 buygo-plus-one-dev 停用：應該看到獨立的「LINE 通知」一級選單

3. 點擊「LINE 通知」→「設定」，應該看到完整設定頁面

4. 測試 Webhook URL 複製：
   - 點擊「複製」按鈕
   - 按鈕文字應該變成「已複製！」並變綠色
   - 2 秒後恢復原樣

5. 測試表單儲存：
   - 輸入測試資料（任意字串）到各欄位
   - 點擊「儲存設定」
   - 應該看到「設定已儲存」綠色訊息
   - 重新整理頁面，欄位值應該保留

6. 驗證加密：
   ```bash
   wp option get buygo_line_channel_access_token --path=/Users/fishtv/Local\ Sites/buygo/app/public
   ```
   輸出應該是加密後的字串（不是原始輸入）

7. 測試向後相容：
   ```bash
   # 建立舊設定
   wp option set buygo_core_settings '{"channel_access_token":"old-token"}' --format=json --path=/Users/fishtv/Local\ Sites/buygo/app/public

   # 刪除新設定
   wp option delete buygo_line_channel_access_token --path=/Users/fishtv/Local\ Sites/buygo/app/public

   # 重新整理設定頁面，應該顯示 "old-token"
   ```

**預期結果：**
- 設定頁面顯示正確
- Webhook URL 可複製
- 表單可儲存且資料持久化
- 敏感欄位已加密
- 向後相容正常運作
  </how-to-verify>
  <resume-signal>
回覆 "approved" 表示驗證通過，或描述遇到的問題。
  </resume-signal>
</task>

</tasks>

<verification>
完整驗證流程由 Task 3 checkpoint 涵蓋。
</verification>

<success_criteria>
- [ ] 設定頁面包含所有 6 個設定欄位（SETTING-01~06）
- [ ] Webhook URL 以唯讀方式顯示（ADMIN-05）
- [ ] 複製按鈕功能正常
- [ ] 表單提交後設定已加密儲存（SETTING-07）
- [ ] 重新載入頁面時設定值正確顯示（自動解密）
- [ ] 向後相容：能讀取 buygo_core_settings（SETTING-08）
- [ ] 表單有 nonce 驗證和權限檢查
</success_criteria>

<output>
After completion, create `.planning/phases/01-基礎設施與設定/01-04-SUMMARY.md`
</output>
