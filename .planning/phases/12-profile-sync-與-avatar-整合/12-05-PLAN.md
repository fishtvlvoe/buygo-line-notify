---
phase: 12-profile-sync-與-avatar-整合
plan: 05
type: execute
wave: 3
depends_on: ["12-03", "12-04"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "SYNC-04: line_priority 策略在註冊/登入/綁定流程中正確覆蓋 WordPress 資料"
    - "SYNC-04: wordpress_priority 策略在登入/綁定流程中正確保留 WordPress 資料"
    - "SYNC-04: manual 策略在登入/綁定流程中正確記錄衝突而不更新資料"
    - "SYNC-04: 衝突日誌正確記錄到 wp_options"
    - "後台設定變更後，衝突策略立即生效"
  artifacts: []
  key_links:
    - from: "SettingsService::get_conflict_strategy()"
      to: "ProfileSyncService::shouldUpdateField()"
      via: "設定讀取"
      pattern: "conflict_strategy"
    - from: "ProfileSyncService::logConflict()"
      to: "wp_options"
      via: "衝突日誌記錄"
      pattern: "buygo_line_conflict_log_"
---

<objective>
整合驗證 SYNC-04 衝突處理策略在實際流程中的運作

Purpose: 確保三種衝突策略（line_priority/wordpress_priority/manual）在註冊/登入/綁定流程中正確運作，完成 SYNC-04 需求的測試覆蓋
Output: 驗證報告（無程式碼變更）
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-profile-sync-與-avatar-整合/12-01-PLAN.md
@.planning/phases/12-profile-sync-與-avatar-整合/12-03-PLAN.md
@.planning/phases/12-profile-sync-與-avatar-整合/12-04-PLAN.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>驗證 line_priority 策略</name>
  <what-built>
衝突策略設為 "LINE 優先" 時的 Profile Sync 行為
  </what-built>
  <how-to-verify>
**測試環境準備：**
1. 登入 WordPress 後台
2. 前往「LINE 串接通知」→「設定」
3. 確認「衝突處理策略」設為「LINE 優先」
4. 確認「登入時更新 Profile」已勾選

**測試案例 1：註冊時同步（新用戶）**
1. 使用尚未綁定的 LINE 帳號進行 LINE Login
2. 選擇「建立新帳號」
3. 驗證：新建用戶的 display_name 和 user_email 應來自 LINE profile

**測試案例 2：登入時同步（既有用戶）**
1. 先在 WordPress 後台修改該用戶的 display_name（例如改成「測試名稱」）
2. 使用該用戶的 LINE 帳號登入
3. 驗證：用戶的 display_name 應被 LINE profile 覆蓋（因為 LINE 優先）

**測試案例 3：綁定時同步**
1. 使用 WordPress 帳號登入
2. 進行 LINE 綁定
3. 若 WordPress 帳號的 display_name 與 LINE profile 不同，驗證：應被 LINE profile 覆蓋
  </how-to-verify>
  <resume-signal>
回報驗證結果：
- 若全部通過：輸入「line_priority 驗證通過」
- 若有問題：描述具體問題和錯誤訊息
  </resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>驗證 wordpress_priority 策略</name>
  <what-built>
衝突策略設為 "WordPress 優先" 時的 Profile Sync 行為
  </what-built>
  <how-to-verify>
**測試環境準備：**
1. 前往後台「LINE 串接通知」→「設定」
2. 將「衝突處理策略」改為「WordPress 優先」
3. 確認「登入時更新 Profile」已勾選

**測試案例 1：登入時保留現有資料**
1. 先在 WordPress 後台修改該用戶的 display_name（例如改成「保留名稱」）
2. 使用該用戶的 LINE 帳號登入
3. 驗證：用戶的 display_name 應保持「保留名稱」（因為 WordPress 優先）

**測試案例 2：空白欄位仍會更新**
1. 將某用戶的 display_name 清空
2. 使用該用戶的 LINE 帳號登入
3. 驗證：空白的 display_name 應被 LINE profile 填入（空白時會更新）

**測試案例 3：綁定時保留現有資料**
1. 使用 WordPress 帳號登入（該帳號有自訂 display_name）
2. 進行 LINE 綁定
3. 驗證：display_name 應保持不變
  </how-to-verify>
  <resume-signal>
回報驗證結果：
- 若全部通過：輸入「wordpress_priority 驗證通過」
- 若有問題：描述具體問題和錯誤訊息
  </resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>驗證 manual 策略和衝突日誌</name>
  <what-built>
衝突策略設為 "手動處理" 時的 Profile Sync 行為和衝突日誌記錄
  </what-built>
  <how-to-verify>
**測試環境準備：**
1. 前往後台「LINE 串接通知」→「設定」
2. 將「衝突處理策略」改為「手動處理」
3. 確認「登入時更新 Profile」已勾選

**測試案例 1：登入時不更新但記錄衝突**
1. 先在 WordPress 後台修改某用戶的 display_name（例如改成「手動測試」）
2. 使用該用戶的 LINE 帳號登入（LINE profile 的 displayName 不同）
3. 驗證：
   - display_name 應保持「手動測試」（不自動更新）
   - 衝突應被記錄到 wp_options

**測試案例 2：檢查衝突日誌**
1. 查看 wp_options 表中的 `buygo_line_conflict_log_{user_id}` 記錄
2. 驗證日誌包含：timestamp, field, current_value, new_value

**驗證衝突日誌（使用 WP-CLI 或 phpMyAdmin）：**
```bash
wp option get buygo_line_conflict_log_{user_id} --format=json
```
或在 phpMyAdmin 中查詢：
```sql
SELECT option_value FROM wp_options WHERE option_name LIKE 'buygo_line_conflict_log_%';
```
  </how-to-verify>
  <resume-signal>
回報驗證結果：
- 若全部通過：輸入「manual 驗證通過」並附上衝突日誌截圖或內容
- 若有問題：描述具體問題和錯誤訊息
  </resume-signal>
</task>

</tasks>

<verification>
**Phase 12 Plan 05 驗證：**

所有三種衝突策略驗證通過即完成：
1. line_priority 驗證通過
2. wordpress_priority 驗證通過
3. manual 驗證通過（含衝突日誌確認）

**SYNC-04 完整測試覆蓋確認：**
- 註冊流程：line_priority（強制同步，無衝突）
- 登入流程：三種策略各自正確運作
- 綁定流程：三種策略各自正確運作
- 衝突日誌：manual 策略正確記錄
</verification>

<success_criteria>
1. line_priority 策略在註冊/登入/綁定流程中正確覆蓋 WordPress 資料
2. wordpress_priority 策略在登入/綁定流程中正確保留 WordPress 資料（空白欄位除外）
3. manual 策略在登入/綁定流程中正確記錄衝突而不更新資料
4. 衝突日誌正確記錄到 wp_options
5. 後台設定變更後，衝突策略立即生效
</success_criteria>

<output>
After completion, create `.planning/phases/12-profile-sync-與-avatar-整合/12-05-SUMMARY.md`

SUMMARY 應包含：
- 三種策略的驗證結果
- 衝突日誌範例
- 任何發現的問題和修正（若有）
</output>
