---
phase: 12-profile-sync-與-avatar-整合
plan: 04
type: execute
wave: 2
depends_on: ["12-01", "12-02"]
files_modified:
  - includes/admin/views/settings-page.php
  - includes/admin/class-settings-page.php
autonomous: true

must_haves:
  truths:
    - "後台設定頁面顯示「登入時更新 Profile」checkbox"
    - "後台設定頁面顯示「衝突處理策略」radio buttons (3 個選項)"
    - "後台設定頁面顯示「清除頭像快取」按鈕"
    - "設定值正確儲存到 wp_options"
    - "清除快取 AJAX 請求正確處理並返回清除數量"
  artifacts:
    - path: "includes/admin/views/settings-page.php"
      provides: "Profile Sync 設定 UI"
      contains: "sync_on_login"
    - path: "includes/admin/class-settings-page.php"
      provides: "AJAX handler 處理清除快取請求"
      contains: "ajax_clear_avatar_cache"
  key_links:
    - from: "settings-page.php"
      to: "SettingsService::set()"
      via: "表單提交"
      pattern: "buygo_line_sync_on_login"
    - from: "settings-page.php"
      to: "class-settings-page.php::ajax_clear_avatar_cache()"
      via: "AJAX 請求"
      pattern: "wp_ajax_buygo_line_clear_avatar_cache"
---

<objective>
實作 Profile Sync 後台設定頁面

Purpose: 讓管理員可以設定 sync_on_login (登入時更新 Profile) 和 conflict_strategy (衝突處理策略)
Output: 修改 includes/admin/views/settings-page.php 和 includes/admin/class-settings-page.php
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-profile-sync-與-avatar-整合/12-RESEARCH.md
@includes/admin/views/settings-page.php
@includes/admin/class-settings-page.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 新增 Profile Sync 設定區塊到設定頁面</name>
  <files>includes/admin/views/settings-page.php</files>
  <action>
**預先驗證：** 確認檔案存在於 `includes/admin/views/settings-page.php`

修改 `includes/admin/views/settings-page.php`，新增 Profile Sync 設定區塊：

**1. 在現有設定區塊之後（例如 LINE Login 設定之後），新增 Profile Sync 區塊：**

```php
<!-- Profile Sync 設定 -->
<h2>Profile 同步設定</h2>
<table class="form-table">
    <tr>
        <th scope="row">
            <label for="buygo_line_sync_on_login">登入時更新 Profile</label>
        </th>
        <td>
            <label>
                <input type="checkbox" name="buygo_line_sync_on_login" id="buygo_line_sync_on_login"
                    value="1" <?php checked(\BuygoLineNotify\Services\SettingsService::get('sync_on_login', false)); ?>>
                啟用登入時自動同步 Profile
            </label>
            <p class="description">
                從 LINE 同步最新的名稱、Email、頭像。<br>
                <strong>注意：</strong>可能覆蓋用戶手動修改的資料，建議僅在初期使用。
            </p>
        </td>
    </tr>
    <tr>
        <th scope="row">
            <label>衝突處理策略</label>
        </th>
        <td>
            <?php $conflict_strategy = \BuygoLineNotify\Services\SettingsService::get('conflict_strategy', 'line_priority'); ?>
            <fieldset>
                <legend class="screen-reader-text"><span>衝突處理策略</span></legend>

                <label>
                    <input type="radio" name="buygo_line_conflict_strategy" value="line_priority"
                        <?php checked($conflict_strategy, 'line_priority'); ?>>
                    <strong>LINE 優先</strong> — LINE profile 覆蓋 WordPress 資料
                </label>
                <br>

                <label>
                    <input type="radio" name="buygo_line_conflict_strategy" value="wordpress_priority"
                        <?php checked($conflict_strategy, 'wordpress_priority'); ?>>
                    <strong>WordPress 優先</strong> — 保留 WordPress 現有資料，只寫入空白欄位
                </label>
                <br>

                <label>
                    <input type="radio" name="buygo_line_conflict_strategy" value="manual"
                        <?php checked($conflict_strategy, 'manual'); ?>>
                    <strong>手動處理</strong> — 不自動同步，記錄差異讓管理員決定
                </label>

                <p class="description">
                    當 LINE profile 與 WordPress 用戶資料不一致時的處理方式。<br>
                    預設「LINE 優先」適合大多數情況，「手動處理」適合需要審核用戶資料變更的場景。
                </p>
            </fieldset>
        </td>
    </tr>
    <tr>
        <th scope="row">清除頭像快取</th>
        <td>
            <button type="button" class="button" id="buygo-clear-avatar-cache">
                清除所有用戶的 LINE 頭像快取
            </button>
            <span id="buygo-clear-cache-result" style="margin-left: 10px;"></span>
            <p class="description">
                清除後，下次顯示頭像時會使用快取（若未過期）或等待下次登入更新。
            </p>
        </td>
    </tr>
</table>
```

**2. 在表單提交處理邏輯中，新增 Profile Sync 設定的儲存：**

找到表單提交處理的地方（通常在 `if ($_SERVER['REQUEST_METHOD'] === 'POST')` 區塊），新增：
```php
// 儲存 Profile Sync 設定
\BuygoLineNotify\Services\SettingsService::set('sync_on_login', isset($_POST['buygo_line_sync_on_login']) ? '1' : '');
\BuygoLineNotify\Services\SettingsService::set('conflict_strategy', sanitize_text_field($_POST['buygo_line_conflict_strategy'] ?? 'line_priority'));
```

**3. 在頁面底部（</form> 之後）新增清除快取按鈕的 JavaScript：**

```php
<script>
jQuery(document).ready(function($) {
    $('#buygo-clear-avatar-cache').on('click', function() {
        var $button = $(this);
        var $result = $('#buygo-clear-cache-result');

        $button.prop('disabled', true).text('清除中...');
        $result.text('');

        $.post(ajaxurl, {
            action: 'buygo_line_clear_avatar_cache',
            nonce: '<?php echo wp_create_nonce('buygo_line_clear_avatar_cache'); ?>'
        }, function(response) {
            if (response.success) {
                $result.html('<span style="color: green;">已清除 ' + response.data.count + ' 個用戶的頭像快取</span>');
            } else {
                $result.html('<span style="color: red;">清除失敗：' + (response.data.message || '未知錯誤') + '</span>');
            }
            $button.prop('disabled', false).text('清除所有用戶的 LINE 頭像快取');
        }).fail(function() {
            $result.html('<span style="color: red;">請求失敗，請重試</span>');
            $button.prop('disabled', false).text('清除所有用戶的 LINE 頭像快取');
        });
    });
});
</script>
```

**注意事項：**
- 使用 checked() WordPress 函數來處理 checkbox 和 radio 的選中狀態
- sync_on_login 儲存為 '1' 或 ''（空字串代表 false）
- conflict_strategy 必須驗證是否為有效值
- 清除快取按鈕使用 AJAX，不需要表單提交
  </action>
  <verify>
```bash
# 驗證檔案存在
ls -la includes/admin/views/settings-page.php

# 驗證 UI 元素
grep -n "sync_on_login" includes/admin/views/settings-page.php
grep -n "conflict_strategy" includes/admin/views/settings-page.php
grep -n "buygo-clear-avatar-cache" includes/admin/views/settings-page.php
```
預期：檔案存在，三個 grep 都有輸出
  </verify>
  <done>
Profile Sync 設定 UI 已新增到設定頁面，包含 sync_on_login checkbox、conflict_strategy radio、清除快取按鈕
  </done>
</task>

<task type="auto">
  <name>Task 2: 新增 AJAX handler 處理清除快取請求</name>
  <files>includes/admin/class-settings-page.php</files>
  <action>
**預先驗證：** 確認檔案存在於 `includes/admin/class-settings-page.php`（已確認存在）

修改 `includes/admin/class-settings-page.php`，新增 AJAX handler：

**1. 在 __construct() 或 init() 方法中註冊 AJAX action：**

找到類別的建構函式或初始化方法，新增：
```php
add_action('wp_ajax_buygo_line_clear_avatar_cache', [$this, 'ajax_clear_avatar_cache']);
```

若類別使用靜態方法，則改為：
```php
add_action('wp_ajax_buygo_line_clear_avatar_cache', [__CLASS__, 'ajax_clear_avatar_cache']);
```

**2. 新增 ajax_clear_avatar_cache() 方法：**

```php
/**
 * AJAX: 清除所有用戶的頭像快取
 */
public function ajax_clear_avatar_cache() {
    // 驗證 nonce
    check_ajax_referer('buygo_line_clear_avatar_cache', 'nonce');

    // 驗證權限
    if (!current_user_can('manage_options')) {
        wp_send_json_error(['message' => '權限不足']);
    }

    // 清除快取
    $count = \BuygoLineNotify\Services\AvatarService::clearAllAvatarCache();

    wp_send_json_success(['count' => $count]);
}
```

若類別使用靜態方法，則宣告為：
```php
public static function ajax_clear_avatar_cache() { ... }
```

**3. 確保 AJAX action 在 admin_init 或更早註冊：**

若目前的 hook 註冊時機太晚（例如在 admin_menu），需要將 AJAX handler 移到更早的 hook：
```php
// 在類別載入時註冊，而不是在 admin_menu 時
add_action('admin_init', function() {
    add_action('wp_ajax_buygo_line_clear_avatar_cache', [SettingsPage::class, 'ajax_clear_avatar_cache']);
});
```

**注意事項：**
- 使用 check_ajax_referer() 驗證 nonce
- 使用 current_user_can('manage_options') 驗證權限
- 使用 wp_send_json_success() 和 wp_send_json_error() 返回結果
- 呼叫 AvatarService::clearAllAvatarCache() 執行清除（Plan 12-02 已建立此方法）
  </action>
  <verify>
```bash
# 驗證檔案存在
ls -la includes/admin/class-settings-page.php

# 驗證 AJAX handler
grep -n "ajax_clear_avatar_cache" includes/admin/class-settings-page.php
grep -n "wp_ajax_buygo_line_clear_avatar_cache" includes/admin/class-settings-page.php
grep -n "wp_send_json_success" includes/admin/class-settings-page.php
```
預期：檔案存在，三個 grep 都有輸出
  </verify>
  <done>
AJAX handler 已新增，可處理清除頭像快取請求，返回清除數量
  </done>
</task>

</tasks>

<verification>
**Phase 12 Plan 04 驗證：**

1. 設定頁面包含 Profile Sync 設定區塊
2. AJAX handler 已註冊且正確處理請求
3. 程式碼語法正確無 PHP errors

```bash
# 驗證檔案存在
ls -la includes/admin/views/settings-page.php
ls -la includes/admin/class-settings-page.php

# 檢查設定頁面 UI
grep -c "sync_on_login\|conflict_strategy\|clear-avatar-cache" includes/admin/views/settings-page.php

# 檢查 AJAX handler
grep -B2 -A10 "ajax_clear_avatar_cache" includes/admin/class-settings-page.php

# PHP 語法檢查
php -l includes/admin/views/settings-page.php
php -l includes/admin/class-settings-page.php
```
</verification>

<success_criteria>
1. 後台設定頁面顯示「登入時更新 Profile」checkbox
2. 後台設定頁面顯示「衝突處理策略」radio buttons (3 個選項)
3. 後台設定頁面顯示「清除頭像快取」按鈕
4. 設定值正確儲存到 wp_options
5. 清除快取 AJAX 請求正確處理並返回清除數量
</success_criteria>

<output>
After completion, create `.planning/phases/12-profile-sync-與-avatar-整合/12-04-SUMMARY.md`
</output>
