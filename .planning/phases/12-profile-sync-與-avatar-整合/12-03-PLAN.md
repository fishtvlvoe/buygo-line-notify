---
phase: 12-profile-sync-與-avatar-整合
plan: 03
type: execute
wave: 2
depends_on: ["12-01", "12-02"]
files_modified:
  - includes/services/class-user-service.php
  - includes/handlers/class-login-handler.php
  - includes/services/class-profile-sync-service.php
autonomous: true

must_haves:
  truths:
    - "create_user_from_line() 呼叫 ProfileSyncService::syncProfile('register')"
    - "perform_login() 呼叫 ProfileSyncService::syncProfile('login')"
    - "handle_link_submission() 呼叫 ProfileSyncService::syncProfile('link')"
    - "所有流程正確觸發 Profile Sync"
  artifacts:
    - path: "includes/services/class-user-service.php"
      provides: "UserService 整合 ProfileSyncService"
      contains: "ProfileSyncService::syncProfile"
    - path: "includes/handlers/class-login-handler.php"
      provides: "Login_Handler 整合 ProfileSyncService"
      contains: "ProfileSyncService::syncProfile"
  key_links:
    - from: "UserService::create_user_from_line()"
      to: "ProfileSyncService::syncProfile()"
      via: "註冊流程"
      pattern: "syncProfile.*register"
    - from: "Login_Handler::perform_login()"
      to: "ProfileSyncService::syncProfile()"
      via: "登入流程"
      pattern: "syncProfile.*login"
    - from: "Login_Handler::handle_link_submission()"
      to: "ProfileSyncService::syncProfile()"
      via: "綁定流程"
      pattern: "syncProfile.*link"
---

<objective>
整合 ProfileSyncService 到現有的用戶建立、登入、綁定流程

Purpose: 確保 Profile Sync 在正確的時機點觸發，完成 SYNC-01 (註冊時同步)、SYNC-02 (登入時同步)、SYNC-03 (綁定時同步) 需求
Output: 修改 UserService 和 Login_Handler
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-profile-sync-與-avatar-整合/12-01-PLAN.md
@.planning/phases/11-完整註冊-登入-綁定流程/11-01-SUMMARY.md
@includes/services/class-user-service.php
@includes/handlers/class-login-handler.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 整合 ProfileSyncService 到 UserService</name>
  <files>includes/services/class-user-service.php</files>
  <action>
修改 `includes/services/class-user-service.php`，在用戶建立和綁定時呼叫 ProfileSyncService：

**1. 在 create_user_from_line() 方法中整合（約第 95 行之後，wp_update_user 之後）：**

找到這段程式碼：
```php
// 儲存 profile picture
if (!empty($profile['pictureUrl'])) {
    update_user_meta($user_id, 'line_picture_url', sanitize_url($profile['pictureUrl']));
}
```

在其之後新增：
```php
// Profile Sync（註冊時強制同步）
ProfileSyncService::syncProfile($user_id, [
    'displayName' => $profile['displayName'] ?? '',
    'email'       => $profile['email'] ?? '',
    'pictureUrl'  => $profile['pictureUrl'] ?? '',
], 'register');
```

**2. 在 bind_line_to_user() 方法中整合（約第 163 行之後，儲存 profile 之後）：**

找到這段程式碼：
```php
// 儲存額外資料
if (!empty($profile['displayName'])) {
    update_user_meta($user_id, 'line_display_name', sanitize_text_field($profile['displayName']));
}
if (!empty($profile['pictureUrl'])) {
    update_user_meta($user_id, 'line_picture_url', sanitize_url($profile['pictureUrl']));
}
```

在其之後新增：
```php
// Profile Sync（綁定時依策略同步）
ProfileSyncService::syncProfile($user_id, [
    'displayName' => $profile['displayName'] ?? '',
    'email'       => $profile['email'] ?? '',
    'pictureUrl'  => $profile['pictureUrl'] ?? '',
], 'link');
```

**注意事項：**
- create_user_from_line() 使用 'register' action（強制同步）
- bind_line_to_user() 使用 'link' action（依衝突策略同步）
- 確保 ProfileSyncService 類別已在檔案頂部正確 use 或使用完整命名空間
  </action>
  <verify>
```bash
grep -n "ProfileSyncService::syncProfile" includes/services/class-user-service.php
grep -n "'register'" includes/services/class-user-service.php
grep -n "'link'" includes/services/class-user-service.php
```
預期：三個 grep 都有輸出，顯示 syncProfile 被呼叫且使用正確的 action
  </verify>
  <done>
UserService 已整合 ProfileSyncService，create_user_from_line() 使用 'register'，bind_line_to_user() 使用 'link'
  </done>
</task>

<task type="auto">
  <name>Task 2: 整合 ProfileSyncService 到 Login_Handler</name>
  <files>includes/handlers/class-login-handler.php</files>
  <action>
修改 `includes/handlers/class-login-handler.php`，在登入和綁定時呼叫 ProfileSyncService：

**1. 在 perform_login() 方法中整合（在 wp_set_auth_cookie 之後）：**

找到 perform_login() 方法中的 wp_set_auth_cookie() 呼叫（或 wp_set_current_user），在其之後新增：
```php
// Profile Sync（登入時，依設定決定是否同步）
$line_profile = $state_data['line_profile'] ?? [];
if (!empty($line_profile)) {
    Services\ProfileSyncService::syncProfile($user_id, [
        'displayName' => $line_profile['displayName'] ?? '',
        'email'       => $line_profile['email'] ?? '',
        'pictureUrl'  => $line_profile['pictureUrl'] ?? '',
    ], 'login');
}
```

**2. 在 handle_link_submission() 方法中整合（在綁定成功後，觸發 hook 之前）：**

找到 handle_link_submission() 方法中的 `LineUserService::linkUser()` 成功之後、`do_action('buygo_line_after_link')` 之前，新增：
```php
// Profile Sync（綁定時依策略同步）
Services\ProfileSyncService::syncProfile($user_id, [
    'displayName' => $profile['displayName'] ?? '',
    'email'       => $profile['email'] ?? '',
    'pictureUrl'  => $profile['pictureUrl'] ?? '',
], 'link');
```

**3. 確保 ProfileSyncService 載入：**
在檔案頂部的 use 區塊（如果有）或 namespace 之後，確保可以存取 ProfileSyncService 類別。由於已經在 Plugin 中載入，使用完整命名空間即可：`Services\ProfileSyncService::syncProfile()`

**注意事項：**
- perform_login() 使用 'login' action（依 sync_on_login 設定決定是否同步）
- handle_link_submission() 使用 'link' action（依衝突策略同步）
- 從 state_data 或 profile 變數取得 LINE profile 資料
- 確保 ProfileSyncService 在呼叫時類別已存在（在 Plugin loadDependencies 中載入）
  </action>
  <verify>
```bash
grep -n "ProfileSyncService::syncProfile" includes/handlers/class-login-handler.php
grep -n "'login'" includes/handlers/class-login-handler.php
grep -c "syncProfile" includes/handlers/class-login-handler.php
```
預期：第一個 grep 有輸出，第三個 grep 顯示至少 2 次呼叫（perform_login 和 handle_link_submission）
  </verify>
  <done>
Login_Handler 已整合 ProfileSyncService，perform_login() 使用 'login'，handle_link_submission() 使用 'link'
  </done>
</task>

<task type="auto">
  <name>Task 3: 在 Plugin 中載入 ProfileSyncService</name>
  <files>includes/class-plugin.php</files>
  <action>
修改 `includes/class-plugin.php`，確保 ProfileSyncService 被載入：

**1. 在 loadDependencies() 方法中載入 ProfileSyncService：**

在 services 區塊（例如在 class-settings-service.php 載入之後）新增：
```php
require_once BUYGO_LINE_NOTIFY_PATH . 'includes/services/class-profile-sync-service.php';
```

**順序要求：**
- ProfileSyncService 應在 SettingsService 之後載入（因為依賴 SettingsService::get()）
- ProfileSyncService 應在 Login_Handler 之前載入（因為 Login_Handler 會呼叫它）

**注意事項：**
- 確保載入順序正確
- ProfileSyncService 是靜態類別，不需要實例化
  </action>
  <verify>
```bash
grep -n "class-profile-sync-service.php" includes/class-plugin.php
```
預期：grep 有輸出，顯示 ProfileSyncService 被載入
  </verify>
  <done>
ProfileSyncService 已在 Plugin 中載入，順序正確
  </done>
</task>

</tasks>

<verification>
**Phase 12 Plan 03 驗證：**

1. UserService 整合 ProfileSyncService
2. Login_Handler 整合 ProfileSyncService
3. ProfileSyncService 在 Plugin 中正確載入
4. 程式碼語法正確無 PHP errors

```bash
# 檢查 UserService 整合
grep -B2 -A5 "ProfileSyncService" includes/services/class-user-service.php

# 檢查 Login_Handler 整合
grep -B2 -A5 "ProfileSyncService" includes/handlers/class-login-handler.php

# 檢查 Plugin 載入順序
grep -n "class-.*-service.php\|class-login-handler.php\|class-profile-sync-service.php" includes/class-plugin.php | head -20

# PHP 語法檢查
php -l includes/services/class-user-service.php
php -l includes/handlers/class-login-handler.php
php -l includes/class-plugin.php
```
</verification>

<success_criteria>
1. create_user_from_line() 正確呼叫 ProfileSyncService::syncProfile('register')
2. perform_login() 正確呼叫 ProfileSyncService::syncProfile('login')
3. handle_link_submission() 正確呼叫 ProfileSyncService::syncProfile('link')
4. 所有程式碼語法正確，無 PHP errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-profile-sync-與-avatar-整合/12-03-SUMMARY.md`
</output>
