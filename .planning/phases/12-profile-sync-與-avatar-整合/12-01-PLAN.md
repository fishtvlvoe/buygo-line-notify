---
phase: 12-profile-sync-與-avatar-整合
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/services/class-profile-sync-service.php
  - includes/class-plugin.php
autonomous: true

must_haves:
  truths:
    - "ProfileSyncService::syncProfile() 可同步 LINE profile 到 WordPress 用戶"
    - "shouldUpdateField() 正確區分 register/login/link 場景"
    - "衝突策略 (line_priority/wordpress_priority/manual) 正確運作"
    - "同步日誌記錄到 wp_options，最多保留 10 筆"
  artifacts:
    - path: "includes/services/class-profile-sync-service.php"
      provides: "Profile Sync 核心邏輯"
      exports: ["syncProfile", "shouldUpdateField", "logSync", "logConflict", "getSyncLog"]
  key_links:
    - from: "ProfileSyncService::syncProfile()"
      to: "wp_update_user()"
      via: "WordPress Core API"
      pattern: "wp_update_user.*ID.*display_name"
    - from: "ProfileSyncService::logSync()"
      to: "wp_options"
      via: "update_option()"
      pattern: "buygo_line_sync_log_"
    - from: "Plugin::loadDependencies()"
      to: "ProfileSyncService"
      via: "require_once"
      pattern: "class-profile-sync-service\\.php"
---

<objective>
建立 ProfileSyncService 服務類別，實作 LINE profile 同步到 WordPress 用戶的核心邏輯

Purpose: 提供統一的 Profile Sync 方法，處理註冊/登入/綁定三種場景的 profile 同步，包含衝突處理策略和同步日誌記錄
Output: includes/services/class-profile-sync-service.php
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-profile-sync-與-avatar-整合/12-RESEARCH.md
@includes/services/class-settings-service.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 ProfileSyncService 類別</name>
  <files>includes/services/class-profile-sync-service.php</files>
  <action>
建立 `includes/services/class-profile-sync-service.php` 檔案，實作以下功能：

**1. 類別結構：**
```php
namespace BuygoLineNotify\Services;

class ProfileSyncService {
    public static function syncProfile(int $user_id, array $line_profile, string $action): bool|\WP_Error
    private static function shouldUpdateField(string $field, $current_value, $new_value, string $strategy, string $action): bool
    private static function logSync(int $user_id, string $action, array $changed_fields, array $old_values, array $line_profile): void
    private static function logConflict(int $user_id, string $field, $current_value, $new_value): void
    public static function getSyncLog(int $user_id): array
    public static function clearSyncLog(int $user_id): bool
}
```

**2. syncProfile() 方法：**
- 參數：$user_id (int), $line_profile (array: displayName, email, pictureUrl), $action (string: register/login/link)
- 取得用戶現有資料 (get_user_by('id'))
- 取得衝突策略 (SettingsService::get('conflict_strategy', 'line_priority'))
- 記錄變更前的值 (display_name, user_email, avatar_url)
- 處理 display_name：呼叫 shouldUpdateField() 判斷是否更新
- 處理 user_email：呼叫 shouldUpdateField() + email_exists() 檢查重複
- 使用 wp_update_user() 更新用戶資料
- 處理頭像：update_user_meta('buygo_line_avatar_url'), update_user_meta('buygo_line_avatar_updated', current_time('mysql'))
- 呼叫 logSync() 記錄日誌
- 返回 true 或 WP_Error

**3. shouldUpdateField() 方法：**
- register 動作：強制同步（無視衝突策略），只要有新值就更新
- login 動作：檢查 SettingsService::get('sync_on_login', false)，若未啟用則返回 false
- 若當前值為空，始終更新
- 若當前值與新值相同，跳過
- 依據 conflict_strategy 決定：
  - 'line_priority'：有新值就覆蓋
  - 'wordpress_priority'：保留現有值（返回 false）
  - 'manual'：呼叫 logConflict() 記錄差異，返回 false

**4. logSync() 方法：**
- 日誌 key: `buygo_line_sync_log_{user_id}`
- 格式：JSON array，新增一筆記錄
- 記錄內容：timestamp, action, changed_fields, old_values, new_values
- 保留最近 10 筆 (array_slice($logs, -10))
- 使用 update_option($log_key, $logs, false) - autoload=false

**5. logConflict() 方法：**
- 衝突日誌 key: `buygo_line_conflict_log_{user_id}`
- 記錄：timestamp, field, current_value, new_value
- 保留最近 10 筆

**6. getSyncLog() 和 clearSyncLog() 方法：**
- getSyncLog($user_id): 讀取 `buygo_line_sync_log_{user_id}`，返回 array
- clearSyncLog($user_id): 刪除 `buygo_line_sync_log_{user_id}` 和 `buygo_line_conflict_log_{user_id}`

**注意事項：**
- Email 更新前必須檢查 email_exists()，若已被其他用戶使用則跳過
- 使用 sanitize_text_field() 清理 displayName
- 使用 sanitize_email() 清理 email
- 使用 esc_url_raw() 清理 pictureUrl
  </action>
  <verify>
檔案結構驗證：
```bash
grep -n "class ProfileSyncService" includes/services/class-profile-sync-service.php
grep -n "public static function syncProfile" includes/services/class-profile-sync-service.php
grep -n "private static function shouldUpdateField" includes/services/class-profile-sync-service.php
grep -n "private static function logSync" includes/services/class-profile-sync-service.php
```
預期：四個 grep 都有輸出
  </verify>
  <done>
ProfileSyncService 類別已建立，包含 syncProfile()、shouldUpdateField()、logSync()、logConflict()、getSyncLog()、clearSyncLog() 方法
  </done>
</task>

<task type="auto">
  <name>Task 2: 擴展 SettingsService 支援 Profile Sync 設定</name>
  <files>includes/services/class-settings-service.php</files>
  <action>
修改 `includes/services/class-settings-service.php`，新增 Profile Sync 相關設定支援：

**1. 在 get_all() 方法中新增 keys：**
```php
$keys = [
    // ... 現有的 keys ...
    'sync_on_login',       // 新增：登入時是否同步 profile
    'conflict_strategy',   // 新增：衝突處理策略
];
```

**2. 新增 helper 方法：**
```php
/**
 * 取得是否在登入時同步 Profile
 *
 * @return bool
 */
public static function get_sync_on_login(): bool
{
    return (bool) self::get('sync_on_login', false);
}

/**
 * 取得衝突處理策略
 *
 * @return string 'line_priority' | 'wordpress_priority' | 'manual'
 */
public static function get_conflict_strategy(): string
{
    $strategy = self::get('conflict_strategy', 'line_priority');
    $valid = ['line_priority', 'wordpress_priority', 'manual'];
    return in_array($strategy, $valid, true) ? $strategy : 'line_priority';
}
```

**注意事項：**
- sync_on_login 預設為 false（保守策略，避免覆蓋用戶手動修改的資料）
- conflict_strategy 預設為 'line_priority'（LINE 優先）
- 驗證 conflict_strategy 的值，若不在有效範圍內則返回預設值
  </action>
  <verify>
```bash
grep -n "sync_on_login" includes/services/class-settings-service.php
grep -n "conflict_strategy" includes/services/class-settings-service.php
grep -n "get_sync_on_login" includes/services/class-settings-service.php
grep -n "get_conflict_strategy" includes/services/class-settings-service.php
```
預期：四個 grep 都有輸出
  </verify>
  <done>
SettingsService 已擴展，支援 sync_on_login (bool) 和 conflict_strategy (string) 設定
  </done>
</task>

<task type="auto">
  <name>Task 3: 在 Plugin 中載入 ProfileSyncService</name>
  <files>includes/class-plugin.php</files>
  <action>
修改 `includes/class-plugin.php`，在 loadDependencies() 方法中載入 ProfileSyncService：

**1. 在 services 區塊中新增（在 SettingsService 之後、Login_Handler 之前）：**
```php
require_once BUYGO_LINE_NOTIFY_PATH . 'includes/services/class-profile-sync-service.php';
```

**順序要求：**
- ProfileSyncService 應在 SettingsService 之後載入（因為依賴 SettingsService::get()）
- ProfileSyncService 應在 Login_Handler 之前載入（因為 Login_Handler 會呼叫它）

**注意事項：**
- ProfileSyncService 是靜態類別，不需要實例化
- 確保載入順序正確，避免類別未定義錯誤
  </action>
  <verify>
```bash
grep -n "class-profile-sync-service.php" includes/class-plugin.php
```
預期：grep 有輸出，顯示 ProfileSyncService 被載入
  </verify>
  <done>
ProfileSyncService 已在 Plugin 中載入，順序正確（在 SettingsService 之後、Login_Handler 之前）
  </done>
</task>

</tasks>

<verification>
**Phase 12 Plan 01 驗證：**

1. ProfileSyncService 類別存在且包含所有必要方法
2. SettingsService 已擴展支援 Profile Sync 設定
3. ProfileSyncService 已在 Plugin 中載入
4. 程式碼語法正確無 PHP errors

```bash
# 檢查 ProfileSyncService 檔案
cat includes/services/class-profile-sync-service.php | head -100

# 檢查 SettingsService 新方法
grep -A5 "function get_sync_on_login" includes/services/class-settings-service.php
grep -A5 "function get_conflict_strategy" includes/services/class-settings-service.php

# 檢查 Plugin 載入
grep -n "class-profile-sync-service.php" includes/class-plugin.php

# PHP 語法檢查
php -l includes/services/class-profile-sync-service.php
php -l includes/services/class-settings-service.php
php -l includes/class-plugin.php
```
</verification>

<success_criteria>
1. ProfileSyncService::syncProfile() 可正確同步 LINE profile 到 WordPress 用戶
2. shouldUpdateField() 正確區分 register/login/link 場景，依據衝突策略處理
3. 同步日誌正確記錄到 wp_options，最多保留 10 筆
4. SettingsService 支援 sync_on_login 和 conflict_strategy 設定
</success_criteria>

<output>
After completion, create `.planning/phases/12-profile-sync-與-avatar-整合/12-01-SUMMARY.md`
</output>
