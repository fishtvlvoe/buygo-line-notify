---
phase: 12-profile-sync-與-avatar-整合
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/services/class-profile-sync-service.php
  - includes/services/class-settings-service.php
  - includes/class-plugin.php
autonomous: true

must_haves:
  truths:
    - "ProfileSyncService::syncProfile() 可同步 LINE profile 到 WordPress 用戶"
    - "shouldUpdateField() 正確區分 register/login/link 場景"
    - "衝突策略 (line_priority/wordpress_priority/manual) 正確運作"
    - "同步日誌記錄到 wp_options，最多保留 10 筆"
    - "SettingsService 支援 sync_on_login 和 conflict_strategy 設定"
    - "ProfileSyncService 在 Plugin 中載入順序正確（在 SettingsService 之後）"
  artifacts:
    - path: "includes/services/class-profile-sync-service.php"
      provides: "Profile Sync 核心邏輯"
      exports: ["syncProfile", "shouldUpdateField", "logSync", "logConflict", "getSyncLog"]
    - path: "includes/services/class-settings-service.php"
      provides: "Profile Sync 設定存取"
      exports: ["get_sync_on_login", "get_conflict_strategy"]
  key_links:
    - from: "ProfileSyncService::syncProfile()"
      to: "wp_update_user()"
      via: "WordPress Core API"
      pattern: "wp_update_user.*ID.*display_name"
    - from: "ProfileSyncService::syncProfile()"
      to: "SettingsService::get()"
      via: "設定讀取"
      pattern: "SettingsService::get.*conflict_strategy"
    - from: "ProfileSyncService::logSync()"
      to: "wp_options"
      via: "update_option()"
      pattern: "buygo_line_sync_log_"
    - from: "Plugin::loadDependencies()"
      to: "ProfileSyncService"
      via: "require_once（在 SettingsService 之後載入）"
      pattern: "class-profile-sync-service\\.php"
---

<objective>
建立 ProfileSyncService 服務類別，實作 LINE profile 同步到 WordPress 用戶的核心邏輯

Purpose: 提供統一的 Profile Sync 方法，處理註冊/登入/綁定三種場景的 profile 同步，包含衝突處理策略和同步日誌記錄
Output: includes/services/class-profile-sync-service.php, 擴展 includes/services/class-settings-service.php
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-profile-sync-與-avatar-整合/12-RESEARCH.md
@includes/services/class-settings-service.php
@includes/class-plugin.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 擴展 SettingsService 並建立 ProfileSyncService</name>
  <files>
    - includes/services/class-settings-service.php
    - includes/services/class-profile-sync-service.php
  </files>
  <action>
**Part A: 修改 includes/services/class-settings-service.php**

在 get_all() 方法中新增 keys：
```php
$keys = [
    // ... 現有的 keys ...
    'sync_on_login',       // 新增：登入時是否同步 profile
    'conflict_strategy',   // 新增：衝突處理策略
];
```

新增 helper 方法：
```php
/**
 * 取得是否在登入時同步 Profile
 *
 * @return bool
 */
public static function get_sync_on_login(): bool
{
    return (bool) self::get('sync_on_login', false);
}

/**
 * 取得衝突處理策略
 *
 * @return string 'line_priority' | 'wordpress_priority' | 'manual'
 */
public static function get_conflict_strategy(): string
{
    $strategy = self::get('conflict_strategy', 'line_priority');
    $valid = ['line_priority', 'wordpress_priority', 'manual'];
    return in_array($strategy, $valid, true) ? $strategy : 'line_priority';
}
```

**Part B: 建立 includes/services/class-profile-sync-service.php**

實作以下類別結構：
```php
namespace BuygoLineNotify\Services;

class ProfileSyncService {
    public static function syncProfile(int $user_id, array $line_profile, string $action): bool|\WP_Error
    private static function shouldUpdateField(string $field, $current_value, $new_value, string $strategy, string $action): bool
    private static function logSync(int $user_id, string $action, array $changed_fields, array $old_values, array $line_profile): void
    private static function logConflict(int $user_id, string $field, $current_value, $new_value): void
    public static function getSyncLog(int $user_id): array
    public static function clearSyncLog(int $user_id): bool
}
```

**syncProfile() 方法核心邏輯：**
- 參數：$user_id (int), $line_profile (array: displayName, email, pictureUrl), $action (string: register/login/link)
- 取得用戶現有資料 (get_user_by('id'))
- 取得衝突策略 (SettingsService::get('conflict_strategy', 'line_priority'))
- 記錄變更前的值 (display_name, user_email, avatar_url)
- 處理 display_name：呼叫 shouldUpdateField() 判斷是否更新
- 處理 user_email：呼叫 shouldUpdateField() + email_exists() 檢查重複
- 使用 wp_update_user() 更新用戶資料
- 處理頭像：update_user_meta('buygo_line_avatar_url'), update_user_meta('buygo_line_avatar_updated', current_time('mysql'))
- 呼叫 logSync() 記錄日誌
- 返回 true 或 WP_Error

**shouldUpdateField() 方法邏輯：**
- register 動作：強制同步（無視衝突策略），只要有新值就更新
- login 動作：檢查 SettingsService::get('sync_on_login', false)，若未啟用則返回 false
- 若當前值為空，始終更新
- 若當前值與新值相同，跳過
- 依據 conflict_strategy 決定：
  - 'line_priority'：有新值就覆蓋
  - 'wordpress_priority'：保留現有值（返回 false）
  - 'manual'：呼叫 logConflict() 記錄差異，返回 false

**logSync() 方法：**
- 日誌 key: `buygo_line_sync_log_{user_id}`
- 格式：JSON array，新增一筆記錄
- 記錄內容：timestamp, action, changed_fields, old_values, new_values
- 保留最近 10 筆 (array_slice($logs, -10))
- 使用 update_option($log_key, $logs, false) - autoload=false

**logConflict() 方法：**
- 衝突日誌 key: `buygo_line_conflict_log_{user_id}`
- 記錄：timestamp, field, current_value, new_value
- 保留最近 10 筆

**注意事項：**
- Email 更新前必須檢查 email_exists()，若已被其他用戶使用則跳過
- 使用 sanitize_text_field() 清理 displayName
- 使用 sanitize_email() 清理 email
- 使用 esc_url_raw() 清理 pictureUrl
  </action>
  <verify>
檔案結構驗證：
```bash
# 驗證 SettingsService 擴展
grep -n "sync_on_login" includes/services/class-settings-service.php
grep -n "conflict_strategy" includes/services/class-settings-service.php
grep -n "get_sync_on_login" includes/services/class-settings-service.php
grep -n "get_conflict_strategy" includes/services/class-settings-service.php

# 驗證 ProfileSyncService
grep -n "class ProfileSyncService" includes/services/class-profile-sync-service.php
grep -n "public static function syncProfile" includes/services/class-profile-sync-service.php
grep -n "private static function shouldUpdateField" includes/services/class-profile-sync-service.php
grep -n "private static function logSync" includes/services/class-profile-sync-service.php
```
預期：所有 grep 都有輸出
  </verify>
  <done>
SettingsService 已擴展支援 sync_on_login 和 conflict_strategy 設定；ProfileSyncService 類別已建立，包含完整的同步和日誌方法
  </done>
</task>

<task type="auto">
  <name>Task 2: 在 Plugin 中載入 ProfileSyncService（驗證載入順序）</name>
  <files>includes/class-plugin.php</files>
  <action>
修改 `includes/class-plugin.php`，在 loadDependencies() 方法中載入 ProfileSyncService：

**1. 在 services 區塊中新增（必須在 SettingsService 之後）：**

先確認 SettingsService 的載入位置，找到類似這行：
```php
require_once BUYGO_LINE_NOTIFY_PATH . 'includes/services/class-settings-service.php';
```

然後在 SettingsService 載入之後、Login_Handler 或 UserService 之前新增：
```php
// ProfileSyncService 依賴 SettingsService，必須在其之後載入
require_once BUYGO_LINE_NOTIFY_PATH . 'includes/services/class-profile-sync-service.php';
```

**2. 載入順序驗證說明：**
- SettingsService 必須先載入（ProfileSyncService::syncProfile() 會呼叫 SettingsService::get()）
- ProfileSyncService 必須在 UserService 和 Login_Handler 之前載入（它們會呼叫 ProfileSyncService）
- 正確順序：SettingsService → ProfileSyncService → UserService / Login_Handler

**注意事項：**
- ProfileSyncService 是靜態類別，不需要實例化
- 確保載入順序正確，避免類別未定義錯誤
- 若 loadDependencies() 中沒有明確的 SettingsService 載入（可能由 autoload 處理），則在 services 區塊末尾新增 ProfileSyncService 載入
  </action>
  <verify>
```bash
# 驗證 ProfileSyncService 被載入
grep -n "class-profile-sync-service.php" includes/class-plugin.php

# 驗證載入順序（SettingsService 應在 ProfileSyncService 之前）
grep -n "class-settings-service.php\|class-profile-sync-service.php" includes/class-plugin.php | sort -t: -k1 -n
```
預期：grep 有輸出，且 settings-service 的行號小於 profile-sync-service（表示先載入）
  </verify>
  <done>
ProfileSyncService 已在 Plugin 中載入，順序正確（在 SettingsService 之後、UserService/Login_Handler 之前）
  </done>
</task>

</tasks>

<verification>
**Phase 12 Plan 01 驗證：**

1. SettingsService 已擴展支援 Profile Sync 設定
2. ProfileSyncService 類別存在且包含所有必要方法
3. ProfileSyncService 已在 Plugin 中正確載入（順序正確）
4. 程式碼語法正確無 PHP errors

```bash
# 檢查 SettingsService 新方法
grep -A5 "function get_sync_on_login" includes/services/class-settings-service.php
grep -A5 "function get_conflict_strategy" includes/services/class-settings-service.php

# 檢查 ProfileSyncService 檔案
cat includes/services/class-profile-sync-service.php | head -100

# 檢查 Plugin 載入順序
grep -n "class-settings-service.php\|class-profile-sync-service.php" includes/class-plugin.php

# PHP 語法檢查
php -l includes/services/class-settings-service.php
php -l includes/services/class-profile-sync-service.php
php -l includes/class-plugin.php
```
</verification>

<success_criteria>
1. ProfileSyncService::syncProfile() 可正確同步 LINE profile 到 WordPress 用戶
2. shouldUpdateField() 正確區分 register/login/link 場景，依據衝突策略處理
3. 同步日誌正確記錄到 wp_options，最多保留 10 筆
4. SettingsService 支援 sync_on_login 和 conflict_strategy 設定
5. ProfileSyncService 載入順序正確（在 SettingsService 之後）
</success_criteria>

<output>
After completion, create `.planning/phases/12-profile-sync-與-avatar-整合/12-01-SUMMARY.md`
</output>
