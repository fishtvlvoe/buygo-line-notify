---
phase: 12-profile-sync-與-avatar-整合
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/services/class-avatar-service.php
autonomous: true

must_haves:
  truths:
    - "AvatarService::filterAvatarUrl() 可返回 LINE 頭像 URL"
    - "已綁定 LINE 的用戶顯示 LINE 頭像，未綁定的用戶顯示原始頭像"
    - "頭像快取 7 天，過期時返回舊 URL（等下次登入更新）"
    - "getUserIdFromMixed() 可從多種類型參數解析出 user_id"
  artifacts:
    - path: "includes/services/class-avatar-service.php"
      provides: "Avatar 整合服務"
      exports: ["init", "filterAvatarUrl", "getUserIdFromMixed", "clearAvatarCache", "clearAllAvatarCache"]
  key_links:
    - from: "AvatarService::filterAvatarUrl()"
      to: "get_avatar_url filter"
      via: "add_filter()"
      pattern: "add_filter.*get_avatar_url"
    - from: "AvatarService::filterAvatarUrl()"
      to: "LineUserService::isUserLinked()"
      via: "綁定狀態查詢"
      pattern: "isUserLinked"
---

<objective>
建立 AvatarService 服務類別，實作 WordPress get_avatar_url filter hook 整合 LINE 頭像

Purpose: 讓已綁定 LINE 的用戶在 WordPress 中顯示 LINE 頭像，包含 7 天快取機制
Output: includes/services/class-avatar-service.php
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-profile-sync-與-avatar-整合/12-RESEARCH.md
@includes/services/class-line-user-service.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 AvatarService 類別</name>
  <files>includes/services/class-avatar-service.php</files>
  <action>
建立 `includes/services/class-avatar-service.php` 檔案，實作以下功能：

**1. 類別結構：**
```php
namespace BuygoLineNotify\Services;

class AvatarService {
    public static function init(): void
    public static function filterAvatarUrl($url, $id_or_email, $args): string
    private static function getUserIdFromMixed($id_or_email): ?int
    public static function clearAvatarCache(int $user_id): bool
    public static function clearAllAvatarCache(): int
}
```

**2. init() 方法：**
```php
public static function init(): void {
    add_filter('get_avatar_url', [__CLASS__, 'filterAvatarUrl'], 10, 3);
}
```

**3. filterAvatarUrl() 方法：**
```php
/**
 * Filter hook: 返回 LINE 頭像 URL
 *
 * @param string $url 原始頭像 URL
 * @param mixed $id_or_email 用戶 ID、email 或 WP_User/WP_Comment 物件
 * @param array $args 參數陣列
 * @return string 過濾後的頭像 URL
 */
public static function filterAvatarUrl($url, $id_or_email, $args) {
    // 1. 解析出 user_id
    $user_id = self::getUserIdFromMixed($id_or_email);
    if (!$user_id) {
        return $url; // 無法識別用戶，返回原始 URL
    }

    // 2. 檢查用戶是否綁定 LINE
    if (!LineUserService::isUserLinked($user_id)) {
        return $url; // 未綁定，返回原始 URL
    }

    // 3. 讀取快取的 LINE 頭像 URL
    $line_avatar_url = get_user_meta($user_id, 'buygo_line_avatar_url', true);
    $avatar_updated = get_user_meta($user_id, 'buygo_line_avatar_updated', true);

    // 4. 若沒有快取，返回原始 URL
    if (empty($line_avatar_url)) {
        return $url;
    }

    // 5. 檢查快取是否過期（7 天）
    if (!empty($avatar_updated)) {
        $updated_time = strtotime($avatar_updated);
        $cache_duration = 7 * DAY_IN_SECONDS;

        if ((time() - $updated_time) < $cache_duration) {
            return $line_avatar_url; // 快取有效，直接返回
        }
    }

    // 6. 快取過期，仍返回舊 URL（等下次登入更新）
    // 不在此處主動請求 LINE API（避免阻塞頁面渲染，且需要 access_token）
    return $line_avatar_url;
}
```

**4. getUserIdFromMixed() 方法：**
```php
/**
 * 從混合類型參數解析出 user_id
 *
 * @param mixed $id_or_email
 * @return int|null
 */
private static function getUserIdFromMixed($id_or_email): ?int {
    // 數字 ID
    if (is_numeric($id_or_email)) {
        return (int) $id_or_email;
    }

    // WP_User 物件
    if ($id_or_email instanceof \WP_User) {
        return $id_or_email->ID;
    }

    // WP_Comment 物件
    if ($id_or_email instanceof \WP_Comment) {
        return $id_or_email->user_id ? (int) $id_or_email->user_id : null;
    }

    // WP_Post 物件
    if ($id_or_email instanceof \WP_Post) {
        return (int) $id_or_email->post_author;
    }

    // Email 字串
    if (is_string($id_or_email) && is_email($id_or_email)) {
        $user = get_user_by('email', $id_or_email);
        return $user ? $user->ID : null;
    }

    return null;
}
```

**5. clearAvatarCache() 方法：**
```php
/**
 * 清除單一用戶的頭像快取
 *
 * @param int $user_id
 * @return bool
 */
public static function clearAvatarCache(int $user_id): bool {
    delete_user_meta($user_id, 'buygo_line_avatar_updated');
    // 注意：不刪除 buygo_line_avatar_url，讓快取過期時仍可顯示舊頭像
    return true;
}
```

**6. clearAllAvatarCache() 方法：**
```php
/**
 * 清除所有用戶的頭像快取
 *
 * @return int 清除的記錄數
 */
public static function clearAllAvatarCache(): int {
    global $wpdb;

    $result = $wpdb->query(
        "DELETE FROM {$wpdb->usermeta}
         WHERE meta_key = 'buygo_line_avatar_updated'"
    );

    return $result !== false ? $result : 0;
}
```

**注意事項：**
- 使用 DAY_IN_SECONDS 常數（WordPress 定義，等於 86400）
- 不在 filter 中主動請求 LINE API（需要 access_token，且會阻塞頁面）
- 快取過期時仍返回舊 URL，等下次登入時由 ProfileSyncService 更新
- WP_Comment 的 user_id 可能為 0（訪客留言），需特別處理
  </action>
  <verify>
```bash
grep -n "class AvatarService" includes/services/class-avatar-service.php
grep -n "public static function init" includes/services/class-avatar-service.php
grep -n "public static function filterAvatarUrl" includes/services/class-avatar-service.php
grep -n "add_filter.*get_avatar_url" includes/services/class-avatar-service.php
```
預期：四個 grep 都有輸出
  </verify>
  <done>
AvatarService 類別已建立，包含 init()、filterAvatarUrl()、getUserIdFromMixed()、clearAvatarCache()、clearAllAvatarCache() 方法
  </done>
</task>

<task type="auto">
  <name>Task 2: 整合 AvatarService 到 Plugin</name>
  <files>includes/class-plugin.php</files>
  <action>
修改 `includes/class-plugin.php`，整合 AvatarService：

**1. 在 loadDependencies() 方法中載入 AvatarService：**
```php
// 在 services 區塊新增
require_once BUYGO_LINE_NOTIFY_PATH . 'includes/services/class-avatar-service.php';
```

**2. 在 onInit() 方法中初始化 AvatarService：**
```php
// 在適當位置（例如 Login_Handler::init() 之後）
Services\AvatarService::init();
```

**注意事項：**
- AvatarService::init() 只是註冊 filter hook，可以在 init action 時執行
- 確保 LineUserService 已在 AvatarService 之前載入
  </action>
  <verify>
```bash
grep -n "class-avatar-service.php" includes/class-plugin.php
grep -n "AvatarService::init" includes/class-plugin.php
```
預期：兩個 grep 都有輸出
  </verify>
  <done>
AvatarService 已整合到 Plugin，filter hook 在 init action 時註冊
  </done>
</task>

</tasks>

<verification>
**Phase 12 Plan 02 驗證：**

1. AvatarService 類別存在且包含所有必要方法
2. AvatarService 已整合到 Plugin
3. 程式碼語法正確無 PHP errors

```bash
# 檢查 AvatarService 檔案
cat includes/services/class-avatar-service.php | head -100

# 檢查 Plugin 整合
grep -B2 -A2 "AvatarService" includes/class-plugin.php

# PHP 語法檢查
php -l includes/services/class-avatar-service.php
php -l includes/class-plugin.php
```
</verification>

<success_criteria>
1. AvatarService::filterAvatarUrl() 可正確返回 LINE 頭像 URL
2. 已綁定 LINE 的用戶顯示 LINE 頭像，未綁定的用戶顯示原始頭像
3. 頭像快取 7 天，過期時返回舊 URL
4. AvatarService 已整合到 Plugin，filter hook 正確註冊
</success_criteria>

<output>
After completion, create `.planning/phases/12-profile-sync-與-avatar-整合/12-02-SUMMARY.md`
</output>
