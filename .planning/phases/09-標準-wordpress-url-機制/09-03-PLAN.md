---
phase: 09-標準-wordpress-url-機制
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - includes/services/class-url-filter-service.php
  - includes/class-plugin.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "wp_login_url() filter 可選擇性附加 loginSocial=buygo-line 參數"
    - "wp_logout_url() filter 可清除 LINE 相關 Session/Transient 資料"
    - "Filter 有開關設定,預設關閉（避免影響標準 WordPress 登入行為）"
  artifacts:
    - path: "includes/services/class-url-filter-service.php"
      provides: "URL Filter Service 類別"
      min_lines: 50
      exports: ["UrlFilterService"]
    - path: "includes/class-plugin.php"
      provides: "整合 UrlFilterService hooks"
      contains: "UrlFilterService"
  key_links:
    - from: "includes/services/class-url-filter-service.php"
      to: "includes/services/class-settings-service.php"
      via: "讀取設定判斷是否啟用 filter"
      pattern: "SettingsService|get_option"
    - from: "includes/services/class-url-filter-service.php"
      to: "includes/services/class-state-manager.php"
      via: "logout 時清除 LINE 相關 Transient"
      pattern: "StateManager|delete_transient"
---

<objective>
實作 URL-04 需求：整合 login_url 和 logout_url WordPress filters

Purpose: 讓 WordPress 的 wp_login_url() 和 wp_logout_url() 函數可選擇性支援 LINE Login 流程整合，提供更無縫的用戶體驗

Output: UrlFilterService 類別,處理 login_url 和 logout_url filters
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS-v0.2.md
@.planning/phases/09-標準-wordpress-url-機制/09-RESEARCH.md
@.planning/phases/09-標準-wordpress-url-機制/09-01-SUMMARY.md
@includes/class-plugin.php
@includes/services/class-settings-service.php
@includes/services/class-state-manager.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 UrlFilterService 類別</name>
  <files>includes/services/class-url-filter-service.php</files>
  <action>
建立 UrlFilterService 類別,處理 WordPress URL filters 整合。

實作要點：
1. 使用 namespace `BuygoLineNotify\Services`
2. 注入 SettingsService 依賴（讀取設定）

核心方法：

1. `register_hooks()` - 靜態方法,註冊 WordPress filters
   ```php
   public static function register_hooks() {
       $service = new self();
       // login_url filter - 優先級 20（讓其他外掛先處理）
       add_filter('login_url', [$service, 'filter_login_url'], 20, 3);
       // logout_url filter - 優先級 20
       add_filter('logout_url', [$service, 'filter_logout_url'], 20, 2);
       // wp_logout action - 清除 LINE 相關資料
       add_action('wp_logout', [$service, 'on_logout'], 10, 1);
   }
   ```

2. `filter_login_url($login_url, $redirect, $force_reauth)` - 過濾登入 URL
   - 檢查設定 `buygo_line_auto_append_login_social` 是否啟用（預設 false）
   - 若未啟用: 直接返回原始 $login_url
   - 若啟用: 附加 `loginSocial=buygo-line` 參數
   - 保留原有的 redirect_to 參數
   ```php
   public function filter_login_url($login_url, $redirect, $force_reauth) {
       // 檢查設定是否啟用
       $auto_append = get_option('buygo_line_auto_append_login_social', false);
       if (!$auto_append) {
           return $login_url;
       }

       // 附加 loginSocial 參數
       $login_url = add_query_arg('loginSocial', 'buygo-line', $login_url);
       return $login_url;
   }
   ```

3. `filter_logout_url($logout_url, $redirect)` - 過濾登出 URL（目前僅傳遞,未來可擴展）
   ```php
   public function filter_logout_url($logout_url, $redirect) {
       // 目前不修改登出 URL,僅作為擴展點
       return $logout_url;
   }
   ```

4. `on_logout($user_id)` - 登出時清除 LINE 相關資料
   - 清除該用戶相關的 LINE OAuth Transients（若有）
   - 記錄登出日誌（debug level）
   ```php
   public function on_logout($user_id) {
       // 清除用戶相關的 LINE state transients
       // 注意：StateManager 的 transient key 是基於 state 值,不是 user_id
       // 這裡主要清除用戶 session 中可能殘留的 LINE 資料

       // 清除 session 中的 LINE 相關資料（若使用 session）
       if (session_status() === PHP_SESSION_ACTIVE) {
           unset($_SESSION['buygo_line_profile']);
           unset($_SESSION['buygo_line_state']);
       }

       Logger::get_instance()->log('debug', [
           'message' => 'User logged out, LINE session data cleared',
           'user_id' => $user_id,
       ]);
   }
   ```

注意事項：
- login_url filter 預設關閉,避免影響標準 WordPress 登入行為
- 用戶可在後台設定啟用「自動附加 LINE 登入參數」
- logout 清除功能確保登出後不會殘留 LINE 相關狀態

範例結構：
```php
namespace BuygoLineNotify\Services;

class UrlFilterService {

    public static function register_hooks() {
        $service = new self();
        add_filter('login_url', [$service, 'filter_login_url'], 20, 3);
        add_filter('logout_url', [$service, 'filter_logout_url'], 20, 2);
        add_action('wp_logout', [$service, 'on_logout'], 10, 1);
    }

    public function filter_login_url($login_url, $redirect, $force_reauth) {
        $auto_append = get_option('buygo_line_auto_append_login_social', false);
        if (!$auto_append) {
            return $login_url;
        }
        return add_query_arg('loginSocial', 'buygo-line', $login_url);
    }

    public function filter_logout_url($logout_url, $redirect) {
        return $logout_url;
    }

    public function on_logout($user_id) {
        if (session_status() === PHP_SESSION_ACTIVE) {
            unset($_SESSION['buygo_line_profile']);
            unset($_SESSION['buygo_line_state']);
        }
        Logger::get_instance()->log('debug', [
            'message' => 'User logged out, LINE session data cleared',
            'user_id' => $user_id,
        ]);
    }
}
```
  </action>
  <verify>grep -n "class UrlFilterService" includes/services/class-url-filter-service.php && grep -n "filter_login_url\|filter_logout_url\|on_logout" includes/services/class-url-filter-service.php</verify>
  <done>UrlFilterService 類別存在,包含 register_hooks()、filter_login_url()、filter_logout_url()、on_logout() 方法</done>
</task>

<task type="auto">
  <name>Task 2: 整合 UrlFilterService 到 Plugin</name>
  <files>includes/class-plugin.php</files>
  <action>
更新 Plugin 類別,載入並註冊 UrlFilterService hooks。

修改位置：

1. `loadDependencies()` 方法 - 新增 include
   在 Handler 類別載入後新增：
   ```php
   // 載入 URL Filter Service（URL-04 需求）
   include_once BuygoLineNotify_PLUGIN_DIR . 'includes/services/class-url-filter-service.php';
   ```

2. `onInit()` 方法 - 註冊 UrlFilterService hooks
   在 Login_Handler 註冊後新增：
   ```php
   // 註冊 URL Filter Service（login_url / logout_url filters）
   \BuygoLineNotify\Services\UrlFilterService::register_hooks();
   ```

注意事項：
- UrlFilterService 應在 Login_Handler 之後載入（依賴順序）
- Filter 預設關閉,需在後台設定啟用
  </action>
  <verify>grep -n "UrlFilterService::register_hooks" includes/class-plugin.php && grep -n "class-url-filter-service.php" includes/class-plugin.php</verify>
  <done>Plugin 類別已載入 UrlFilterService 並呼叫 register_hooks()</done>
</task>

</tasks>

<verification>
完成後執行以下驗證：

1. UrlFilterService 驗證
```bash
# 確認類別和核心方法存在
grep -n "class UrlFilterService" includes/services/class-url-filter-service.php
grep -n "filter_login_url\|filter_logout_url\|on_logout" includes/services/class-url-filter-service.php
# 確認 filter 註冊
grep -n "add_filter.*login_url\|add_filter.*logout_url\|add_action.*wp_logout" includes/services/class-url-filter-service.php
```

2. Plugin 整合驗證
```bash
# 確認 include 和 register_hooks 呼叫
grep -n "class-url-filter-service.php" includes/class-plugin.php
grep -n "UrlFilterService::register_hooks" includes/class-plugin.php
```

3. PHP 語法驗證
```bash
php -l includes/services/class-url-filter-service.php
php -l includes/class-plugin.php
```
</verification>

<success_criteria>
1. UrlFilterService 類別存在,包含 login_url/logout_url filter 方法
2. login_url filter 預設關閉,可透過設定啟用
3. logout 時清除 LINE 相關 session 資料
4. PHP 語法無錯誤
5. URL-04 需求（login_url 和 logout_url filter 整合）完成
</success_criteria>

<output>
After completion, create `.planning/phases/09-標準-wordpress-url-機制/09-03-SUMMARY.md`
</output>
