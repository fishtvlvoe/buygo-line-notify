---
phase: 09-標準-wordpress-url-機制
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/exceptions/class-nsl-continue-page-render-exception.php
  - includes/handlers/class-login-handler.php
  - includes/services/class-login-service.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "訪問 wp-login.php?loginSocial=buygo-line 會啟動 LINE OAuth 流程（建立 State、導向 LINE）"
    - "OAuth callback 回來時 wp-login.php?loginSocial=buygo-line&code=xxx&state=xxx 會正確處理"
    - "NSLContinuePageRenderException 例外可被正確拋出和捕捉"
    - "已綁定用戶透過 LINE Login 可成功登入並導向"
  artifacts:
    - path: "includes/exceptions/class-nsl-continue-page-render-exception.php"
      provides: "NSLContinuePageRenderException 例外類別"
      min_lines: 15
    - path: "includes/handlers/class-login-handler.php"
      provides: "login_init hook handler"
      min_lines: 100
      exports: ["Login_Handler"]
    - path: "includes/services/class-login-service.php"
      provides: "更新後的 LoginService（使用標準 WordPress URL）"
      contains: "wp-login.php?loginSocial=buygo-line"
  key_links:
    - from: "includes/handlers/class-login-handler.php"
      to: "includes/services/class-login-service.php"
      via: "呼叫 get_authorize_url() 和 handle_callback()"
      pattern: "login_service->get_authorize_url|login_service->handle_callback"
    - from: "includes/handlers/class-login-handler.php"
      to: "includes/services/class-line-user-service.php"
      via: "呼叫 getUserByLineUid() 查詢用戶"
      pattern: "LineUserService::getUserByLineUid"
    - from: "includes/handlers/class-login-handler.php"
      to: "includes/exceptions/class-nsl-continue-page-render-exception.php"
      via: "拋出 NSLContinuePageRenderException"
      pattern: "throw new NSLContinuePageRenderException"
---

<objective>
建立 Login Handler 基礎架構,實作 login_init hook 處理 LINE Login 流程

Purpose: 取代 REST API 架構,使用標準 WordPress URL 機制（wp-login.php?loginSocial=buygo-line）處理 OAuth 流程,解決 REST API HTML 輸出問題並對齊 Nextend Social Login 架構

Output: NSLContinuePageRenderException 例外類別、Login_Handler 類別、更新後的 LoginService
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS-v0.2.md
@.planning/phases/09-標準-wordpress-url-機制/09-RESEARCH.md
@.planning/phases/08-資料表架構與查詢-api/08-02-SUMMARY.md
@includes/services/class-login-service.php
@includes/services/class-state-manager.php
@includes/services/class-line-user-service.php
@includes/api/class-login-api.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 NSLContinuePageRenderException 例外類別</name>
  <files>includes/exceptions/class-nsl-continue-page-render-exception.php</files>
  <action>
建立 NSLContinuePageRenderException 例外類別（對齊 Nextend Social Login 模式）。

實作要點：
1. 建立 `includes/exceptions/` 目錄（若不存在）
2. 建立 `class-nsl-continue-page-render-exception.php`
3. 使用 namespace `BuygoLineNotify\Exceptions`
4. 繼承自 PHP `\Exception`
5. 定義常數區分流程類型：
   - `FLOW_REGISTER` = 'register' （新用戶註冊流程）
   - `FLOW_LOGIN` = 'login' （已有用戶登入流程）
   - `FLOW_LINK` = 'link' （已登入用戶綁定流程）
6. 建構子接受 `$flow_type` 和 `$data` 參數（儲存 LINE profile 等資料）
7. 新增 getFlowType() 和 getData() getter 方法

範例結構：
```php
namespace BuygoLineNotify\Exceptions;

class NSLContinuePageRenderException extends \Exception {
    const FLOW_REGISTER = 'register';
    const FLOW_LOGIN = 'login';
    const FLOW_LINK = 'link';

    private $flow_type;
    private $data;

    public function __construct(string $flow_type, array $data = []) {
        $this->flow_type = $flow_type;
        $this->data = $data;
        parent::__construct('Continue page render: ' . $flow_type);
    }

    public function getFlowType(): string { return $this->flow_type; }
    public function getData(): array { return $this->data; }
}
```

注意：此例外「不是錯誤」,用於控制流程（讓 WordPress 繼續渲染頁面而非重定向）
  </action>
  <verify>grep -n "class NSLContinuePageRenderException" includes/exceptions/class-nsl-continue-page-render-exception.php</verify>
  <done>NSLContinuePageRenderException 類別存在,包含 FLOW_REGISTER/FLOW_LOGIN/FLOW_LINK 常數和 getFlowType()/getData() 方法</done>
</task>

<task type="auto">
  <name>Task 2: 建立 Login_Handler 類別（login_init hook）</name>
  <files>includes/handlers/class-login-handler.php</files>
  <action>
建立 Login_Handler 類別,處理 login_init hook 攔截 LINE Login 流程。

實作要點：
1. 建立 `includes/handlers/` 目錄（若不存在）
2. 使用 namespace `BuygoLineNotify\Handlers`
3. 注入 LoginService、LineUserService 依賴

核心方法：
1. `register_hooks()` - 靜態方法,註冊 login_init hook
2. `handle_login_init()` - 主處理邏輯
   - 檢查 `$_GET['loginSocial'] === 'buygo-line'`（不符合則 return）
   - 若有 `$_GET['code']` 和 `$_GET['state']`: 處理 callback
   - 否則: 處理 authorize（導向 LINE）
3. `handle_authorize()` - 處理初始授權請求
   - 取得 redirect_to 參數（預設 home_url()）
   - 呼叫 LoginService->get_authorize_url()
   - wp_redirect() 到 LINE
   - exit
4. `handle_callback($code, $state)` - 處理 OAuth callback
   - 呼叫 LoginService->handle_callback()
   - 若錯誤: wp_die() 顯示錯誤
   - 取得 LINE profile 和 state_data
   - 呼叫 LineUserService::getUserByLineUid() 查詢用戶
   - 若用戶存在: 執行登入（wp_set_auth_cookie + 導向）
   - 若用戶不存在: 拋出 NSLContinuePageRenderException(FLOW_REGISTER, profile)

login_init hook 外層用 try-catch 包裹：
- catch NSLContinuePageRenderException: 不做任何事（讓頁面繼續渲染,Phase 10 處理）
- catch Exception: wp_die() 顯示錯誤

登入成功處理：
- wp_set_auth_cookie($user_id, true)
- apply_filters('login_redirect', ...) 取得導向 URL
- wp_redirect() + exit

重要：不使用 REST API 的 handle_redirect() HTML 輸出,改用標準 wp_redirect()

範例結構：
```php
namespace BuygoLineNotify\Handlers;

use BuygoLineNotify\Services\LoginService;
use BuygoLineNotify\Services\LineUserService;
use BuygoLineNotify\Services\Logger;
use BuygoLineNotify\Exceptions\NSLContinuePageRenderException;

class Login_Handler {
    private $login_service;

    public function __construct() {
        $this->login_service = new LoginService();
    }

    public static function register_hooks() {
        $handler = new self();
        add_action('login_init', [$handler, 'handle_login_init']);
    }

    public function handle_login_init() {
        if (!isset($_GET['loginSocial']) || $_GET['loginSocial'] !== 'buygo-line') {
            return;
        }

        try {
            if (isset($_GET['code']) && isset($_GET['state'])) {
                $this->handle_callback(
                    sanitize_text_field($_GET['code']),
                    sanitize_text_field($_GET['state'])
                );
            } else {
                $this->handle_authorize();
            }
        } catch (NSLContinuePageRenderException $e) {
            // 不是錯誤,讓頁面繼續渲染（Phase 10 處理）
            return;
        } catch (\Exception $e) {
            Logger::get_instance()->log('error', [
                'message' => 'LINE Login error',
                'error' => $e->getMessage(),
            ]);
            wp_die('LINE 登入失敗: ' . esc_html($e->getMessage()), 'LINE Login Error', ['response' => 400]);
        }
    }
    // ... handle_authorize(), handle_callback() 實作
}
```
  </action>
  <verify>grep -n "class Login_Handler" includes/handlers/class-login-handler.php && grep -n "handle_login_init" includes/handlers/class-login-handler.php</verify>
  <done>Login_Handler 類別存在,包含 register_hooks()、handle_login_init()、handle_authorize()、handle_callback() 方法</done>
</task>

<task type="auto">
  <name>Task 3: 更新 LoginService callback URL</name>
  <files>includes/services/class-login-service.php</files>
  <action>
更新 LoginService 的 callback URL 從 REST API 改為標準 WordPress URL。

修改位置：
1. `get_authorize_url()` 方法（第 89-90 行）
   - 舊: `$callback_url = rest_url('buygo-line-notify/v1/login/callback');`
   - 新: `$callback_url = site_url('wp-login.php?loginSocial=buygo-line');`

2. `exchange_token()` 方法（第 175 行）
   - 舊: `$callback_url = rest_url('buygo-line-notify/v1/login/callback');`
   - 新: `$callback_url = site_url('wp-login.php?loginSocial=buygo-line');`

原因：
- LINE OAuth 要求 authorize 和 token exchange 使用相同的 redirect_uri
- 標準 WordPress URL 可正確處理 HTML 輸出（REST API 會設定 JSON content-type）
- 對齊 Nextend Social Login 架構

測試要點：
- 確保 LINE Developers Console 的 Redirect URI 設定為 `https://your-site.com/wp-login.php?loginSocial=buygo-line`
  </action>
  <verify>grep -n "wp-login.php?loginSocial=buygo-line" includes/services/class-login-service.php | wc -l | xargs test 2 -eq</verify>
  <done>LoginService 中有 2 處 callback URL 已更新為 wp-login.php?loginSocial=buygo-line</done>
</task>

</tasks>

<verification>
完成後執行以下驗證：

1. 檔案結構驗證
```bash
# 確認新目錄和檔案建立
ls -la includes/exceptions/class-nsl-continue-page-render-exception.php
ls -la includes/handlers/class-login-handler.php
```

2. NSLContinuePageRenderException 驗證
```bash
# 確認例外類別結構
grep -E "FLOW_(REGISTER|LOGIN|LINK)" includes/exceptions/class-nsl-continue-page-render-exception.php
grep -n "getFlowType\|getData" includes/exceptions/class-nsl-continue-page-render-exception.php
```

3. Login_Handler 驗證
```bash
# 確認核心方法存在
grep -n "register_hooks\|handle_login_init\|handle_authorize\|handle_callback" includes/handlers/class-login-handler.php
# 確認 hook 註冊
grep -n "add_action.*login_init" includes/handlers/class-login-handler.php
# 確認例外處理
grep -n "NSLContinuePageRenderException" includes/handlers/class-login-handler.php
```

4. LoginService callback URL 驗證
```bash
# 確認不再使用 REST API URL
grep -n "rest_url.*login.*callback" includes/services/class-login-service.php | wc -l | xargs test 0 -eq && echo "PASS: No REST API URL"
# 確認使用標準 WordPress URL
grep -c "wp-login.php?loginSocial=buygo-line" includes/services/class-login-service.php
```

5. PHP 語法驗證
```bash
php -l includes/exceptions/class-nsl-continue-page-render-exception.php
php -l includes/handlers/class-login-handler.php
php -l includes/services/class-login-service.php
```
</verification>

<success_criteria>
1. NSLContinuePageRenderException 例外類別存在,包含三種流程類型常數
2. Login_Handler 類別存在,實作 login_init hook 處理
3. LoginService callback URL 已更新為 wp-login.php?loginSocial=buygo-line
4. PHP 語法無錯誤
5. 已綁定用戶可透過 LINE Login 成功登入（Phase 9 整合後測試）
</success_criteria>

<output>
After completion, create `.planning/phases/09-標準-wordpress-url-機制/09-01-SUMMARY.md`
</output>
