---
phase: 09-標準-wordpress-url-機制
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - includes/class-plugin.php
  - includes/api/class-login-api.php
autonomous: false
user_setup: []

must_haves:
  truths:
    - "訪問 wp-login.php?loginSocial=buygo-line 可正確啟動 LINE OAuth（Login_Handler 已整合）"
    - "舊 REST API endpoint 仍可存取但回應包含 deprecated 警告"
    - "wp_login_url() 可選擇性附加 loginSocial 參數"
    - "Login_Handler include 已加入 Plugin loadDependencies"
  artifacts:
    - path: "includes/class-plugin.php"
      provides: "整合 Login_Handler hooks"
      contains: "Login_Handler::register_hooks"
    - path: "includes/api/class-login-api.php"
      provides: "已標記 deprecated 的 REST API"
      contains: "@deprecated"
  key_links:
    - from: "includes/class-plugin.php"
      to: "includes/handlers/class-login-handler.php"
      via: "include 和呼叫 register_hooks()"
      pattern: "class-login-handler.php|Login_Handler::register_hooks"
---

<objective>
整合 Login_Handler 到外掛主流程,標記舊 REST API 為 deprecated

Purpose: 完成標準 WordPress URL 機制整合,確保 LINE Login 使用新的 login_init 架構,同時保留舊 REST API 向後相容（標記 deprecated）

Output: 更新後的 Plugin 類別、標記 deprecated 的 Login_API
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS-v0.2.md
@.planning/phases/09-標準-wordpress-url-機制/09-RESEARCH.md
@.planning/phases/09-標準-wordpress-url-機制/09-01-SUMMARY.md
@includes/class-plugin.php
@includes/api/class-login-api.php
@includes/handlers/class-login-handler.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 整合 Login_Handler 到 Plugin 主流程</name>
  <files>includes/class-plugin.php</files>
  <action>
更新 Plugin 類別,載入並註冊 Login_Handler hooks。

修改位置：

1. `loadDependencies()` 方法 - 新增 include
   在 `// 載入 LINE Login 相關服務` 區塊後新增：
   ```php
   // 載入 Exception 類別
   include_once BuygoLineNotify_PLUGIN_DIR . 'includes/exceptions/class-nsl-continue-page-render-exception.php';

   // 載入 Handler 類別
   include_once BuygoLineNotify_PLUGIN_DIR . 'includes/handlers/class-login-handler.php';
   ```

2. `onInit()` 方法 - 註冊 Login_Handler hooks
   在現有 hooks 註冊後（例如 LoginButtonService 之後）新增：
   ```php
   // 註冊 LINE Login Handler（標準 WordPress URL 機制）
   \BuygoLineNotify\Handlers\Login_Handler::register_hooks();
   ```

注意事項：
- Login_Handler::register_hooks() 必須在 `init` hook 內呼叫（已在 onInit 中）
- 舊的 REST API 註冊暫時保留（向後相容）,但 Login_Handler 會優先處理 wp-login.php 入口
- include 順序：先載入 Exception,再載入 Handler（Handler 依賴 Exception）
  </action>
  <verify>grep -n "Login_Handler::register_hooks" includes/class-plugin.php && grep -n "class-login-handler.php" includes/class-plugin.php</verify>
  <done>Plugin 類別已載入 Login_Handler 並呼叫 register_hooks()</done>
</task>

<task type="auto">
  <name>Task 2: 標記 Login_API 為 deprecated</name>
  <files>includes/api/class-login-api.php</files>
  <action>
標記 Login_API REST 端點為 deprecated,保留向後相容但發出警告。

修改內容：

1. 類別 docblock 新增 @deprecated 標記
   ```php
   /**
    * Login API
    *
    * REST API endpoints for LINE Login OAuth 2.0 flow
    *
    * @deprecated 2.0.0 Use standard WordPress URL (wp-login.php?loginSocial=buygo-line) instead.
    *             REST API endpoints are kept for backward compatibility but will be removed in v3.0.
    *
    * @package BuygoLineNotify
    */
   ```

2. register_routes() 方法新增 deprecated 註解
   ```php
   /**
    * Register REST API routes
    *
    * @deprecated 2.0.0 Use Login_Handler::register_hooks() instead.
    */
   ```

3. authorize() 方法新增 deprecated 標記和 header
   ```php
   /**
    * GET /login/authorize
    *
    * @deprecated 2.0.0 Use wp-login.php?loginSocial=buygo-line&redirect_to=URL instead.
    */
   public function authorize(\WP_REST_Request $request) {
       // 發出 deprecated 警告 header
       header('X-BuyGo-Deprecated: Use wp-login.php?loginSocial=buygo-line instead');

       // 記錄 deprecated 呼叫
       Logger::get_instance()->log('warning', [
           'message' => 'Deprecated REST API /login/authorize called',
           'recommendation' => 'Use wp-login.php?loginSocial=buygo-line instead',
       ]);

       // 原有邏輯保持不變...
   }
   ```

4. callback() 方法新增 deprecated 標記和 header
   ```php
   /**
    * GET /login/callback
    *
    * @deprecated 2.0.0 OAuth callback now handled by Login_Handler via login_init hook.
    */
   public function callback(\WP_REST_Request $request) {
       // 發出 deprecated 警告 header
       header('X-BuyGo-Deprecated: OAuth callback now uses wp-login.php entry point');

       // 記錄 deprecated 呼叫
       Logger::get_instance()->log('warning', [
           'message' => 'Deprecated REST API /login/callback called',
           'recommendation' => 'Configure LINE Developers Console redirect_uri to wp-login.php?loginSocial=buygo-line',
       ]);

       // 原有邏輯保持不變...
   }
   ```

5. bind() 方法新增 deprecated 標記
   ```php
   /**
    * POST /login/bind
    *
    * @deprecated 2.0.0 Bind flow will use standard WordPress URL in future versions.
    */
   ```

注意：
- 保留所有原有邏輯（向後相容）
- 透過 header 和 log 提醒開發者遷移
- 不在 callback 中斷流程（避免破壞現有整合）
  </action>
  <verify>grep -c "@deprecated 2.0.0" includes/api/class-login-api.php | xargs test 4 -le && grep -n "X-BuyGo-Deprecated" includes/api/class-login-api.php</verify>
  <done>Login_API 類別和方法已標記 @deprecated,authorize() 和 callback() 會發出 deprecated header</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
完成 Phase 9 標準 WordPress URL 機制整合：
1. NSLContinuePageRenderException 例外類別
2. Login_Handler 類別（login_init hook 處理）
3. LoginService callback URL 更新
4. Plugin 整合 Login_Handler
5. Login_API 標記 deprecated
  </what-built>
  <how-to-verify>
**測試標準 WordPress URL 機制：**

1. **更新 LINE Developers Console 設定**
   - 前往 LINE Developers Console > Login Channel > LINE Login settings
   - 將 Callback URL 更新為: `https://test.buygo.me/wp-login.php?loginSocial=buygo-line`
   - 注意：必須更新此設定,否則 OAuth callback 會失敗

2. **測試 LINE Login 流程（已綁定用戶）**
   - 確保已有綁定 LINE 的 WordPress 用戶
   - 訪問: `https://test.buygo.me/wp-login.php?loginSocial=buygo-line`
   - 預期: 導向 LINE 授權頁面
   - 在 LINE 授權後,預期: 自動登入並導向首頁

3. **測試未綁定用戶流程**
   - 使用未綁定的 LINE 帳號
   - 訪問: `https://test.buygo.me/wp-login.php?loginSocial=buygo-line`
   - 預期: LINE 授權後,顯示錯誤頁面（Phase 10 會實作註冊流程頁面）
   - 目前預期行為: wp_die() 或繼續渲染 wp-login.php（因為 NSLContinuePageRenderException 被捕捉但尚未處理）

4. **測試舊 REST API（向後相容）**
   - 訪問: `https://test.buygo.me/wp-json/buygo-line-notify/v1/login/authorize?redirect_url=https://test.buygo.me`
   - 預期: 仍可使用,但 response header 包含 `X-BuyGo-Deprecated`

5. **驗證 Log 記錄**
   - 若呼叫舊 REST API,應在 log 中看到 deprecated 警告

**如果測試通過,輸入 "approved"**
**如果有問題,請描述具體的錯誤訊息或行為**
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
完成後執行以下驗證：

1. Plugin 整合驗證
```bash
# 確認 Login_Handler include 和 register_hooks 呼叫
grep -n "class-login-handler.php" includes/class-plugin.php
grep -n "Login_Handler::register_hooks" includes/class-plugin.php
grep -n "class-nsl-continue-page-render-exception.php" includes/class-plugin.php
```

2. Login_API deprecated 驗證
```bash
# 確認 deprecated 標記
grep -c "@deprecated" includes/api/class-login-api.php
# 確認 deprecated header
grep -n "X-BuyGo-Deprecated" includes/api/class-login-api.php
```

3. PHP 語法驗證
```bash
php -l includes/class-plugin.php
php -l includes/api/class-login-api.php
```

4. 整體流程驗證
```bash
# 確認 login_init hook 在 Plugin 中註冊
grep -A5 "onInit" includes/class-plugin.php | grep -E "Login_Handler|login_init"
```
</verification>

<success_criteria>
1. Login_Handler 已整合到 Plugin,login_init hook 正確註冊
2. Login_API 所有端點已標記 @deprecated
3. authorize() 和 callback() 發出 X-BuyGo-Deprecated header
4. 用戶通過 wp-login.php?loginSocial=buygo-line 可成功啟動 LINE OAuth
5. 已綁定用戶可成功登入（checkpoint 驗證）
</success_criteria>

<output>
After completion, create `.planning/phases/09-標準-wordpress-url-機制/09-02-SUMMARY.md`
</output>
