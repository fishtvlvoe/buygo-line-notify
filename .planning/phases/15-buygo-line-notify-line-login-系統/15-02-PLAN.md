---
phase: 15-buygo-line-notify-line-login-系統
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - buygo-line-notify/includes/services/class-user-service.php
  - buygo-line-notify/includes/services/class-line-user-service.php
autonomous: true

must_haves:
  truths:
    - "未登入用戶透過 LINE Login 可建立新 WordPress 帳號"
    - "已登入用戶可綁定 LINE 帳號到現有 WordPress 帳號"
    - "LINE UID 同時寫入 user_meta 和 bindings 表（混合儲存）"
    - "WordPress 用戶資料包含 LINE 的 displayName 和 pictureUrl"
  artifacts:
    - path: "buygo-line-notify/includes/services/class-user-service.php"
      provides: "WordPress 用戶建立和 LINE 帳號綁定邏輯"
      min_lines: 120
    - path: "buygo-line-notify/includes/services/class-line-user-service.php"
      provides: "LINE 用戶查詢和綁定 API（已存在，需擴展）"
  key_links:
    - from: "class-user-service.php"
      to: "LineUserService::bind_line_account()"
      via: "建立/綁定用戶後寫入 LINE binding"
      pattern: "LineUserService::bind_line_account"
    - from: "class-user-service.php"
      to: "wp_create_user()"
      via: "建立新 WordPress 用戶"
      pattern: "wp_create_user"
---

<objective>
實作 WordPress 用戶建立與 LINE 帳號綁定邏輯

Purpose: LINE Login 的最終目的是讓用戶能以 LINE 帳號登入或綁定 WordPress。需要處理兩種情境：未登入用戶建立新帳號、已登入用戶綁定 LINE。

Output:
- UserService 服務（用戶建立/綁定核心邏輯）
- 擴展 LineUserService（新增根據 LINE UID 查詢 WordPress User ID 的方法）
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/fishtv/Development/buygo-line-notify/.planning/PROJECT.md
@/Users/fishtv/Development/buygo-line-notify/.planning/phases/15-buygo-line-notify-line-login-系統/15-RESEARCH.md

# 15-01 完成的檔案
# StateManager 和 LoginService 已建立

# 現有 codebase 參考
@/Users/fishtv/Development/buygo-line-notify/includes/services/class-line-user-service.php
@/Users/fishtv/Development/buygo-line-notify/includes/services/class-image-uploader.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 UserService（用戶建立與綁定）</name>
  <files>buygo-line-notify/includes/services/class-user-service.php</files>
  <action>
建立 `includes/services/class-user-service.php`，實作 WordPress 用戶建立與 LINE 綁定：

**Class: BuygoLineNotify\Services\UserService**

**方法：**

1. `create_or_bind_user(array $line_profile): int`
   - 從 profile 取得 `userId`、`displayName`、`pictureUrl`
   - **Step 1**: 檢查 LINE UID 是否已綁定
     ```php
     $existing_user_id = LineUserService::get_user_id_by_line_uid($line_profile['userId']);
     if ($existing_user_id) {
         // 已綁定：更新 profile 並返回 user_id
         self::update_line_profile($existing_user_id, $line_profile);
         return $existing_user_id;
     }
     ```
   - **Step 2**: 檢查當前是否已登入 WordPress
     ```php
     $current_user_id = get_current_user_id();
     if ($current_user_id > 0) {
         // 已登入：綁定到當前用戶（LOGIN-06）
         self::bind_line_to_user($current_user_id, $line_profile);
         return $current_user_id;
     }
     ```
   - **Step 3**: 建立新 WordPress 用戶（LOGIN-05）
     ```php
     return self::create_wordpress_user($line_profile);
     ```

2. `private create_wordpress_user(array $line_profile): int`
   - 產生 username: `'line_' . substr($line_profile['userId'], 0, 20)`
   - 檢查 username 是否存在，如存在則加數字後綴
   - 產生 email:
     - 如果 profile 有 email（scope 授權）則使用
     - 否則使用 `{username}@line.local`（假 email）
   - 呼叫 `wp_create_user($username, wp_generate_password(32), $email)`
   - 檢查 WP_Error
   - 更新用戶資料：
     ```php
     wp_update_user([
         'ID'           => $user_id,
         'display_name' => $line_profile['displayName'],
         'nickname'     => $line_profile['displayName'],
     ]);
     ```
   - 下載並設定頭像（如果有 pictureUrl）
   - 綁定 LINE 帳號
   - 回傳 user_id

3. `private bind_line_to_user(int $user_id, array $line_profile): void`
   - 呼叫 `LineUserService::bind_line_account()` 進行混合儲存（LOGIN-07）
   - 下載並設定頭像（如果有 pictureUrl 且用戶沒有頭像）

4. `private update_line_profile(int $user_id, array $line_profile): void`
   - 更新 bindings 表的 display_name 和 picture_url
   - 更新 user_meta

5. `private set_user_avatar(int $user_id, string $picture_url): void`
   - 使用 ImageUploader service 下載 LINE 頭像
   - 儲存 attachment_id 到 user_meta: `buygo_line_avatar_attachment_id`
   - **注意**: ImageUploader 可能沒有 download_and_upload_from_url 方法，需要檢查。如果沒有，使用 `media_sideload_image()` 或簡化為僅儲存 URL

6. `static is_line_registered_user(int $user_id): bool`
   - 檢查用戶是否透過 LINE 建立（username 以 'line_' 開頭）

**Requirements 覆蓋：**
- LOGIN-05: 從 LINE Profile 建立 WordPress 用戶
- LOGIN-06: 已有用戶可綁定 LINE
- LOGIN-07: 混合儲存 LINE UID（透過 LineUserService）

**注意事項：**
- 使用 `wp_generate_password(32)` 產生隨機密碼（用戶無法用密碼登入，只能用 LINE）
- email 允許假值 `@line.local`（WordPress 不強制唯一 email）
- 頭像下載失敗不應阻擋用戶建立流程
  </action>
  <verify>
驗證檔案存在且語法正確：
```bash
php -l buygo-line-notify/includes/services/class-user-service.php
```
  </verify>
  <done>
UserService 類別已建立，實作 create_or_bind_user、create_wordpress_user、bind_line_to_user、update_line_profile、set_user_avatar 方法。支援未登入建立新帳號和已登入綁定 LINE。
  </done>
</task>

<task type="auto">
  <name>Task 2: 擴展 LineUserService（新增 get_user_id_by_line_uid）</name>
  <files>buygo-line-notify/includes/services/class-line-user-service.php</files>
  <action>
擴展現有的 `LineUserService`，新增根據 LINE UID 查詢 WordPress User ID 的方法：

**新增方法：**

1. `get_user_id_by_line_uid(string $line_uid): ?int`
   - 查詢 bindings 表：
     ```php
     $user_id = $wpdb->get_var($wpdb->prepare(
         "SELECT user_id FROM {$table_name} WHERE line_uid = %s AND status = 'active'",
         $line_uid
     ));
     ```
   - 回傳 user_id（int）或 null

2. `update_profile(int $user_id, array $profile): bool`
   - 更新 bindings 表的 display_name 和 picture_url
   - 同步更新 user_meta
   - 用於用戶再次 LINE Login 時更新最新的 LINE Profile

**修改 bind_line_account：**
- 確保 profile 參數支援 `userId`、`displayName`、`pictureUrl` 三種 key（LINE API 回傳格式）
- 現有程式碼使用 `$profile['displayName']`，需確認相容

**注意事項：**
- 保持現有方法不變（避免破壞相容性）
- 新方法放在 class 最下方
  </action>
  <verify>
驗證檔案語法正確：
```bash
php -l buygo-line-notify/includes/services/class-line-user-service.php
```
  </verify>
  <done>
LineUserService 已擴展，新增 get_user_id_by_line_uid 和 update_profile 方法，支援根據 LINE UID 查詢 WordPress User ID 和更新 LINE Profile。
  </done>
</task>

</tasks>

<verification>
1. 兩個檔案都通過 PHP 語法檢查
2. UserService 實作完整的用戶建立/綁定流程
3. LineUserService 新增 get_user_id_by_line_uid 方法
4. 用戶建立時使用 wp_create_user 和 wp_update_user
5. 綁定時呼叫 LineUserService::bind_line_account（混合儲存）
</verification>

<success_criteria>
- UserService::create_or_bind_user() 正確處理三種情境：已綁定、已登入、未登入
- 新用戶 username 以 'line_' 開頭
- LINE Profile 的 displayName 設為 WordPress 的 display_name 和 nickname
- 混合儲存：user_meta + bindings 表同時寫入
</success_criteria>

<output>
完成後建立 `.planning/phases/15-buygo-line-notify-line-login-系統/15-02-SUMMARY.md`
</output>
