---
phase: 15-buygo-line-notify-line-login-系統
plan: 04
type: execute
wave: 4
depends_on: ["15-03"]
files_modified:
  - buygo-line-notify/includes/admin/views/settings-page.php
autonomous: false

must_haves:
  truths:
    - "管理員可在後台看到 LINE Login Callback URL（唯讀）"
    - "管理員可複製 Callback URL 貼到 LINE Developers Console"
    - "LINE Console 驗證成功（callback URL 正確設定）"
  artifacts:
    - path: "buygo-line-notify/includes/admin/views/settings-page.php"
      provides: "後台設定頁面（需擴展顯示 Callback URL）"
  key_links:
    - from: "settings-page.php"
      to: "rest_url('buygo-line-notify/v1/login/callback')"
      via: "顯示 Callback URL"
      pattern: "rest_url.*login/callback"
---

<objective>
在後台設定頁面顯示 LINE Login Callback URL 並驗證完整流程

Purpose: LINE Login 需要在 LINE Developers Console 設定正確的 Callback URL，管理員需要能從 WordPress 後台複製這個 URL。驗證整個 LINE Login 流程可正常運作。

Output:
- 修改設定頁面顯示 Callback URL
- checkpoint 驗證完整 LINE Login 流程
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/fishtv/Development/buygo-line-notify/.planning/PROJECT.md
@/Users/fishtv/Development/buygo-line-notify/.planning/phases/15-buygo-line-notify-line-login-系統/15-RESEARCH.md

# 15-01 到 15-03 已完成
# StateManager、LoginService、UserService、Login_API 已建立並整合

# 現有設定頁面
@/Users/fishtv/Development/buygo-line-notify/includes/admin/views/settings-page.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 修改設定頁面顯示 Callback URL</name>
  <files>buygo-line-notify/includes/admin/views/settings-page.php</files>
  <action>
修改 `includes/admin/views/settings-page.php`，在現有的 Webhook URL 區塊下方新增 LINE Login Callback URL：

**新增 HTML 區塊（在 Webhook URL 區塊後）：**

```php
<!-- LINE Login 區域 -->
<tr>
    <th scope="row" colspan="2">
        <h3 style="margin-bottom: 0;"><?php esc_html_e('LINE Login 設定', 'buygo-line-notify'); ?></h3>
    </th>
</tr>
<tr>
    <th scope="row">
        <label><?php esc_html_e('Callback URL', 'buygo-line-notify'); ?></label>
    </th>
    <td>
        <?php
        $callback_url = rest_url('buygo-line-notify/v1/login/callback');
        ?>
        <div class="buygo-url-copy-container">
            <input
                type="text"
                readonly
                value="<?php echo esc_url($callback_url); ?>"
                class="regular-text buygo-readonly-url"
                id="line-login-callback-url"
            >
            <button
                type="button"
                class="button button-secondary buygo-copy-btn"
                onclick="navigator.clipboard.writeText('<?php echo esc_js($callback_url); ?>').then(() => { alert('已複製到剪貼簿'); });"
            >
                <?php esc_html_e('複製', 'buygo-line-notify'); ?>
            </button>
        </div>
        <p class="description">
            <?php esc_html_e('請將此 URL 設定到 LINE Developers Console → LINE Login → Callback URL', 'buygo-line-notify'); ?>
        </p>
    </td>
</tr>

<!-- LINE Login 測試連結 -->
<tr>
    <th scope="row">
        <label><?php esc_html_e('測試 LINE Login', 'buygo-line-notify'); ?></label>
    </th>
    <td>
        <?php
        $authorize_url = rest_url('buygo-line-notify/v1/login/authorize');
        $login_channel_id = \BuygoLineNotify\Services\SettingsService::get('login_channel_id');
        ?>
        <?php if (!empty($login_channel_id)): ?>
            <a
                href="<?php echo esc_url($authorize_url); ?>"
                class="button button-secondary"
                target="_blank"
            >
                <?php esc_html_e('測試 LINE Login', 'buygo-line-notify'); ?>
            </a>
            <p class="description">
                <?php esc_html_e('點擊後會在新視窗開啟 LINE 授權頁面', 'buygo-line-notify'); ?>
            </p>
        <?php else: ?>
            <p class="description" style="color: #d63638;">
                <?php esc_html_e('請先設定 LINE Login Channel ID', 'buygo-line-notify'); ?>
            </p>
        <?php endif; ?>
    </td>
</tr>
```

**CSS 樣式（如果頁面沒有，在 `<style>` 標籤中新增）：**
```css
.buygo-url-copy-container {
    display: flex;
    gap: 8px;
    align-items: center;
}
.buygo-readonly-url {
    background-color: #f0f0f1;
}
```

**注意事項：**
- 檢查現有頁面結構，確保新區塊放在適當位置
- 使用 WordPress 的 esc_* 函數處理輸出
- 複製按鈕使用 navigator.clipboard.writeText（現代瀏覽器都支援）
  </action>
  <verify>
驗證檔案語法正確：
```bash
php -l buygo-line-notify/includes/admin/views/settings-page.php
```
  </verify>
  <done>
設定頁面已修改，顯示 LINE Login Callback URL（唯讀）和複製按鈕，以及測試 LINE Login 的連結（僅在 Channel ID 已設定時顯示）。
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
完整的 LINE Login 系統，包含：
1. StateManager 服務（Session + Transient + Option 三層儲存）
2. LoginService 服務（OAuth 流程：authorize → callback → token exchange → profile）
3. UserService 服務（WordPress 用戶建立/綁定）
4. Login_API（REST endpoints：authorize、callback、bind）
5. 設定頁面顯示 Callback URL
  </what-built>
  <how-to-verify>
**準備工作（如尚未完成）：**
1. 到 LINE Developers Console (https://developers.line.biz/console/)
2. 建立或選擇 LINE Login Channel
3. 在 WordPress 後台「LINE 串接通知 → 設定」填入：
   - LINE Login Channel ID
   - LINE Login Channel Secret
4. 在 LINE Login Channel 的 Callback URL 設定中，加入 WordPress 顯示的 Callback URL

**驗證步驟：**
1. 訪問 WordPress 後台「LINE 串接通知 → 設定」
2. 確認 LINE Login 區域顯示 Callback URL，可複製
3. 確認測試連結可見（因為已設定 Channel ID）
4. 點擊「測試 LINE Login」按鈕
5. 應該重導向到 LINE 授權頁面
6. 使用 LINE 帳號授權
7. 應該自動返回 WordPress 並已登入
8. 檢查 WordPress 用戶列表，應有新建立的 line_ 開頭用戶（如果是新用戶）

**預期結果：**
- LINE 授權頁面正確顯示
- 授權後自動建立 WordPress 用戶或綁定現有用戶
- 用戶已登入 WordPress（右上角顯示用戶名稱）
- 用戶被重導向到首頁
  </how-to-verify>
  <resume-signal>
輸入 "approved" 如果 LINE Login 流程完整可用。
或描述遇到的問題（例如：State 驗證失敗、用戶建立失敗、未登入等）
  </resume-signal>
</task>

</tasks>

<verification>
1. 設定頁面通過 PHP 語法檢查
2. Callback URL 正確顯示在後台
3. LINE Developers Console 設定 Callback URL
4. 完整 LINE Login 流程可正常運作
</verification>

<success_criteria>
- 後台設定頁面顯示 LINE Login Callback URL
- 複製按鈕可正常運作
- 測試連結可觸發 LINE Login 流程
- 完整流程：authorize → LINE 授權 → callback → 用戶建立/綁定 → WordPress 登入 → 重導向
</success_criteria>

<output>
完成後建立 `.planning/phases/15-buygo-line-notify-line-login-系統/15-04-SUMMARY.md`
</output>
