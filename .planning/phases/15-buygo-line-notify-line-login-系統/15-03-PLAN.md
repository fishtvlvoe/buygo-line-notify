---
phase: 15-buygo-line-notify-line-login-系統
plan: 03
type: execute
wave: 3
depends_on: ["15-01", "15-02"]
files_modified:
  - buygo-line-notify/includes/api/class-login-api.php
  - buygo-line-notify/includes/class-plugin.php
autonomous: true

must_haves:
  truths:
    - "REST API endpoint /wp-json/buygo-line-notify/v1/login/authorize 可觸發 LINE Login"
    - "REST API endpoint /wp-json/buygo-line-notify/v1/login/callback 接收 OAuth 回調"
    - "REST API endpoint /wp-json/buygo-line-notify/v1/login/bind 讓已登入用戶綁定 LINE"
    - "OAuth callback 後用戶已登入 WordPress（wp_set_auth_cookie 生效）"
    - "登入後用戶被重導向到原始頁面或首頁"
  artifacts:
    - path: "buygo-line-notify/includes/api/class-login-api.php"
      provides: "LINE Login REST API endpoints"
      min_lines: 100
      exports: ["register_routes", "handle_authorize", "handle_callback", "handle_bind"]
    - path: "buygo-line-notify/includes/class-plugin.php"
      provides: "外掛主檔案（需擴展載入 Login API）"
  key_links:
    - from: "class-login-api.php"
      to: "LoginService::start_login()"
      via: "authorize endpoint 呼叫"
      pattern: "start_login"
    - from: "class-login-api.php"
      to: "LoginService::handle_callback()"
      via: "callback endpoint 呼叫"
      pattern: "handle_callback"
    - from: "class-login-api.php"
      to: "UserService::create_or_bind_user()"
      via: "callback 取得 profile 後建立/綁定用戶"
      pattern: "create_or_bind_user"
    - from: "class-plugin.php"
      to: "Login_API::register_routes()"
      via: "rest_api_init hook"
      pattern: "Login_API.*register_routes"
---

<objective>
建立 LINE Login REST API Endpoints 並整合到外掛主流程

Purpose: 將 LoginService 和 UserService 透過 REST API 暴露出來，讓前端可以觸發 LINE Login 流程。回調處理需要設定 WordPress 認證 Cookie 並重導向。

Output:
- Login_API 類別（authorize、callback、bind 三個 endpoints）
- 修改 Plugin 類別載入 Login API
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/fishtv/Development/buygo-line-notify/.planning/PROJECT.md
@/Users/fishtv/Development/buygo-line-notify/.planning/phases/15-buygo-line-notify-line-login-系統/15-RESEARCH.md

# 15-01 和 15-02 完成的檔案
# StateManager、LoginService、UserService 已建立

# 現有 codebase 參考（API 模式）
@/Users/fishtv/Development/buygo-line-notify/includes/api/class-webhook-api.php
@/Users/fishtv/Development/buygo-line-notify/includes/class-plugin.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 Login_API（REST Endpoints）</name>
  <files>buygo-line-notify/includes/api/class-login-api.php</files>
  <action>
建立 `includes/api/class-login-api.php`，參考現有的 Webhook_API 架構：

**Class: BuygoLineNotify\Api\Login_API**

**屬性：**
- `private LoginService $login_service`
- `private UserService $user_service`
- `private Logger $logger`

**方法：**

1. `__construct()`
   - 初始化 LoginService、UserService、Logger

2. `register_routes(): void`
   - **authorize endpoint**（開始 LINE Login）
     ```php
     register_rest_route(
         'buygo-line-notify/v1',
         '/login/authorize',
         [
             'methods'             => 'GET',
             'callback'            => [$this, 'handle_authorize'],
             'permission_callback' => '__return_true', // 公開
         ]
     );
     ```
   - **callback endpoint**（OAuth 回調）
     ```php
     register_rest_route(
         'buygo-line-notify/v1',
         '/login/callback',
         [
             'methods'             => 'GET',
             'callback'            => [$this, 'handle_callback'],
             'permission_callback' => '__return_true', // 公開（LINE 回調）
         ]
     );
     ```
   - **bind endpoint**（已登入用戶綁定）
     ```php
     register_rest_route(
         'buygo-line-notify/v1',
         '/login/bind',
         [
             'methods'             => 'GET',
             'callback'            => [$this, 'handle_bind'],
             'permission_callback' => 'is_user_logged_in', // 需登入
         ]
     );
     ```

3. `handle_authorize(\WP_REST_Request $request): void`
   - 取得 return_url 參數：`$request->get_param('return_url')`
   - 呼叫 `$this->login_service->start_login($return_url)`
   - 注意：start_login 會 exit，這裡不會返回

4. `handle_callback(\WP_REST_Request $request): mixed`
   - 呼叫 `$result = $this->login_service->handle_callback($request)`
   - 如果是 WP_Error，重導向到錯誤頁面：
     ```php
     if (is_wp_error($result)) {
         wp_redirect(add_query_arg([
             'line_login' => 'error',
             'message'    => urlencode($result->get_error_message()),
         ], wp_login_url()));
         exit;
     }
     ```
   - 取得 profile: `$profile = $result['profile']`
   - 建立/綁定用戶: `$user_id = $this->user_service->create_or_bind_user($profile)`
   - 設定 WordPress 認證 Cookie（LOGIN-04: SameSite 設定）：
     ```php
     // WordPress 5.2+ wp_set_auth_cookie 會正確處理 SameSite
     // 使用 apply_filters 確保 SameSite=Lax
     add_filter('auth_cookie_expiration', function($length) {
         return 14 * DAY_IN_SECONDS; // 14 天
     });
     wp_set_auth_cookie($user_id, true); // true = remember me
     wp_set_current_user($user_id);
     ```
   - 取得 return_url: `StateManager::get_return_url($request->get_param('state'))`
   - 重導向到 return_url 或 home_url()
   - 日誌記錄 login_success

5. `handle_bind(\WP_REST_Request $request): void`
   - 取得 return_url 參數
   - 呼叫 `$this->login_service->start_login($return_url)`
   - 注意：綁定流程和登入流程相同，只是 UserService::create_or_bind_user 會檢測當前登入狀態

**Requirements 覆蓋：**
- LOGIN-01: OAuth 流程（透過 authorize/callback endpoints）
- LOGIN-04: Cookie SameSite 設定（wp_set_auth_cookie 預設 Lax）

**注意事項：**
- authorize 和 bind 都是 GET 請求（方便直接連結）
- callback 需處理 error 參數（用戶取消）
- 使用 exit 結束重導向（避免繼續執行）
  </action>
  <verify>
驗證檔案存在且語法正確：
```bash
php -l buygo-line-notify/includes/api/class-login-api.php
```
  </verify>
  <done>
Login_API 類別已建立，包含 register_routes、handle_authorize、handle_callback、handle_bind 四個方法。實作 /login/authorize、/login/callback、/login/bind 三個 REST endpoints。
  </done>
</task>

<task type="auto">
  <name>Task 2: 整合 Login API 到 Plugin 主流程</name>
  <files>buygo-line-notify/includes/class-plugin.php</files>
  <action>
修改 `includes/class-plugin.php`，載入並註冊 Login API：

**修改 loadDependencies()：**
在現有的載入區塊加入：
```php
// 載入 Login 相關服務
include_once BuygoLineNotify_PLUGIN_DIR . 'includes/services/class-state-manager.php';
include_once BuygoLineNotify_PLUGIN_DIR . 'includes/services/class-login-service.php';
include_once BuygoLineNotify_PLUGIN_DIR . 'includes/services/class-user-service.php';

// 載入 Login API
include_once BuygoLineNotify_PLUGIN_DIR . 'includes/api/class-login-api.php';
```

**修改 onInit()：**
在現有的 rest_api_init hook 內加入 Login API 註冊：
```php
\add_action('rest_api_init', function () {
    // 現有 Webhook API
    $webhook_api = new \BuygoLineNotify\Api\Webhook_API();
    $webhook_api->register_routes();

    // 新增 Login API
    $login_api = new \BuygoLineNotify\Api\Login_API();
    $login_api->register_routes();
});
```

**注意事項：**
- 保持現有程式碼不變，只新增載入和註冊
- services 載入順序：StateManager → LoginService → UserService（依賴關係）
  </action>
  <verify>
驗證檔案語法正確且 API 可註冊：
```bash
php -l buygo-line-notify/includes/class-plugin.php
```
  </verify>
  <done>
Plugin 類別已修改，載入 StateManager、LoginService、UserService、Login_API，並在 rest_api_init 註冊 Login API routes。
  </done>
</task>

</tasks>

<verification>
1. 兩個檔案都通過 PHP 語法檢查
2. Login_API 註冊三個 REST endpoints
3. Plugin 載入所有 Login 相關 services 和 API
4. callback endpoint 正確設定 WordPress 認證 Cookie
5. 重導向邏輯完整（成功/失敗/取消）
</verification>

<success_criteria>
- 訪問 `/wp-json/buygo-line-notify/v1/login/authorize` 會重導向到 LINE 授權頁面
- LINE 授權完成後回調到 `/wp-json/buygo-line-notify/v1/login/callback`
- callback 處理完成後用戶已登入 WordPress
- 用戶被重導向到原始頁面或首頁
</success_criteria>

<output>
完成後建立 `.planning/phases/15-buygo-line-notify-line-login-系統/15-03-SUMMARY.md`
</output>
