---
phase: 15-buygo-line-notify-line-login-系統
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - buygo-line-notify/includes/services/class-state-manager.php
  - buygo-line-notify/includes/services/class-login-service.php
autonomous: true

must_haves:
  truths:
    - "State 參數使用 32 字元隨機字串產生（bin2hex(random_bytes(16))）"
    - "State 同時儲存在 Session、Transient、Option 三層"
    - "State 驗證時依序檢查三層，任一層符合即通過"
    - "State 驗證後自動清理所有儲存"
  artifacts:
    - path: "buygo-line-notify/includes/services/class-state-manager.php"
      provides: "OAuth State 參數管理（產生、儲存、驗證、清理）"
      min_lines: 100
    - path: "buygo-line-notify/includes/services/class-login-service.php"
      provides: "LINE Login OAuth 流程核心邏輯"
      min_lines: 150
  key_links:
    - from: "class-login-service.php"
      to: "StateManager::generate()"
      via: "OAuth 授權開始時產生 State"
      pattern: "StateManager::generate"
    - from: "class-login-service.php"
      to: "StateManager::verify()"
      via: "OAuth callback 時驗證 State"
      pattern: "StateManager::verify"
---

<objective>
實作 OAuth State 參數管理和 LINE Login 核心流程

Purpose: State 是 OAuth 2.0 防止 CSRF 攻擊的關鍵機制，必須在授權和回調之間正確保存。LINE 瀏覽器可能清除 Cookie/Session，因此需要三層 fallback 確保各種環境都能運作。

Output:
- StateManager 服務（Session + Transient + Option 三層儲存）
- LoginService 核心流程（authorize URL 建立、token exchange、profile 查詢）
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/fishtv/Development/buygo-line-notify/.planning/PROJECT.md
@/Users/fishtv/Development/buygo-line-notify/.planning/ROADMAP.md
@/Users/fishtv/Development/buygo-line-notify/.planning/STATE.md
@/Users/fishtv/Development/buygo-line-notify/.planning/phases/15-buygo-line-notify-line-login-系統/15-RESEARCH.md

# 現有 codebase 參考
@/Users/fishtv/Development/buygo-line-notify/includes/services/class-settings-service.php
@/Users/fishtv/Development/buygo-line-notify/includes/services/class-line-user-service.php
@/Users/fishtv/Development/buygo-line-notify/includes/class-plugin.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 StateManager 服務（三層儲存策略）</name>
  <files>buygo-line-notify/includes/services/class-state-manager.php</files>
  <action>
建立 `includes/services/class-state-manager.php`，實作 OAuth State 參數管理：

**Class: BuygoLineNotify\Services\StateManager**

**方法：**

1. `generate(): string`
   - 使用 `bin2hex(random_bytes(16))` 產生 32 字元隨機 State
   - 呼叫 `store()` 儲存
   - 回傳 State 字串

2. `store(string $state): void`
   - **Session 儲存**: `$_SESSION['buygo_line_oauth_state'] = $state`（需先 `session_start()` 如果尚未啟動）
   - **Transient 儲存**: `set_transient('buygo_line_oauth_state_' . $state, true, 600)`（10 分鐘）
   - **Option 儲存**: `update_option('buygo_line_oauth_state_' . md5($state), ['state' => $state, 'created_at' => time()])`（最終備援）

3. `verify(string $state): bool`
   - 空值直接回傳 false
   - **Fallback 1**: 檢查 Session（使用 `hash_equals()` 比較，避免 timing attack）
   - **Fallback 2**: 檢查 Transient
   - **Fallback 3**: 檢查 Option（額外驗證 created_at 在 600 秒內）
   - 任一層通過後呼叫 `cleanup()` 並回傳 true
   - 全部失敗回傳 false

4. `cleanup(string $state): void`
   - 清理 Session: `unset($_SESSION['buygo_line_oauth_state'])`
   - 清理 Transient: `delete_transient('buygo_line_oauth_state_' . $state)`
   - 清理 Option: `delete_option('buygo_line_oauth_state_' . md5($state))`

5. `store_return_url(string $state, string $url): void`
   - 儲存登入後返回 URL（同樣三層）
   - Transient key: `buygo_line_return_url_` . $state

6. `get_return_url(string $state): ?string`
   - 取得返回 URL（依序檢查三層）

**注意事項：**
- Session 需使用 `if (!session_id()) { session_start(); }` 安全啟動
- 使用 `hash_equals()` 比較 State（防止 timing attack）
- 遵循現有 codebase 的 namespace 和 coding style
  </action>
  <verify>
驗證檔案存在且語法正確：
```bash
php -l buygo-line-notify/includes/services/class-state-manager.php
```
  </verify>
  <done>
StateManager 類別已建立，包含 generate、store、verify、cleanup、store_return_url、get_return_url 六個方法，實作 Session + Transient + Option 三層儲存策略。
  </done>
</task>

<task type="auto">
  <name>Task 2: 建立 LoginService 核心流程</name>
  <files>buygo-line-notify/includes/services/class-login-service.php</files>
  <action>
建立 `includes/services/class-login-service.php`，實作 LINE Login OAuth 核心邏輯：

**Class: BuygoLineNotify\Services\LoginService**

**屬性：**
- `private Logger $logger` - 日誌記錄

**方法：**

1. `__construct()`
   - 初始化 Logger

2. `start_login(?string $return_url = null): void`
   - 產生 State: `StateManager::generate()`
   - 如有 return_url，儲存: `StateManager::store_return_url($state, $return_url)`
   - 建立授權 URL 參數：
     ```php
     $params = [
         'response_type' => 'code',
         'client_id'     => SettingsService::get('login_channel_id'),
         'redirect_uri'  => rest_url('buygo-line-notify/v1/login/callback'),
         'state'         => $state,
         'scope'         => 'profile openid email',
         'bot_prompt'    => 'aggressive', // LOGIN-08: 強制引導加入官方帳號
     ];
     ```
   - 日誌記錄 oauth_start
   - 重導向到 `https://access.line.me/oauth2/v2.1/authorize?` . http_build_query($params)
   - 呼叫 `exit;`

3. `handle_callback(\WP_REST_Request $request): mixed`
   - 檢查 error 參數（用戶取消授權）：
     - 如有 error，日誌記錄 oauth_cancelled
     - 重導向到 `wp_login_url()` 並帶 `line_login=cancelled` 參數
   - 取得 code 和 state 參數
   - 驗證 State: `StateManager::verify($state)`
     - 失敗回傳 `WP_Error('invalid_state', 'Invalid state parameter', ['status' => 400])`
   - Token Exchange: `$token_data = $this->exchange_token($code)`
   - 取得 Profile: `$profile = $this->get_line_profile($token_data['access_token'])`
   - 回傳 profile 和 token_data（讓 API 層處理用戶建立/綁定）
   - 例外處理：catch Exception，日誌記錄 oauth_error，回傳 WP_Error

4. `private exchange_token(string $code): array`
   - POST 到 `https://api.line.me/oauth2/v2.1/token`
   - 參數：grant_type=authorization_code, code, redirect_uri, client_id, client_secret
   - 使用 `wp_remote_post()`，timeout=10
   - 檢查 WP_Error
   - 解析 JSON 回應
   - 檢查 LINE API error
   - 回傳 access_token, refresh_token, id_token, expires_in, scope

5. `private get_line_profile(string $access_token): array`
   - GET `https://api.line.me/v2/profile`
   - Header: `Authorization: Bearer {access_token}`
   - 使用 `wp_remote_get()`，timeout=10
   - 檢查 WP_Error
   - 解析 JSON 回應
   - 回傳 userId, displayName, pictureUrl, statusMessage

**Requirements 覆蓋：**
- LOGIN-01: OAuth 流程（authorize → callback → token exchange）
- LOGIN-08: bot_prompt=aggressive

**注意事項：**
- redirect_uri 必須使用 `rest_url('buygo-line-notify/v1/login/callback')` 確保一致性
- 使用 SettingsService 讀取 login_channel_id 和 login_channel_secret
- 日誌使用 Logger::log() 方法
  </action>
  <verify>
驗證檔案存在且語法正確：
```bash
php -l buygo-line-notify/includes/services/class-login-service.php
```
  </verify>
  <done>
LoginService 類別已建立，包含 start_login、handle_callback、exchange_token、get_line_profile 方法，實作完整 OAuth 流程。已加入 bot_prompt=aggressive 強制引導加入官方帳號。
  </done>
</task>

</tasks>

<verification>
1. 兩個檔案都通過 PHP 語法檢查
2. StateManager 實作三層儲存策略（Session + Transient + Option）
3. LoginService 使用 StateManager 進行 State 管理
4. LoginService 包含完整的 token exchange 和 profile 查詢邏輯
5. bot_prompt=aggressive 已加入授權 URL
</verification>

<success_criteria>
- StateManager 提供 generate、store、verify、cleanup 方法
- LoginService 提供 start_login、handle_callback 方法
- 使用 SettingsService 讀取 Channel ID/Secret
- 日誌記錄 OAuth 流程關鍵步驟
- 錯誤處理完善（用戶取消、API 錯誤、State 驗證失敗）
</success_criteria>

<output>
完成後建立 `.planning/phases/15-buygo-line-notify-line-login-系統/15-01-SUMMARY.md`
</output>
