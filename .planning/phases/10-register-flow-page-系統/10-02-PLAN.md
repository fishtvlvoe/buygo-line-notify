---
phase: 10-register-flow-page-系統
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - includes/handlers/class-login-handler.php
  - includes/services/class-line-user-service.php
autonomous: true

must_haves:
  truths:
    - "用戶提交註冊表單後成功建立 WordPress 帳號"
    - "LINE UID 正確寫入 wp_buygo_line_users 資料表"
    - "若 Email 已存在，執行 Auto-link（綁定現有帳號而非建立新用戶）"
    - "註冊成功後用戶被自動登入並導回原始頁面"
  artifacts:
    - path: "includes/handlers/class-login-handler.php"
      provides: "handle_register_submission() method"
      contains: "wp_insert_user"
      min_lines: 80
  key_links:
    - from: "Login_Handler::handle_register_submission()"
      to: "wp_insert_user()"
      via: "建立 WordPress 用戶"
      pattern: "wp_insert_user"
    - from: "Login_Handler::handle_register_submission()"
      to: "LineUserService::linkUser()"
      via: "綁定 LINE 帳號"
      pattern: "LineUserService::linkUser"
    - from: "Login_Handler::handle_login_init()"
      to: "handle_register_submission()"
      via: "檢查 action=buygo_line_register"
      pattern: "action.*buygo_line_register"
---

<objective>
實作表單提交處理：建立 WordPress 用戶、綁定 LINE、Auto-link 機制、自動登入

Purpose: 讓新用戶提交註冊表單後完成帳號建立、LINE 綁定、自動登入，並導回原始頁面
Output: handle_register_submission() 方法完整實作
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-register-flow-page-系統/10-RESEARCH.md

# Plan 10-01 建立的 shortcode 和 Transient 儲存
@includes/handlers/class-login-handler.php
@includes/services/class-line-user-service.php
@includes/services/class-user-service.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 實作 handle_register_submission() 方法</name>
  <files>includes/handlers/class-login-handler.php</files>
  <action>
在 `includes/handlers/class-login-handler.php` 中新增表單提交處理：

1. 修改 `handle_login_init()` 方法，在開頭新增表單提交檢查：
```php
public function handle_login_init(): void {
    // 檢查是否為 LINE Login 請求
    if (!isset($_GET['loginSocial']) || $_GET['loginSocial'] !== 'buygo-line') {
        return;
    }

    // 檢查是否為表單提交
    if (isset($_POST['action']) && $_POST['action'] === 'buygo_line_register') {
        $this->handle_register_submission();
        return;
    }

    // ... 原有的 authorize/callback 處理邏輯
}
```

2. 新增 `handle_register_submission()` 方法：
```php
/**
 * 處理註冊表單提交
 *
 * @return void
 */
private function handle_register_submission(): void {
    // 1. Nonce 驗證
    if (!isset($_POST['buygo_line_register_nonce']) ||
        !wp_verify_nonce($_POST['buygo_line_register_nonce'], 'buygo_line_register_action')) {
        wp_die('安全驗證失敗', 'Error', ['response' => 403]);
    }

    // 2. 取得並驗證 state
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $profile_key = self::PROFILE_TRANSIENT_PREFIX . $state;
    $data = get_transient($profile_key);

    if ($data === false) {
        Logger::get_instance()->log('error', [
            'message' => 'Registration: Profile transient not found',
            'state'   => $state,
        ]);
        wp_die('登入資料已過期，請重新嘗試 LINE 登入', 'Error', ['response' => 400]);
    }

    $profile = $data['profile'];
    $state_data = $data['state_data'];

    // 3. 取得表單資料
    $user_login = sanitize_user($_POST['user_login'] ?? '', true);
    $user_email = sanitize_email($_POST['user_email'] ?? '');
    $line_uid = sanitize_text_field($_POST['line_uid'] ?? '');

    // 4. 驗證 LINE UID 一致性（防篡改）
    if ($line_uid !== $profile['userId']) {
        Logger::get_instance()->log('error', [
            'message'       => 'Registration: LINE UID mismatch',
            'form_line_uid' => $line_uid,
            'profile_uid'   => $profile['userId'],
        ]);
        wp_die('LINE 帳號資訊不一致', 'Error', ['response' => 400]);
    }

    // 5. 驗證用戶名和 Email
    if (empty($user_login)) {
        wp_die('請填寫用戶名', 'Error', ['response' => 400]);
    }

    if (empty($user_email) || !is_email($user_email)) {
        wp_die('請輸入有效的 Email 地址', 'Error', ['response' => 400]);
    }

    // 6. 檢查 LINE UID 是否已綁定其他用戶
    $existing_line_user = LineUserService::getUserByLineUid($line_uid);
    if ($existing_line_user) {
        Logger::get_instance()->log('error', [
            'message'  => 'Registration: LINE UID already linked',
            'line_uid' => $line_uid,
            'user_id'  => $existing_line_user,
        ]);
        wp_die('此 LINE 帳號已綁定其他用戶', 'Error', ['response' => 400]);
    }

    // 7. 檢查 Email 是否已存在（Auto-link）
    $existing_user_id = email_exists($user_email);
    if ($existing_user_id) {
        $this->handle_auto_link($existing_user_id, $line_uid, $profile, $state_data, $profile_key);
        return;
    }

    // 8. 檢查用戶名是否已存在（加數字後綴）
    $original_login = $user_login;
    $counter = 1;
    while (username_exists($user_login)) {
        $user_login = $original_login . $counter;
        $counter++;
    }

    // 9. 建立用戶
    $user_id = wp_insert_user([
        'user_login'   => $user_login,
        'user_email'   => $user_email,
        'user_pass'    => wp_generate_password(16, false),
        'display_name' => $profile['displayName'] ?? $user_login,
        'role'         => 'subscriber',
    ]);

    if (is_wp_error($user_id)) {
        Logger::get_instance()->log('error', [
            'message'       => 'Registration: wp_insert_user failed',
            'error_code'    => $user_id->get_error_code(),
            'error_message' => $user_id->get_error_message(),
        ]);
        wp_die('用戶建立失敗: ' . $user_id->get_error_message(), 'Error', ['response' => 500]);
    }

    // 10. 綁定 LINE（is_registration = true）
    $link_result = LineUserService::linkUser($user_id, $line_uid, true);
    if (!$link_result) {
        // 理論上不應該發生（前面已檢查），但保險起見
        Logger::get_instance()->log('error', [
            'message'  => 'Registration: linkUser failed after user creation',
            'user_id'  => $user_id,
            'line_uid' => $line_uid,
        ]);
        // 用戶已建立，繼續流程（LINE 綁定問題可稍後處理）
    }

    // 11. 儲存 LINE 頭像 URL 到 user_meta
    if (!empty($profile['pictureUrl'])) {
        update_user_meta($user_id, 'buygo_line_avatar_url', $profile['pictureUrl']);
    }

    Logger::get_instance()->log('info', [
        'message'  => 'User registered via LINE',
        'user_id'  => $user_id,
        'line_uid' => $line_uid,
        'email'    => $user_email,
    ]);

    // 12. 清除 Transient
    delete_transient($profile_key);

    // 13. 自動登入
    wp_set_auth_cookie($user_id, true);

    // 14. 觸發 hook（供其他外掛使用）
    do_action('buygo_line_after_register', $user_id, $line_uid, $profile);

    // 15. 導向
    $redirect_to = $state_data['redirect_url'] ?? home_url();
    $redirect_to = apply_filters('login_redirect', $redirect_to, '', get_user_by('id', $user_id));

    wp_safe_redirect($redirect_to);
    exit;
}
```

3. 新增 `handle_auto_link()` 方法：
```php
/**
 * 處理 Auto-link（Email 已存在時綁定現有帳號）
 *
 * @param int    $user_id WordPress User ID
 * @param string $line_uid LINE UID
 * @param array  $profile LINE profile
 * @param array  $state_data State 資料
 * @param string $profile_key Transient key
 * @return void
 */
private function handle_auto_link(
    int $user_id,
    string $line_uid,
    array $profile,
    array $state_data,
    string $profile_key
): void {
    Logger::get_instance()->log('info', [
        'message'  => 'Auto-link: Email exists, linking to existing user',
        'user_id'  => $user_id,
        'line_uid' => $line_uid,
        'email'    => $profile['email'] ?? 'N/A',
    ]);

    // 檢查該用戶是否已綁定其他 LINE 帳號
    $existing_line_uid = LineUserService::getLineUidByUserId($user_id);
    if ($existing_line_uid) {
        Logger::get_instance()->log('error', [
            'message'           => 'Auto-link: User already linked to another LINE',
            'user_id'           => $user_id,
            'existing_line_uid' => $existing_line_uid,
            'new_line_uid'      => $line_uid,
        ]);
        wp_die('此 Email 的帳號已綁定其他 LINE 帳號', 'Error', ['response' => 400]);
    }

    // 綁定 LINE（is_registration = false，因為是 auto-link 不是新註冊）
    $link_result = LineUserService::linkUser($user_id, $line_uid, false);
    if (!$link_result) {
        Logger::get_instance()->log('error', [
            'message'  => 'Auto-link: linkUser failed',
            'user_id'  => $user_id,
            'line_uid' => $line_uid,
        ]);
        wp_die('LINE 帳號綁定失敗', 'Error', ['response' => 500]);
    }

    // 儲存 LINE 頭像 URL
    if (!empty($profile['pictureUrl'])) {
        update_user_meta($user_id, 'buygo_line_avatar_url', $profile['pictureUrl']);
    }

    Logger::get_instance()->log('info', [
        'message'  => 'Auto-link completed',
        'user_id'  => $user_id,
        'line_uid' => $line_uid,
    ]);

    // 清除 Transient
    delete_transient($profile_key);

    // 自動登入
    wp_set_auth_cookie($user_id, true);

    // 觸發 hook
    do_action('buygo_line_after_link', $user_id, $line_uid, $profile);

    // 顯示訊息並導向
    // 使用 WordPress admin notice（透過 transient 傳遞）
    set_transient('buygo_line_notice_' . $user_id, [
        'type'    => 'success',
        'message' => '已將 LINE 帳號綁定到您的現有帳號',
    ], 60);

    // 導向
    $redirect_to = $state_data['redirect_url'] ?? home_url();
    $redirect_to = apply_filters('login_redirect', $redirect_to, '', get_user_by('id', $user_id));

    wp_safe_redirect($redirect_to);
    exit;
}
```

4. 確保必要的 use 語句：
```php
use BuygoLineNotify\Services\LineUserService;
use BuygoLineNotify\Services\Logger;
```
  </action>
  <verify>
`includes/handlers/class-login-handler.php` 包含：
- handle_register_submission() 方法
- handle_auto_link() 方法
- `wp_insert_user` 呼叫
- `LineUserService::linkUser` 呼叫
- `wp_set_auth_cookie` 呼叫
- `delete_transient` 呼叫

語法檢查：`php -l includes/handlers/class-login-handler.php`
  </verify>
  <done>handle_register_submission() 完整實作，包含用戶建立、LINE 綁定、Auto-link、自動登入</done>
</task>

<task type="auto">
  <name>Task 2: 驗證 LineUserService.linkUser 參數相容性</name>
  <files>includes/services/class-line-user-service.php</files>
  <action>
確認 `LineUserService::linkUser()` 方法支援 `$is_registration` 參數：

1. 讀取 `includes/services/class-line-user-service.php`
2. 確認 `linkUser()` 方法簽名：`public static function linkUser(int $user_id, string $line_uid, bool $is_registration = false): bool`
3. 若方法簽名不同，進行必要的調整

根據 Phase 8 的 SUMMARY，LineUserService 已經實作了 linkUser 方法。
驗證方法簽名和功能是否符合需求：
- 接受 $user_id (int)
- 接受 $line_uid (string)
- 接受 $is_registration (bool) - 決定是否寫入 register_date
- 返回 bool（成功/失敗）

如果需要調整（例如新增 $is_registration 參數），進行以下修改：
```php
/**
 * 綁定用戶與 LINE 帳號
 *
 * @param int    $user_id WordPress User ID
 * @param string $line_uid LINE UID
 * @param bool   $is_registration 是否為新用戶註冊（true 寫入 register_date，false 只寫入 link_date）
 * @return bool 是否成功
 */
public static function linkUser(int $user_id, string $line_uid, bool $is_registration = false): bool {
    global $wpdb;
    $table = $wpdb->prefix . 'buygo_line_users';

    // 檢查 LINE UID 是否已綁定其他用戶
    $existing = self::getUserByLineUid($line_uid);
    if ($existing) {
        return false; // 已綁定其他用戶
    }

    // 檢查用戶是否已綁定其他 LINE
    $existing_line = self::getLineUidByUserId($user_id);
    if ($existing_line) {
        return false; // 已綁定其他 LINE
    }

    $now = current_time('mysql');
    $data = [
        'type'       => 'line',
        'identifier' => $line_uid,
        'user_id'    => $user_id,
        'link_date'  => $now,
    ];

    if ($is_registration) {
        $data['register_date'] = $now;
    }

    $result = $wpdb->insert($table, $data, [
        '%s', // type
        '%s', // identifier
        '%d', // user_id
        '%s', // link_date
        ...(isset($data['register_date']) ? ['%s'] : []),
    ]);

    return $result !== false;
}
```
  </action>
  <verify>
- `LineUserService::linkUser()` 方法存在
- 方法支援 $is_registration 參數
- 語法檢查通過：`php -l includes/services/class-line-user-service.php`
  </verify>
  <done>LineUserService.linkUser 方法與表單提交處理完全相容</done>
</task>

</tasks>

<verification>
整體驗證：
1. `handle_register_submission()` 方法存在且包含完整邏輯
2. `handle_auto_link()` 方法存在
3. Nonce 驗證、State 驗證、Email/用戶名驗證都已實作
4. `LineUserService::linkUser()` 正確被呼叫
5. 自動登入邏輯（wp_set_auth_cookie）正確
6. Transient 在處理完成後被清除
7. 重定向使用 `wp_safe_redirect()`
8. 所有 PHP 檔案語法檢查通過
</verification>

<success_criteria>
- 用戶提交註冊表單後成功建立 WordPress 帳號
- LINE UID 正確寫入 wp_buygo_line_users（register_date 正確設定）
- Email 已存在時執行 Auto-link（link_date 設定，register_date 為 NULL）
- 註冊/Auto-link 成功後用戶被自動登入
- 用戶被導回原始頁面（從 state_data.redirect_url 讀取）
- Transient 被正確清除
</success_criteria>

<output>
After completion, create `.planning/phases/10-register-flow-page-系統/10-02-SUMMARY.md`
</output>
