---
phase: 10-register-flow-page-系統
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/shortcodes/class-register-flow-shortcode.php
  - includes/handlers/class-login-handler.php
  - includes/class-plugin.php
autonomous: true

must_haves:
  truths:
    - "OAuth callback 完成後，LINE profile 儲存到 Transient（10 分鐘有效）"
    - "Shortcode 可從 Transient 讀取 LINE profile 並渲染註冊表單"
    - "表單顯示 LINE 頭像、名稱、預填 email"
  artifacts:
    - path: "includes/shortcodes/class-register-flow-shortcode.php"
      provides: "RegisterFlowShortcode class"
      exports: ["render"]
      min_lines: 80
    - path: "includes/handlers/class-login-handler.php"
      provides: "Extended Login_Handler with Transient storage and dynamic shortcode"
      contains: "set_transient.*buygo_line_profile"
  key_links:
    - from: "Login_Handler::handle_callback()"
      to: "set_transient()"
      via: "儲存 LINE profile 到 Transient"
      pattern: "set_transient.*buygo_line_profile"
    - from: "RegisterFlowShortcode::render()"
      to: "get_transient()"
      via: "讀取 LINE profile"
      pattern: "get_transient.*buygo_line_profile"
---

<objective>
建立 Register Flow Shortcode 核心機制：LINE profile 持久化儲存 + Shortcode 渲染註冊表單

Purpose: 讓 OAuth callback 完成後，新用戶可在任意頁面看到註冊表單（顯示 LINE profile 資訊）
Output: RegisterFlowShortcode 類別 + Login_Handler 擴展（Transient 儲存 + 動態 shortcode 註冊）
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-register-flow-page-系統/10-RESEARCH.md

# Phase 9 已建立的基礎設施
@includes/exceptions/class-nsl-continue-page-render-exception.php
@includes/handlers/class-login-handler.php
@includes/services/class-state-manager.php
@includes/class-plugin.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 RegisterFlowShortcode 類別</name>
  <files>includes/shortcodes/class-register-flow-shortcode.php</files>
  <action>
建立 `includes/shortcodes/class-register-flow-shortcode.php`:

```php
namespace BuygoLineNotify\Shortcodes;

class RegisterFlowShortcode {
    /**
     * Transient 前綴（與 Login_Handler 一致）
     */
    const TRANSIENT_PREFIX = 'buygo_line_profile_';

    /**
     * 渲染 shortcode
     *
     * @param array $atts Shortcode 屬性
     * @param array|null $exception_data NSLContinuePageRenderException 資料（動態註冊時傳入）
     * @return string HTML 輸出
     */
    public function render($atts, $exception_data = null): string;

    /**
     * 渲染錯誤訊息
     */
    private function render_error(string $message): string;

    /**
     * 渲染註冊表單
     */
    private function render_form(array $profile, string $state): string;
}
```

實作要點：
1. `render()` 方法：
   - 從 URL 參數或 $exception_data 取得 state
   - 若 state 為空，返回錯誤訊息：「請透過 LINE 登入流程訪問此頁面。」
   - 從 Transient 讀取 LINE profile（key: TRANSIENT_PREFIX + state）
   - 若 Transient 不存在或過期，返回錯誤訊息：「登入資料已過期，請重新嘗試 LINE 登入。」
   - 呼叫 render_form() 渲染表單

2. `render_form()` 方法：
   - 使用 ob_start() / ob_get_clean() 捕獲 HTML
   - 顯示 LINE profile：頭像（img）、名稱（span）
   - 表單 action: site_url('wp-login.php?loginSocial=buygo-line')
   - 隱藏欄位：
     - wp_nonce_field('buygo_line_register_action', 'buygo_line_register_nonce')
     - action = buygo_line_register
     - state = $state
     - line_uid = $profile['userId']
   - 可編輯欄位：
     - user_login（預填 LINE displayName）
     - user_email（預填 LINE email，若有）
   - 提交按鈕：「完成註冊」

3. BEM 風格 class names：
   - .buygo-line-register-form（外層容器）
   - .buygo-line-register-form__profile（LINE profile 區）
   - .buygo-line-register-form__avatar（頭像）
   - .buygo-line-register-form__name（名稱）
   - .buygo-line-register-form__field（表單欄位）
   - .buygo-line-register-form__submit（提交按鈕）
   - .buygo-line-error（錯誤訊息）

4. 安全考量：
   - 所有輸出使用 esc_attr() / esc_html() / esc_url()
   - 使用 wp_nonce_field() 防 CSRF
  </action>
  <verify>
檔案存在且包含：
- `namespace BuygoLineNotify\Shortcodes`
- `class RegisterFlowShortcode`
- `render()` 方法
- `get_transient.*buygo_line_profile`
- `wp_nonce_field`
  </verify>
  <done>RegisterFlowShortcode 類別可從 Transient 讀取 LINE profile 並渲染註冊表單</done>
</task>

<task type="auto">
  <name>Task 2: 擴展 Login_Handler（Transient 儲存 + 動態 Shortcode）</name>
  <files>includes/handlers/class-login-handler.php, includes/class-plugin.php</files>
  <action>
**修改 `includes/handlers/class-login-handler.php`**:

1. 新增常數：
```php
const PROFILE_TRANSIENT_PREFIX = 'buygo_line_profile_';
const PROFILE_TRANSIENT_EXPIRY = 600; // 10 分鐘
```

2. 修改 `handle_callback()` 方法，在拋出 NSLContinuePageRenderException 之前：
```php
if (!$user_id) {
    // 新用戶，需要註冊流程

    // 1. 產生 profile transient key（使用原始 state）
    $profile_key = self::PROFILE_TRANSIENT_PREFIX . $state;

    // 2. 儲存 LINE profile 到 Transient（供 shortcode 使用）
    set_transient($profile_key, [
        'profile'    => $profile,
        'state_data' => $state_data,
        'state'      => $state,
        'timestamp'  => time(),
    ], self::PROFILE_TRANSIENT_EXPIRY);

    Logger::get_instance()->log('info', [
        'message'     => 'LINE profile stored for registration',
        'profile_key' => $profile_key,
        'line_uid'    => $line_uid,
    ]);

    // 3. 動態註冊 shortcode
    $this->register_shortcode_dynamically($state);

    // 4. 拋出例外（讓頁面繼續渲染）
    throw new NSLContinuePageRenderException(
        NSLContinuePageRenderException::FLOW_REGISTER,
        [
            'profile'     => $profile,
            'state_data'  => $state_data,
            'state'       => $state,
            'profile_key' => $profile_key,
        ]
    );
}
```

3. 新增 `register_shortcode_dynamically()` 方法：
```php
/**
 * 動態註冊 shortcode
 *
 * @param string $state OAuth state
 * @return void
 */
private function register_shortcode_dynamically(string $state): void {
    // 只在 shortcode 尚未註冊時註冊
    if (!shortcode_exists('buygo_line_register_flow')) {
        add_shortcode('buygo_line_register_flow', function($atts) use ($state) {
            // 載入 shortcode 類別（如果尚未載入）
            if (!class_exists('BuygoLineNotify\Shortcodes\RegisterFlowShortcode')) {
                require_once BuygoLineNotify_PLUGIN_DIR . 'includes/shortcodes/class-register-flow-shortcode.php';
            }
            $shortcode = new \BuygoLineNotify\Shortcodes\RegisterFlowShortcode();
            return $shortcode->render($atts, ['state' => $state]);
        });
    }
}
```

4. 修改 `handle_login_init()` 中的 catch 區塊，處理 Register Flow Page 重定向：
```php
} catch (NSLContinuePageRenderException $e) {
    // 新用戶需要顯示註冊表單
    if ($e->getFlowType() === NSLContinuePageRenderException::FLOW_REGISTER) {
        $data = $e->getData();
        $state = $data['state'] ?? '';

        // 檢查是否有設定 Register Flow Page
        $register_page_id = get_option('buygo_line_register_flow_page', 0);

        if ($register_page_id && get_post_status($register_page_id) === 'publish') {
            // 有設定頁面：重定向到該頁面（URL 帶 state 參數）
            $register_url = add_query_arg('state', $state, get_permalink($register_page_id));
            wp_redirect($register_url);
            exit;
        }

        // 沒有設定頁面：讓 WordPress 繼續渲染 wp-login.php
        // 但在 wp-login.php 上不會自動渲染 shortcode
        // 這種情況下輸出簡化版表單（fallback）
        $this->render_fallback_registration_form($data);
        exit;
    }

    // 其他流程類型，讓頁面繼續渲染
    return;
}
```

5. 新增 `render_fallback_registration_form()` 方法（當沒有設定 Register Flow Page 時的 fallback）：
```php
/**
 * 渲染 fallback 註冊表單（在 wp-login.php 上）
 *
 * @param array $data Exception data
 * @return void
 */
private function render_fallback_registration_form(array $data): void {
    $profile = $data['profile'];
    $state = $data['state'];

    // 使用 WordPress login 樣式輸出簡化版表單
    login_header('LINE 註冊', '', new \WP_Error());
    ?>
    <div id="buygo-line-register-fallback">
        <h2>完成 LINE 註冊</h2>
        <div class="line-profile" style="text-align: center; margin-bottom: 20px;">
            <?php if (!empty($profile['pictureUrl'])): ?>
                <img src="<?php echo esc_url($profile['pictureUrl']); ?>"
                     alt="LINE Avatar"
                     style="width: 80px; height: 80px; border-radius: 50%;">
            <?php endif; ?>
            <p><strong><?php echo esc_html($profile['displayName'] ?? ''); ?></strong></p>
        </div>
        <form method="post" action="<?php echo esc_url(site_url('wp-login.php?loginSocial=buygo-line')); ?>">
            <?php wp_nonce_field('buygo_line_register_action', 'buygo_line_register_nonce'); ?>
            <input type="hidden" name="action" value="buygo_line_register">
            <input type="hidden" name="state" value="<?php echo esc_attr($state); ?>">
            <input type="hidden" name="line_uid" value="<?php echo esc_attr($profile['userId']); ?>">
            <p>
                <label for="user_login">用戶名</label>
                <input type="text" name="user_login" id="user_login"
                       class="input" size="20"
                       value="<?php echo esc_attr($profile['displayName'] ?? ''); ?>" required>
            </p>
            <p>
                <label for="user_email">Email</label>
                <input type="email" name="user_email" id="user_email"
                       class="input" size="20"
                       value="<?php echo esc_attr($profile['email'] ?? ''); ?>" required>
            </p>
            <p class="submit">
                <input type="submit" name="wp-submit" id="wp-submit"
                       class="button button-primary button-large" value="完成註冊">
            </p>
        </form>
    </div>
    <?php
    login_footer();
}
```

**修改 `includes/class-plugin.php`**:

在 `loadDependencies()` 方法中新增：
```php
// 載入 Shortcode 類別（動態載入，見 Login_Handler）
// includes/shortcodes/class-register-flow-shortcode.php 由 Login_Handler 按需載入
```

確保 shortcodes 目錄存在：建立 `includes/shortcodes/` 目錄
  </action>
  <verify>
1. `includes/handlers/class-login-handler.php` 包含：
   - PROFILE_TRANSIENT_PREFIX 常數
   - set_transient() 呼叫
   - register_shortcode_dynamically() 方法
   - render_fallback_registration_form() 方法

2. `includes/shortcodes/` 目錄存在

3. 語法檢查：`php -l includes/handlers/class-login-handler.php`
  </verify>
  <done>Login_Handler 可在 OAuth callback 時儲存 LINE profile 到 Transient 並動態註冊 shortcode</done>
</task>

<task type="auto">
  <name>Task 3: 驗證 Shortcode 渲染（無 Register Flow Page 設定）</name>
  <files>無新增檔案</files>
  <action>
進行語法驗證和基本測試：

1. PHP 語法檢查：
```bash
php -l includes/shortcodes/class-register-flow-shortcode.php
php -l includes/handlers/class-login-handler.php
```

2. 確認 shortcode 可被載入（不會拋出 class not found）：
```php
// 在 PHP CLI 或測試環境中驗證
require_once 'includes/shortcodes/class-register-flow-shortcode.php';
$shortcode = new \BuygoLineNotify\Shortcodes\RegisterFlowShortcode();
echo $shortcode->render(['state' => 'test123'], null);
// 預期輸出：錯誤訊息（因為 Transient 不存在）
```

3. 記錄 Task 完成狀態以供後續 Plan 使用
  </action>
  <verify>
- PHP 語法檢查通過
- shortcode 類別可被正確載入
  </verify>
  <done>RegisterFlowShortcode 可被正確載入並執行，無語法錯誤</done>
</task>

</tasks>

<verification>
整體驗證：
1. `includes/shortcodes/class-register-flow-shortcode.php` 存在且包含完整的 RegisterFlowShortcode 類別
2. `includes/handlers/class-login-handler.php` 包含 Transient 儲存和動態 shortcode 註冊邏輯
3. PHP 語法檢查全部通過
4. Login_Handler 在新用戶 OAuth callback 時會：
   - 儲存 LINE profile 到 Transient
   - 動態註冊 shortcode
   - 若有 Register Flow Page 設定則重定向
   - 若無設定則在 wp-login.php 渲染 fallback 表單
</verification>

<success_criteria>
- RegisterFlowShortcode 類別可從 Transient 讀取 LINE profile 並渲染註冊表單
- Login_Handler 在 OAuth callback 時正確儲存 LINE profile 到 Transient
- 動態 shortcode 註冊機制運作正常
- fallback 表單可在 wp-login.php 上正確顯示
- 所有 PHP 檔案語法檢查通過
</success_criteria>

<output>
After completion, create `.planning/phases/10-register-flow-page-系統/10-01-SUMMARY.md`
</output>
