---
phase: 10-register-flow-page-系統
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/shortcodes/class-register-flow-shortcode.php
  - includes/handlers/class-login-handler.php
  - includes/class-plugin.php
autonomous: true

must_haves:
  truths:
    - "新用戶完成 LINE 授權後可看到註冊表單"
    - "表單顯示用戶的 LINE 頭像和名稱"
    - "用戶可在表單中填寫或修改 Email"
    - "若無設定註冊頁面，在 wp-login.php 顯示 fallback 表單"
  artifacts:
    - path: "includes/shortcodes/class-register-flow-shortcode.php"
      provides: "RegisterFlowShortcode class"
      exports: ["render"]
      min_lines: 80
    - path: "includes/handlers/class-login-handler.php"
      provides: "Extended Login_Handler with exception handling for all flow types"
      contains: "FLOW_REGISTER|FLOW_LINK"
  key_links:
    - from: "Login_Handler::handle_callback()"
      to: "set_transient()"
      via: "儲存 LINE profile 到 Transient"
      pattern: "set_transient.*buygo_line_profile"
    - from: "RegisterFlowShortcode::render()"
      to: "get_transient()"
      via: "讀取 LINE profile"
      pattern: "get_transient.*buygo_line_profile"
    - from: "Login_Handler::handle_login_init()"
      to: "NSLContinuePageRenderException"
      via: "捕捉所有例外流程類型"
      pattern: "FLOW_REGISTER|FLOW_LINK"
---

<objective>
建立 Register Flow Shortcode 核心機制：LINE profile 持久化儲存 + Shortcode 渲染註冊表單

Purpose: 讓 OAuth callback 完成後，新用戶可在任意頁面看到註冊表單（顯示 LINE profile 資訊）
Output: RegisterFlowShortcode 類別 + Login_Handler 擴展（Transient 儲存 + 動態 shortcode 註冊 + 完整例外處理）
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-register-flow-page-系統/10-RESEARCH.md

# Phase 9 已建立的基礎設施
@includes/exceptions/class-nsl-continue-page-render-exception.php
@includes/handlers/class-login-handler.php
@includes/services/class-state-manager.php
@includes/class-plugin.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 RegisterFlowShortcode 類別</name>
  <files>includes/shortcodes/class-register-flow-shortcode.php</files>
  <action>
建立 `includes/shortcodes/class-register-flow-shortcode.php`:

```php
namespace BuygoLineNotify\Shortcodes;

class RegisterFlowShortcode {
    /**
     * Transient 前綴（與 Login_Handler 一致）
     */
    const TRANSIENT_PREFIX = 'buygo_line_profile_';

    /**
     * 渲染 shortcode
     *
     * @param array $atts Shortcode 屬性
     * @param array|null $exception_data NSLContinuePageRenderException 資料（動態註冊時傳入）
     * @return string HTML 輸出
     */
    public function render($atts, $exception_data = null): string;

    /**
     * 渲染錯誤訊息
     */
    private function render_error(string $message): string;

    /**
     * 渲染註冊表單
     */
    private function render_form(array $profile, string $state): string;
}
```

實作要點：
1. `render()` 方法：
   - 從 URL 參數或 $exception_data 取得 state
   - 若 state 為空，返回錯誤訊息：「請透過 LINE 登入流程訪問此頁面。」
   - 從 Transient 讀取 LINE profile（key: TRANSIENT_PREFIX + state）
   - 若 Transient 不存在或過期，返回錯誤訊息：「登入資料已過期，請重新嘗試 LINE 登入。」
   - 呼叫 render_form() 渲染表單

2. `render_form()` 方法：
   - 使用 ob_start() / ob_get_clean() 捕獲 HTML
   - 顯示 LINE profile：頭像（img）、名稱（span）
   - 表單 action: site_url('wp-login.php?loginSocial=buygo-line')
   - 隱藏欄位：
     - wp_nonce_field('buygo_line_register_action', 'buygo_line_register_nonce')
     - action = buygo_line_register
     - state = $state
     - line_uid = $profile['userId']
   - 可編輯欄位：
     - user_login（預填 LINE displayName）
     - user_email（預填 LINE email，若有）
   - 提交按鈕：「完成註冊」

3. BEM 風格 class names：
   - .buygo-line-register-form（外層容器）
   - .buygo-line-register-form__profile（LINE profile 區）
   - .buygo-line-register-form__avatar（頭像）
   - .buygo-line-register-form__name（名稱）
   - .buygo-line-register-form__field（表單欄位）
   - .buygo-line-register-form__submit（提交按鈕）
   - .buygo-line-error（錯誤訊息）

4. 安全考量：
   - 所有輸出使用 esc_attr() / esc_html() / esc_url()
   - 使用 wp_nonce_field() 防 CSRF
  </action>
  <verify>
檔案存在且包含：
- `namespace BuygoLineNotify\Shortcodes`
- `class RegisterFlowShortcode`
- `render()` 方法
- `get_transient.*buygo_line_profile`
- `wp_nonce_field`
  </verify>
  <done>RegisterFlowShortcode 類別可從 Transient 讀取 LINE profile 並渲染註冊表單</done>
</task>

<task type="auto">
  <name>Task 2: 擴展 Login_Handler（Transient 儲存 + 動態 Shortcode + 完整例外處理）</name>
  <files>includes/handlers/class-login-handler.php, includes/class-plugin.php</files>
  <action>
**修改 `includes/handlers/class-login-handler.php`**:

1. 新增常數：
```php
const PROFILE_TRANSIENT_PREFIX = 'buygo_line_profile_';
const PROFILE_TRANSIENT_EXPIRY = 600; // 10 分鐘
```

2. 修改 `handle_callback()` 方法，在拋出 NSLContinuePageRenderException 之前：
```php
if (!$user_id) {
    // 新用戶，需要註冊流程

    // 1. 產生 profile transient key（使用原始 state）
    $profile_key = self::PROFILE_TRANSIENT_PREFIX . $state;

    // 2. 儲存 LINE profile 到 Transient（供 shortcode 使用）
    set_transient($profile_key, [
        'profile'    => $profile,
        'state_data' => $state_data,
        'state'      => $state,
        'timestamp'  => time(),
    ], self::PROFILE_TRANSIENT_EXPIRY);

    Logger::get_instance()->log('info', [
        'message'     => 'LINE profile stored for registration',
        'profile_key' => $profile_key,
        'line_uid'    => $line_uid,
    ]);

    // 3. 動態註冊 shortcode
    $this->register_shortcode_dynamically($state);

    // 4. 拋出例外（讓頁面繼續渲染）
    throw new NSLContinuePageRenderException(
        NSLContinuePageRenderException::FLOW_REGISTER,
        [
            'profile'     => $profile,
            'state_data'  => $state_data,
            'state'       => $state,
            'profile_key' => $profile_key,
        ]
    );
}
```

3. 新增 `register_shortcode_dynamically()` 方法：
```php
/**
 * 動態註冊 shortcode
 *
 * @param string $state OAuth state
 * @return void
 */
private function register_shortcode_dynamically(string $state): void {
    // 只在 shortcode 尚未註冊時註冊
    if (!shortcode_exists('buygo_line_register_flow')) {
        add_shortcode('buygo_line_register_flow', function($atts) use ($state) {
            // 載入 shortcode 類別（如果尚未載入）
            if (!class_exists('BuygoLineNotify\Shortcodes\RegisterFlowShortcode')) {
                require_once BuygoLineNotify_PLUGIN_DIR . 'includes/shortcodes/class-register-flow-shortcode.php';
            }
            $shortcode = new \BuygoLineNotify\Shortcodes\RegisterFlowShortcode();
            return $shortcode->render($atts, ['state' => $state]);
        });
    }
}
```

4. 修改 `handle_login_init()` 中的 catch 區塊，處理所有例外流程類型（NSL-04 完整覆蓋）：
```php
} catch (NSLContinuePageRenderException $e) {
    $flow_type = $e->getFlowType();
    $data = $e->getData();
    $state = $data['state'] ?? '';

    Logger::get_instance()->log('info', [
        'message'   => 'NSLContinuePageRenderException caught',
        'flow_type' => $flow_type,
        'state'     => $state,
    ]);

    // 根據流程類型處理
    switch ($flow_type) {
        case NSLContinuePageRenderException::FLOW_REGISTER:
            // 新用戶需要顯示註冊表單
            $register_page_id = get_option('buygo_line_register_flow_page', 0);

            if ($register_page_id && get_post_status($register_page_id) === 'publish') {
                // 有設定頁面：重定向到該頁面（URL 帶 state 參數）
                $register_url = add_query_arg('state', $state, get_permalink($register_page_id));
                wp_redirect($register_url);
                exit;
            }

            // 沒有設定頁面：讓 WordPress 繼續渲染 wp-login.php
            // 但在 wp-login.php 上不會自動渲染 shortcode
            // 這種情況下輸出簡化版表單（fallback）
            $this->render_fallback_registration_form($data);
            exit;

        case NSLContinuePageRenderException::FLOW_LINK:
            // 帳號連結流程：用戶已登入，需要確認連結 LINE
            // 重定向到設定頁面或顯示確認訊息
            $link_page_id = get_option('buygo_line_link_flow_page', 0);

            if ($link_page_id && get_post_status($link_page_id) === 'publish') {
                $link_url = add_query_arg('state', $state, get_permalink($link_page_id));
                wp_redirect($link_url);
                exit;
            }

            // Fallback: 直接在 wp-login.php 顯示連結確認
            $this->render_fallback_link_confirmation($data);
            exit;

        default:
            // 未知流程類型，記錄警告並讓頁面繼續
            Logger::get_instance()->log('warning', [
                'message'   => 'Unknown flow type in NSLContinuePageRenderException',
                'flow_type' => $flow_type,
            ]);
            return;
    }
}
```

5. 新增 `render_fallback_registration_form()` 方法（當沒有設定 Register Flow Page 時的 fallback）：
```php
/**
 * 渲染 fallback 註冊表單（在 wp-login.php 上）
 *
 * @param array $data Exception data
 * @return void
 */
private function render_fallback_registration_form(array $data): void {
    $profile = $data['profile'];
    $state = $data['state'];

    // 使用 WordPress login 樣式輸出簡化版表單
    login_header('LINE 註冊', '', new \WP_Error());
    ?>
    <div id="buygo-line-register-fallback">
        <h2>完成 LINE 註冊</h2>
        <div class="line-profile" style="text-align: center; margin-bottom: 20px;">
            <?php if (!empty($profile['pictureUrl'])): ?>
                <img src="<?php echo esc_url($profile['pictureUrl']); ?>"
                     alt="LINE Avatar"
                     style="width: 80px; height: 80px; border-radius: 50%;">
            <?php endif; ?>
            <p><strong><?php echo esc_html($profile['displayName'] ?? ''); ?></strong></p>
        </div>
        <form method="post" action="<?php echo esc_url(site_url('wp-login.php?loginSocial=buygo-line')); ?>">
            <?php wp_nonce_field('buygo_line_register_action', 'buygo_line_register_nonce'); ?>
            <input type="hidden" name="action" value="buygo_line_register">
            <input type="hidden" name="state" value="<?php echo esc_attr($state); ?>">
            <input type="hidden" name="line_uid" value="<?php echo esc_attr($profile['userId']); ?>">
            <p>
                <label for="user_login">用戶名</label>
                <input type="text" name="user_login" id="user_login"
                       class="input" size="20"
                       value="<?php echo esc_attr($profile['displayName'] ?? ''); ?>" required>
            </p>
            <p>
                <label for="user_email">Email</label>
                <input type="email" name="user_email" id="user_email"
                       class="input" size="20"
                       value="<?php echo esc_attr($profile['email'] ?? ''); ?>" required>
            </p>
            <p class="submit">
                <input type="submit" name="wp-submit" id="wp-submit"
                       class="button button-primary button-large" value="完成註冊">
            </p>
        </form>
    </div>
    <?php
    login_footer();
}
```

6. 新增 `render_fallback_link_confirmation()` 方法（FLOW_LINK 的 fallback）：
```php
/**
 * 渲染 fallback 帳號連結確認（在 wp-login.php 上）
 *
 * @param array $data Exception data
 * @return void
 */
private function render_fallback_link_confirmation(array $data): void {
    $profile = $data['profile'];
    $state = $data['state'];
    $user_id = $data['user_id'] ?? 0;

    login_header('連結 LINE 帳號', '', new \WP_Error());
    ?>
    <div id="buygo-line-link-fallback">
        <h2>連結 LINE 帳號</h2>
        <div class="line-profile" style="text-align: center; margin-bottom: 20px;">
            <?php if (!empty($profile['pictureUrl'])): ?>
                <img src="<?php echo esc_url($profile['pictureUrl']); ?>"
                     alt="LINE Avatar"
                     style="width: 80px; height: 80px; border-radius: 50%;">
            <?php endif; ?>
            <p><strong><?php echo esc_html($profile['displayName'] ?? ''); ?></strong></p>
        </div>
        <p style="text-align: center;">確定要將此 LINE 帳號連結到您的 WordPress 帳號嗎？</p>
        <form method="post" action="<?php echo esc_url(site_url('wp-login.php?loginSocial=buygo-line')); ?>">
            <?php wp_nonce_field('buygo_line_link_action', 'buygo_line_link_nonce'); ?>
            <input type="hidden" name="action" value="buygo_line_link">
            <input type="hidden" name="state" value="<?php echo esc_attr($state); ?>">
            <input type="hidden" name="line_uid" value="<?php echo esc_attr($profile['userId']); ?>">
            <input type="hidden" name="user_id" value="<?php echo esc_attr($user_id); ?>">
            <p class="submit" style="text-align: center;">
                <input type="submit" name="wp-submit" id="wp-submit"
                       class="button button-primary button-large" value="確認連結">
                <a href="<?php echo esc_url(home_url()); ?>" class="button button-secondary">取消</a>
            </p>
        </form>
    </div>
    <?php
    login_footer();
}
```

**修改 `includes/class-plugin.php`**:

在 `loadDependencies()` 方法中新增：
```php
// 載入 Shortcode 類別（動態載入，見 Login_Handler）
// includes/shortcodes/class-register-flow-shortcode.php 由 Login_Handler 按需載入
```

確保 shortcodes 目錄存在：建立 `includes/shortcodes/` 目錄
  </action>
  <verify>
1. `includes/handlers/class-login-handler.php` 包含：
   - PROFILE_TRANSIENT_PREFIX 常數
   - set_transient() 呼叫
   - register_shortcode_dynamically() 方法
   - render_fallback_registration_form() 方法
   - render_fallback_link_confirmation() 方法（FLOW_LINK 處理）
   - switch ($flow_type) 完整處理所有流程類型

2. `includes/shortcodes/` 目錄存在

3. 語法檢查：`php -l includes/handlers/class-login-handler.php`
  </verify>
  <done>Login_Handler 可在 OAuth callback 時儲存 LINE profile 到 Transient，動態註冊 shortcode，並正確處理所有例外流程類型（FLOW_REGISTER, FLOW_LINK）</done>
</task>

<task type="auto">
  <name>Task 3: 驗證 Shortcode 和 Transient 機制</name>
  <files>無新增檔案</files>
  <action>
進行完整的語法驗證和 Transient 機制測試：

1. PHP 語法檢查：
```bash
php -l includes/shortcodes/class-register-flow-shortcode.php
php -l includes/handlers/class-login-handler.php
```

2. 建立簡單的 Transient 測試腳本（在外掛目錄執行）：
```bash
cd buygo-line-notify && wp eval '
// 測試 Transient 儲存
$test_state = "test_" . time();
$test_key = "buygo_line_profile_" . $test_state;
$test_data = [
    "profile" => ["userId" => "U12345", "displayName" => "Test User"],
    "state" => $test_state,
    "timestamp" => time(),
];

// 寫入 Transient
$set_result = set_transient($test_key, $test_data, 60);
echo "set_transient result: " . ($set_result ? "success" : "failed") . "\n";

// 讀取 Transient
$get_result = get_transient($test_key);
if ($get_result !== false) {
    echo "get_transient result: success\n";
    echo "Retrieved userId: " . $get_result["profile"]["userId"] . "\n";
    echo "Retrieved displayName: " . $get_result["profile"]["displayName"] . "\n";
} else {
    echo "get_transient result: failed\n";
}

// 清除測試資料
delete_transient($test_key);
echo "Transient cleaned up\n";
'
```

3. 確認 shortcode 可被正確載入：
```bash
cd buygo-line-notify && wp eval '
require_once "includes/shortcodes/class-register-flow-shortcode.php";
$shortcode = new \BuygoLineNotify\Shortcodes\RegisterFlowShortcode();

// 測試無 state 的情況（應顯示錯誤）
$result = $shortcode->render([], null);
if (strpos($result, "buygo-line-error") !== false) {
    echo "Empty state test: PASS (correctly shows error)\n";
} else {
    echo "Empty state test: FAIL\n";
}

// 測試無效 state 的情況（Transient 不存在）
$result = $shortcode->render([], ["state" => "invalid_state_123"]);
if (strpos($result, "過期") !== false || strpos($result, "error") !== false) {
    echo "Invalid state test: PASS (correctly shows expired error)\n";
} else {
    echo "Invalid state test: FAIL\n";
}
'
```

4. 記錄測試結果
  </action>
  <verify>
- PHP 語法檢查通過（所有檔案）
- Transient 儲存/讀取測試成功
- Shortcode 類別可被正確載入並執行
- 無效 state 時正確顯示錯誤訊息
  </verify>
  <done>RegisterFlowShortcode 和 Transient 機制經過驗證，可正確運作</done>
</task>

</tasks>

<verification>
整體驗證：
1. `includes/shortcodes/class-register-flow-shortcode.php` 存在且包含完整的 RegisterFlowShortcode 類別
2. `includes/handlers/class-login-handler.php` 包含 Transient 儲存和動態 shortcode 註冊邏輯
3. Login_Handler 正確處理所有 NSLContinuePageRenderException 流程類型（FLOW_REGISTER, FLOW_LINK）
4. PHP 語法檢查全部通過
5. Transient 儲存/讀取機制經過測試驗證
6. Login_Handler 在新用戶 OAuth callback 時會：
   - 儲存 LINE profile 到 Transient
   - 動態註冊 shortcode
   - 若有 Register Flow Page 設定則重定向
   - 若無設定則在 wp-login.php 渲染 fallback 表單
</verification>

<success_criteria>
- RegisterFlowShortcode 類別可從 Transient 讀取 LINE profile 並渲染註冊表單
- Login_Handler 在 OAuth callback 時正確儲存 LINE profile 到 Transient
- Login_Handler 正確處理 FLOW_REGISTER 和 FLOW_LINK 例外類型（NSL-04 完整覆蓋）
- 動態 shortcode 註冊機制運作正常
- fallback 表單可在 wp-login.php 上正確顯示
- Transient 機制經過 wp eval 測試驗證
- 所有 PHP 檔案語法檢查通過
</success_criteria>

<output>
After completion, create `.planning/phases/10-register-flow-page-系統/10-01-SUMMARY.md`
</output>
