---
phase: 10-register-flow-page-系統
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - includes/admin/class-settings-page.php
  - includes/admin/views/settings-page.php
autonomous: false

must_haves:
  truths:
    - "管理員可在後台選擇「註冊流程頁面」"
    - "頁面選擇器使用 wp_dropdown_pages"
    - "選擇的頁面 ID 儲存到 buygo_line_register_flow_page option"
    - "若選擇的頁面不包含 shortcode，顯示警告訊息"
  artifacts:
    - path: "includes/admin/views/settings-page.php"
      provides: "Register Flow Page 選擇器 UI"
      contains: "wp_dropdown_pages"
    - path: "includes/admin/class-settings-page.php"
      provides: "Handle form submission for register_flow_page"
      contains: "buygo_line_register_flow_page"
  key_links:
    - from: "settings-page.php"
      to: "wp_dropdown_pages()"
      via: "頁面選擇器"
      pattern: "wp_dropdown_pages"
    - from: "SettingsPage::handle_form_submission()"
      to: "update_option()"
      via: "儲存設定"
      pattern: "buygo_line_register_flow_page"
---

<objective>
在後台設定頁面新增 Register Flow Page 選擇器，驗證完整的 LINE Login 新用戶註冊流程

Purpose: 讓管理員可選擇註冊流程頁面，並驗證整個新用戶註冊流程運作正常
Output: 設定頁面 UI 擴展 + 流程驗證完成
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-register-flow-page-系統/10-RESEARCH.md

# 現有設定頁面
@includes/admin/class-settings-page.php
@includes/admin/views/settings-page.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 擴展設定頁面（Register Flow Page 選擇器）</name>
  <files>includes/admin/class-settings-page.php, includes/admin/views/settings-page.php</files>
  <action>
**修改 `includes/admin/class-settings-page.php`**:

1. 在 `handle_form_submission()` 方法的 $fields 陣列中新增：
```php
// 處理 Register Flow Page（單獨處理，因為是 int 而非 string）
$register_flow_page = isset($_POST['register_flow_page']) ? absint($_POST['register_flow_page']) : 0;
update_option('buygo_line_register_flow_page', $register_flow_page);
```

將上述程式碼放在 foreach 迴圈之後，return 之前。

**修改 `includes/admin/views/settings-page.php`**:

1. 在 LINE Login 設定區塊（`<h2>LINE Login 設定</h2>`）的 `</tbody>` 之前，新增 Register Flow Page 選擇器：

```php
<!-- Register Flow Page 選擇器 -->
<tr>
    <th scope="row">
        <label for="register_flow_page">LINE 註冊流程頁面</label>
    </th>
    <td>
        <?php
        $register_flow_page_id = get_option('buygo_line_register_flow_page', 0);
        wp_dropdown_pages([
            'name'              => 'register_flow_page',
            'id'                => 'register_flow_page',
            'selected'          => $register_flow_page_id,
            'show_option_none'  => '— 使用預設（wp-login.php）—',
            'option_none_value' => 0,
        ]);
        ?>
        <p class="description">
            選擇一個包含 <code>[buygo_line_register_flow]</code> shortcode 的頁面。<br>
            若未選擇，新用戶將在 wp-login.php 上看到註冊表單。
        </p>
        <?php
        // 檢查所選頁面是否包含 shortcode
        if ($register_flow_page_id) {
            $page = get_post($register_flow_page_id);
            if ($page) {
                $has_shortcode = has_shortcode($page->post_content, 'buygo_line_register_flow');
                if (!$has_shortcode) {
                    echo '<div class="notice notice-warning inline" style="margin-top: 10px; padding: 10px;">';
                    echo '<p><strong>警告：</strong>所選頁面未包含 <code>[buygo_line_register_flow]</code> shortcode。</p>';
                    echo '<p>請編輯該頁面並新增 shortcode，或選擇其他頁面。</p>';
                    echo '</div>';
                } else {
                    echo '<div class="notice notice-success inline" style="margin-top: 10px; padding: 10px;">';
                    echo '<p>✓ 頁面已正確包含 shortcode</p>';
                    echo '</div>';
                }
            }
        }
        ?>
    </td>
</tr>

<!-- 快速建立頁面按鈕 -->
<tr>
    <th scope="row">
        <label>快速建立頁面</label>
    </th>
    <td>
        <button type="button" id="create-register-flow-page" class="button button-secondary">
            自動建立註冊頁面
        </button>
        <span id="create-page-status" style="margin-left: 10px;"></span>
        <p class="description">
            點擊後會自動建立一個包含 shortcode 的「LINE 註冊」頁面。
        </p>

        <script>
        document.getElementById('create-register-flow-page').addEventListener('click', function() {
            const btn = this;
            const status = document.getElementById('create-page-status');

            btn.disabled = true;
            status.textContent = '建立中...';
            status.style.color = '#666';

            // 發送 AJAX 請求建立頁面
            fetch('<?php echo esc_js(admin_url('admin-ajax.php')); ?>', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    action: 'buygo_line_create_register_page',
                    _ajax_nonce: '<?php echo wp_create_nonce('buygo_line_create_register_page'); ?>'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    status.textContent = '✓ 頁面建立成功！';
                    status.style.color = '#46b450';

                    // 更新下拉選單
                    const select = document.getElementById('register_flow_page');
                    const option = document.createElement('option');
                    option.value = data.data.page_id;
                    option.textContent = data.data.page_title;
                    option.selected = true;
                    select.appendChild(option);

                    // 顯示編輯連結
                    status.innerHTML = '✓ 頁面建立成功！<a href="' + data.data.edit_url + '" target="_blank" style="margin-left: 10px;">編輯頁面</a>';
                } else {
                    status.textContent = '✗ 建立失敗：' + data.data.message;
                    status.style.color = '#dc3232';
                    btn.disabled = false;
                }
            })
            .catch(error => {
                status.textContent = '✗ 發生錯誤';
                status.style.color = '#dc3232';
                btn.disabled = false;
            });
        });
        </script>
    </td>
</tr>
```

2. 同時更新 Callback URL 顯示為新的標準 WordPress URL：
找到 Callback URL 的 `<code>` 標籤，將：
```php
<code><?php echo esc_url(rest_url('buygo-line-notify/v1/login/callback')); ?></code>
```
改為：
```php
<code id="callback-url"><?php echo esc_url(site_url('wp-login.php?loginSocial=buygo-line')); ?></code>
```

並更新 `copyCallbackUrl()` 函數：
```javascript
function copyCallbackUrl() {
    const callbackUrl = '<?php echo esc_js(site_url('wp-login.php?loginSocial=buygo-line')); ?>';
    // ... 其餘不變
}
```

**修改 `includes/admin/class-settings-page.php`**:

新增 AJAX handler（在 `register_hooks()` 方法中）：
```php
public static function register_hooks(): void
{
    // 優先級 30，確保在 buygo-plus-one (優先級 20) 之後執行
    \add_action('admin_menu', [self::class, 'add_admin_menu'], 30);

    // AJAX handler for creating register flow page
    \add_action('wp_ajax_buygo_line_create_register_page', [self::class, 'ajax_create_register_page']);
}

/**
 * AJAX: 建立 Register Flow Page
 */
public static function ajax_create_register_page(): void
{
    // Nonce 驗證
    if (!check_ajax_referer('buygo_line_create_register_page', '_ajax_nonce', false)) {
        wp_send_json_error(['message' => '安全驗證失敗']);
    }

    // 權限檢查
    if (!current_user_can('publish_pages')) {
        wp_send_json_error(['message' => '您沒有權限建立頁面']);
    }

    // 建立頁面
    $page_id = wp_insert_post([
        'post_title'   => 'LINE 註冊',
        'post_content' => '[buygo_line_register_flow]',
        'post_status'  => 'publish',
        'post_type'    => 'page',
    ]);

    if (is_wp_error($page_id)) {
        wp_send_json_error(['message' => $page_id->get_error_message()]);
    }

    // 自動設定為 Register Flow Page
    update_option('buygo_line_register_flow_page', $page_id);

    wp_send_json_success([
        'page_id'    => $page_id,
        'page_title' => 'LINE 註冊',
        'edit_url'   => get_edit_post_link($page_id, 'raw'),
        'view_url'   => get_permalink($page_id),
    ]);
}
```
  </action>
  <verify>
1. `includes/admin/views/settings-page.php` 包含：
   - `wp_dropdown_pages` 呼叫
   - register_flow_page name 屬性
   - Shortcode 檢查邏輯（has_shortcode）
   - AJAX 建立頁面按鈕

2. `includes/admin/class-settings-page.php` 包含：
   - `buygo_line_register_flow_page` option 儲存
   - `ajax_create_register_page` 方法
   - wp_ajax action 註冊

3. 語法檢查：
   - `php -l includes/admin/class-settings-page.php`
   - `php -l includes/admin/views/settings-page.php`
  </verify>
  <done>後台設定頁面包含完整的 Register Flow Page 選擇器 UI</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
完整的 Phase 10 Register Flow Page 系統：
1. RegisterFlowShortcode - 從 Transient 讀取 LINE profile 渲染註冊表單
2. Login_Handler 擴展 - Transient 儲存、動態 shortcode 註冊、表單提交處理
3. Auto-link 機制 - Email 已存在時自動綁定現有帳號
4. 後台設定 - Register Flow Page 選擇器 + AJAX 快速建立頁面
  </what-built>
  <how-to-verify>
**測試環境準備：**
1. 確保 LINE Developers Console 的 Callback URL 已更新為：
   `https://test.buygo.me/wp-login.php?loginSocial=buygo-line`
2. 在 WordPress 後台建立一個測試用戶（用於 Auto-link 測試）

**測試案例 1：後台設定頁面**
1. 前往 WordPress 後台 > LINE 通知 > 設定
2. 確認「LINE 註冊流程頁面」選擇器存在
3. 點擊「自動建立註冊頁面」按鈕
4. 確認頁面建立成功，選擇器自動選中新頁面
5. 確認顯示「✓ 頁面已正確包含 shortcode」

**測試案例 2：新用戶註冊流程（使用 Register Flow Page）**
1. 登出 WordPress
2. 使用無痕模式訪問 `https://test.buygo.me/wp-login.php?loginSocial=buygo-line`
3. 完成 LINE 授權
4. 確認被導向到「LINE 註冊」頁面
5. 確認表單顯示：LINE 頭像、LINE 名稱、用戶名欄位、Email 欄位
6. 填寫用戶名和 Email，點擊「完成註冊」
7. 確認成功建立帳號並自動登入
8. 確認被導回原始頁面

**測試案例 3：新用戶註冊流程（無 Register Flow Page，使用 fallback）**
1. 在後台將「LINE 註冊流程頁面」設定為「使用預設（wp-login.php）」
2. 登出 WordPress
3. 使用無痕模式訪問 `https://test.buygo.me/wp-login.php?loginSocial=buygo-line`
4. 完成 LINE 授權
5. 確認在 wp-login.php 上顯示註冊表單（fallback 模式）
6. 填寫用戶名和 Email，點擊「完成註冊」
7. 確認成功建立帳號並自動登入

**測試案例 4：Auto-link（Email 已存在）**
1. 確保 WordPress 中已有一個測試用戶（例如：test@example.com）
2. 登出 WordPress
3. 使用一個「尚未綁定任何 WordPress 帳號」的 LINE 帳號進行授權
4. 在註冊表單中輸入已存在的 Email（test@example.com）
5. 點擊「完成註冊」
6. 確認系統顯示「已將 LINE 帳號綁定到您的現有帳號」
7. 確認已自動登入該現有帳號

**驗證資料庫：**
在 WordPress 後台或 phpMyAdmin 檢查：
- 新用戶正確建立於 wp_users
- LINE 綁定正確記錄於 wp_buygo_line_users（register_date 和 link_date 正確）
- Auto-link 情況下 register_date 為 NULL，link_date 有值
  </how-to-verify>
  <resume-signal>
完成測試後回報結果：
- 「approved」：所有測試通過
- 描述問題：如有任何測試失敗，請描述具體情況
  </resume-signal>
</task>

</tasks>

<verification>
整體驗證：
1. 後台設定頁面包含 Register Flow Page 選擇器
2. wp_dropdown_pages 正確顯示所有頁面
3. 頁面選擇後正確儲存到 buygo_line_register_flow_page option
4. Shortcode 檢查正確顯示警告/成功訊息
5. AJAX 建立頁面功能正常運作
6. 新用戶註冊流程完整運作（Register Flow Page 模式）
7. fallback 模式（wp-login.php）正常運作
8. Auto-link 機制正確運作
</verification>

<success_criteria>
- 管理員可在後台選擇「註冊流程頁面」
- 頁面選擇器使用 wp_dropdown_pages 且正確顯示所有頁面
- 快速建立頁面按鈕可正確建立包含 shortcode 的頁面
- 新用戶可完成完整註冊流程（Register Flow Page 或 fallback 模式）
- Auto-link 機制可正確處理 Email 已存在的情況
- 所有測試案例通過用戶驗證
</success_criteria>

<output>
After completion, create `.planning/phases/10-register-flow-page-系統/10-03-SUMMARY.md`
</output>
