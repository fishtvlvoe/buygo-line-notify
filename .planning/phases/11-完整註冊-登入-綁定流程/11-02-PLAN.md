---
phase: 11-完整註冊-登入-綁定流程
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - includes/handlers/class-login-handler.php
  - includes/services/class-login-service.php
autonomous: false

must_haves:
  truths:
    - "已登入用戶發起綁定時 state_data 正確包含 user_id"
    - "OAuth callback 後正確導向綁定確認頁面（Fallback 或設定頁面）"
    - "綁定表單提交後成功綁定並導向"
    - "所有流程 State 驗證正常運作"
  artifacts:
    - path: "includes/handlers/class-login-handler.php"
      provides: "完整的綁定流程支援"
      contains: "handle_link_submission"
    - path: "includes/services/class-login-service.php"
      provides: "get_authorize_url 支援 user_id 參數"
      contains: "user_id"
  key_links:
    - from: "前端綁定按鈕（未來 Phase 13）"
      to: "LoginService::get_authorize_url($redirect, $user_id)"
      via: "傳入當前用戶 ID"
      pattern: "get_authorize_url.*user_id"
    - from: "handle_callback()"
      to: "FLOW_LINK 例外"
      via: "link_user_id > 0 判斷"
      pattern: "link_user_id.*FLOW_LINK"
---

<objective>
驗證完整註冊/登入/綁定流程的端到端運作

Purpose: 確保 Phase 11 所有流程正確整合,包括新用戶註冊、Auto-link、已登入綁定、已有用戶登入
Output: 所有流程通過人工驗證,Phase 11 功能完整
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-完整註冊-登入-綁定流程/11-RESEARCH.md
@.planning/phases/11-完整註冊-登入-綁定流程/11-01-SUMMARY.md
@includes/handlers/class-login-handler.php
@includes/services/class-login-service.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 驗證 handle_authorize() 支援綁定流程</name>
  <files>includes/handlers/class-login-handler.php, includes/services/class-login-service.php</files>
  <action>
確認現有程式碼已支援傳入 user_id 給 LoginService::get_authorize_url():

1. **檢查 LoginService::get_authorize_url()**:
- 已支援 $user_id 參數（nullable int）
- 已將 user_id 儲存到 state_data

2. **檢查 Login_Handler::handle_authorize()**:
- 目前未傳入 user_id（因為登入流程用戶尚未登入）
- 這是正確的 - 綁定流程由前端按鈕發起時傳入 user_id
- Phase 13 前台整合時會處理綁定按鈕的 URL 產生

3. **驗證邏輯正確性**:
- 登入流程: handle_authorize() → get_authorize_url($redirect, null)
- 綁定流程: 前端按鈕產生 URL 時 → get_authorize_url($redirect, $current_user_id)

**無需修改程式碼,只需確認邏輯正確。**
  </action>
  <verify>
grep -n "get_authorize_url" includes/handlers/class-login-handler.php
grep -n "user_id" includes/services/class-login-service.php | head -10
  </verify>
  <done>
- LoginService::get_authorize_url() 已支援 user_id 參數
- Login_Handler::handle_authorize() 正確呼叫 get_authorize_url()
- 綁定流程的 user_id 傳遞由前端按鈕處理（Phase 13）
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
完整的註冊/登入/綁定流程實作,包括:
- Plan 11-01: handle_link_submission() 方法
- Plan 11-01: handle_callback() 綁定流程判斷
- 現有: 新用戶註冊（Phase 10）
- 現有: Auto-link（Phase 10）
- 現有: 已有用戶登入（Phase 9）
  </what-built>
  <how-to-verify>
測試四個流程場景:

**準備工作:**
1. 確保測試環境乾淨（清除舊的 LINE 綁定記錄）
2. 開啟瀏覽器無痕模式（避免快取影響）

**案例 1: 新用戶註冊（FLOW-01）**
1. 確保未登入 WordPress
2. 訪問 https://test.buygo.me/wp-login.php?loginSocial=buygo-line
3. 完成 LINE OAuth 授權
4. 應顯示註冊表單（Register Flow Page 或 Fallback）
5. 填寫用戶名和 Email,提交
6. 預期: 成功建立帳號並登入,導向首頁

**案例 2: Auto-link（FLOW-02）**
1. 先在 WordPress 建立帳號（使用 LINE Email）
2. 確保該帳號未綁定 LINE
3. 使用無痕模式訪問 https://test.buygo.me/wp-login.php?loginSocial=buygo-line
4. 完成 LINE OAuth 授權
5. 預期: 自動綁定到現有帳號並登入,不顯示註冊表單

**案例 3: 已有用戶登入（FLOW-04）**
1. 使用案例 1 或 2 建立的已綁定帳號
2. 登出後再訪問 https://test.buygo.me/wp-login.php?loginSocial=buygo-line
3. 完成 LINE OAuth 授權
4. 預期: 直接登入,不顯示任何表單

**案例 4: 已登入用戶綁定（FLOW-03）**
*注意: 目前無前端綁定按鈕,需手動構造 URL 測試*

1. 建立新 WordPress 帳號（未綁定 LINE）
2. 登入該帳號
3. 手動構造綁定 URL:
   - 訪問 WP-CLI 或直接修改資料庫測試
   - 或使用開發者工具執行:
   ```javascript
   // 在前端 console 執行,模擬綁定按鈕
   window.location.href = '/wp-login.php?loginSocial=buygo-line&redirect_to=' + encodeURIComponent(window.location.href);
   ```
4. 完成 LINE OAuth 授權
5. 預期: 顯示綁定確認頁面（Fallback 模式）
6. 點擊確認按鈕
7. 預期: 綁定成功並導向

**驗證重點:**
- State 驗證是否正常（無「State 驗證失敗」錯誤）
- 各流程是否正確區分（登入/註冊/綁定）
- 錯誤訊息是否清晰
  </how-to-verify>
  <resume-signal>
請描述測試結果:
- 案例 1 結果: [通過/失敗 + 說明]
- 案例 2 結果: [通過/失敗 + 說明]
- 案例 3 結果: [通過/失敗 + 說明]
- 案例 4 結果: [通過/失敗 + 說明]

如果所有案例通過,輸入 "approved"
如果有失敗,描述問題細節
  </resume-signal>
</task>

</tasks>

<verification>
1. 案例 1-4 全部通過用戶驗證
2. 無 State 驗證錯誤
3. 流程正確區分
</verification>

<success_criteria>
- [ ] 新用戶註冊流程正常（FLOW-01）
- [ ] Auto-link 流程正常（FLOW-02）
- [ ] 已有用戶登入流程正常（FLOW-04）
- [ ] 已登入用戶綁定流程正常（FLOW-03）
- [ ] State 驗證機制正常運作（FLOW-05）
- [ ] 用戶驗證通過（checkpoint approved）
</success_criteria>

<output>
After completion, create `.planning/phases/11-完整註冊-登入-綁定流程/11-02-SUMMARY.md`
</output>
