---
phase: 11-完整註冊-登入-綁定流程
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - includes/handlers/class-login-handler.php
  - includes/services/class-login-service.php
autonomous: false

must_haves:
  truths:
    - "已登入用戶發起綁定時 state_data 正確包含 user_id"
    - "OAuth callback 後正確導向綁定確認頁面（Fallback 或設定頁面）"
    - "綁定表單提交後成功綁定並導向"
    - "所有流程 State 驗證正常運作"
  artifacts:
    - path: "includes/handlers/class-login-handler.php"
      provides: "完整的綁定流程支援"
      contains: "handle_link_submission"
    - path: "includes/services/class-login-service.php"
      provides: "get_authorize_url 支援 user_id 參數"
      contains: "user_id"
  key_links:
    - from: "前端綁定按鈕（未來 Phase 13）"
      to: "LoginService::get_authorize_url($redirect, $user_id)"
      via: "傳入當前用戶 ID"
      pattern: "get_authorize_url.*user_id"
    - from: "handle_callback()"
      to: "FLOW_LINK 例外"
      via: "link_user_id > 0 判斷"
      pattern: "link_user_id.*FLOW_LINK"
---

<objective>
驗證完整註冊/登入/綁定流程的端到端運作

Purpose: 確保 Phase 11 所有流程正確整合,包括新用戶註冊、Auto-link、已登入綁定、已有用戶登入
Output: 所有流程通過人工驗證,Phase 11 功能完整
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-完整註冊-登入-綁定流程/11-RESEARCH.md
@.planning/phases/11-完整註冊-登入-綁定流程/11-01-SUMMARY.md
@includes/handlers/class-login-handler.php
@includes/services/class-login-service.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 驗證 handle_authorize() 支援綁定流程</name>
  <files>includes/handlers/class-login-handler.php, includes/services/class-login-service.php</files>
  <action>
確認現有程式碼已支援傳入 user_id 給 LoginService::get_authorize_url():

1. **檢查 LoginService::get_authorize_url()**:
- 已支援 $user_id 參數（nullable int）
- 已將 user_id 儲存到 state_data

2. **檢查 Login_Handler::handle_authorize()**:
- 目前未傳入 user_id（因為登入流程用戶尚未登入）
- 這是正確的 - 綁定流程由前端按鈕發起時傳入 user_id
- Phase 13 前台整合時會處理綁定按鈕的 URL 產生

3. **驗證邏輯正確性**:
- 登入流程: handle_authorize() → get_authorize_url($redirect, null)
- 綁定流程: 前端按鈕產生 URL 時 → get_authorize_url($redirect, $current_user_id)

**無需修改程式碼,只需確認邏輯正確。**
  </action>
  <verify>
grep -n "get_authorize_url" includes/handlers/class-login-handler.php
grep -n "user_id" includes/services/class-login-service.php | head -10
  </verify>
  <done>
- LoginService::get_authorize_url() 已支援 user_id 參數
- Login_Handler::handle_authorize() 正確呼叫 get_authorize_url()
- 綁定流程的 user_id 傳遞由前端按鈕處理（Phase 13）
  </done>
</task>

<task type="auto">
  <name>Task 2: 建立後端測試腳本</name>
  <files>test-link-flow.php</files>
  <action>
建立測試腳本供案例 4 後端邏輯驗證使用。此腳本放在外掛根目錄，用於模擬和驗證綁定流程邏輯。

建立 `test-link-flow.php`:

```php
<?php
/**
 * 綁定流程後端邏輯測試腳本
 *
 * 使用方式：
 * 1. 以已登入用戶身份訪問此腳本
 * 2. 腳本會產生帶有 user_id 的綁定 URL
 * 3. 點擊連結開始綁定流程
 *
 * 訪問路徑: https://test.buygo.me/wp-content/plugins/buygo-line-notify/test-link-flow.php
 */

// 載入 WordPress
require_once dirname( __FILE__, 5 ) . '/wp-load.php';

// 確保已登入
if ( ! is_user_logged_in() ) {
    wp_die( '請先登入 WordPress 再執行此測試。<br><a href="' . wp_login_url( $_SERVER['REQUEST_URI'] ) . '">前往登入</a>' );
}

$current_user = wp_get_current_user();
$user_id = $current_user->ID;

// 檢查是否已綁定 LINE
use BuyGo_Line_Notify\Services\LineUserService;
$existing_line_uid = LineUserService::getLineUidByUserId( $user_id );

// 產生綁定 URL
use BuyGo_Line_Notify\Services\LoginService;
$login_service = new LoginService();
$redirect_url = home_url( '/my-account/' ); // 綁定後導向
$authorize_url = $login_service->get_authorize_url( $redirect_url, $user_id );

?>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>LINE 綁定流程測試</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .info { background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .warning { background: #fff3e0; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .success { background: #e8f5e9; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .error { background: #ffebee; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .btn { display: inline-block; padding: 10px 20px; background: #06c755; color: white; text-decoration: none; border-radius: 5px; }
        .btn:hover { background: #05b34a; }
        code { background: #f5f5f5; padding: 2px 6px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>LINE 綁定流程測試（案例 4）</h1>

    <div class="info">
        <strong>當前用戶:</strong> <?php echo esc_html( $current_user->user_login ); ?> (ID: <?php echo $user_id; ?>)<br>
        <strong>Email:</strong> <?php echo esc_html( $current_user->user_email ); ?>
    </div>

    <?php if ( $existing_line_uid ) : ?>
        <div class="warning">
            <strong>注意:</strong> 此帳號已綁定 LINE (UID: <?php echo esc_html( substr( $existing_line_uid, 0, 10 ) . '...' ); ?>)<br>
            若要測試綁定流程，請先手動清除綁定記錄。
        </div>
    <?php else : ?>
        <div class="success">
            <strong>狀態:</strong> 此帳號尚未綁定 LINE，可以進行綁定測試。
        </div>
    <?php endif; ?>

    <h2>測試步驟</h2>
    <ol>
        <li>點擊下方「開始綁定」按鈕</li>
        <li>完成 LINE OAuth 授權</li>
        <li>預期：顯示綁定確認頁面（Fallback 模式）</li>
        <li>點擊確認按鈕</li>
        <li>預期：綁定成功並導向 <?php echo esc_html( $redirect_url ); ?></li>
    </ol>

    <h2>產生的綁定 URL</h2>
    <div class="info">
        <code style="word-break: break-all;"><?php echo esc_html( $authorize_url ); ?></code>
    </div>

    <p>
        <a href="<?php echo esc_url( $authorize_url ); ?>" class="btn">開始綁定 LINE 帳號</a>
    </p>

    <h2>驗證要點</h2>
    <ul>
        <li>State 中應包含 <code>user_id: <?php echo $user_id; ?></code></li>
        <li>OAuth callback 後應顯示「綁定確認」頁面，而非「註冊」頁面</li>
        <li>確認後應執行 <code>handle_link_submission()</code>，而非 <code>handle_register_submission()</code></li>
        <li>綁定成功後應有成功訊息（Transient）</li>
    </ul>

    <hr>
    <p><small>此腳本僅供開發測試使用，請勿在正式環境保留。</small></p>
</body>
</html>
```

此腳本:
- 自動載入 WordPress 環境
- 驗證用戶登入狀態
- 顯示當前用戶資訊和 LINE 綁定狀態
- 產生帶有 user_id 的綁定 URL
- 提供清晰的測試步驟指引
  </action>
  <verify>
ls -la test-link-flow.php
php -l test-link-flow.php
  </verify>
  <done>
- test-link-flow.php 已建立在外掛根目錄
- 腳本語法正確
- 可通過瀏覽器訪問執行綁定流程測試
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
完整的註冊/登入/綁定流程實作,包括:
- Plan 11-01: handle_link_submission() 方法
- Plan 11-01: handle_callback() 綁定流程判斷
- Plan 11-02 Task 2: test-link-flow.php 測試腳本
- 現有: 新用戶註冊（Phase 10）
- 現有: Auto-link（Phase 10）
- 現有: 已有用戶登入（Phase 9）
  </what-built>
  <how-to-verify>
測試四個流程場景:

**準備工作:**
1. 確保測試環境乾淨（清除舊的 LINE 綁定記錄）
2. 開啟瀏覽器無痕模式（避免快取影響）

**案例 1: 新用戶註冊（FLOW-01）**
1. 確保未登入 WordPress
2. 訪問 https://test.buygo.me/wp-login.php?loginSocial=buygo-line
3. 完成 LINE OAuth 授權
4. 應顯示註冊表單（Register Flow Page 或 Fallback）
5. 填寫用戶名和 Email,提交
6. 預期: 成功建立帳號並登入,導向首頁

**案例 2: Auto-link（FLOW-02）**
1. 先在 WordPress 建立帳號（使用 LINE Email）
2. 確保該帳號未綁定 LINE
3. 使用無痕模式訪問 https://test.buygo.me/wp-login.php?loginSocial=buygo-line
4. 完成 LINE OAuth 授權
5. 預期: 自動綁定到現有帳號並登入,不顯示註冊表單

**案例 3: 已有用戶登入（FLOW-04）**
1. 使用案例 1 或 2 建立的已綁定帳號
2. 登出後再訪問 https://test.buygo.me/wp-login.php?loginSocial=buygo-line
3. 完成 LINE OAuth 授權
4. 預期: 直接登入,不顯示任何表單

**案例 4: 已登入用戶綁定（FLOW-03）**
使用測試腳本進行測試:

1. 建立新 WordPress 帳號（未綁定 LINE）並登入
2. 訪問測試腳本: https://test.buygo.me/wp-content/plugins/buygo-line-notify/test-link-flow.php
3. 確認頁面顯示:
   - 當前用戶資訊正確
   - 顯示「尚未綁定 LINE」狀態
   - 產生的綁定 URL 包含正確資訊
4. 點擊「開始綁定 LINE 帳號」按鈕
5. 完成 LINE OAuth 授權
6. 預期: 顯示綁定確認頁面（Fallback 模式），而非註冊頁面
7. 點擊確認按鈕
8. 預期: 綁定成功並導向 /my-account/

**驗證重點:**
- State 驗證是否正常（無「State 驗證失敗」錯誤）
- 各流程是否正確區分（登入/註冊/綁定）
- 案例 4 的綁定流程是否正確觸發 FLOW_LINK（而非 FLOW_REGISTER）
- 錯誤訊息是否清晰且使用者友善
  </how-to-verify>
  <resume-signal>
請描述測試結果:
- 案例 1 結果: [通過/失敗 + 說明]
- 案例 2 結果: [通過/失敗 + 說明]
- 案例 3 結果: [通過/失敗 + 說明]
- 案例 4 結果: [通過/失敗 + 說明]

如果所有案例通過,輸入 "approved"
如果有失敗,描述問題細節
  </resume-signal>
</task>

</tasks>

<verification>
1. 案例 1-4 全部通過用戶驗證
2. 無 State 驗證錯誤
3. 流程正確區分
4. 測試完成後刪除 test-link-flow.php
</verification>

<success_criteria>
- [ ] 新用戶註冊流程正常（FLOW-01）
- [ ] Auto-link 流程正常（FLOW-02）
- [ ] 已有用戶登入流程正常（FLOW-04）
- [ ] 已登入用戶綁定流程正常（FLOW-03）
- [ ] State 驗證機制正常運作（FLOW-05）
- [ ] 用戶驗證通過（checkpoint approved）
</success_criteria>

<output>
After completion, create `.planning/phases/11-完整註冊-登入-綁定流程/11-02-SUMMARY.md`
</output>
