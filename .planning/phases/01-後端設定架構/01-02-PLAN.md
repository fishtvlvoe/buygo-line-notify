---
phase: 01-後端設定架構
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - includes/api/class-settings-api.php
  - includes/class-plugin.php
autonomous: true

must_haves:
  truths:
    - "GET /wp-json/buygo-line-notify/v1/settings 回傳所有設定（敏感欄位遮蔽）"
    - "POST /wp-json/buygo-line-notify/v1/settings/{group} 可更新特定群組設定"
    - "未登入用戶無法存取設定端點（403）"
    - "非管理員無法存取設定端點（403）"
    - "驗證失敗時回傳清楚的錯誤訊息"
  artifacts:
    - path: "includes/api/class-settings-api.php"
      provides: "設定 REST API 端點"
      exports: ["Settings_API"]
      min_lines: 150
  key_links:
    - from: "includes/api/class-settings-api.php"
      to: "includes/services/class-settings-service.php"
      via: "SettingsService::get_group() / set_group() 讀寫設定"
      pattern: "SettingsService::(get_group|set_group)"
    - from: "includes/api/class-settings-api.php"
      to: "includes/schemas/class-settings-schema.php"
      via: "Settings_Schema::GROUPS 驗證群組名稱"
      pattern: "Settings_Schema::GROUPS"
    - from: "includes/class-plugin.php"
      to: "includes/api/class-settings-api.php"
      via: "rest_api_init hook 註冊路由"
      pattern: "Settings_API.*register_routes"
---

<objective>
建立設定 REST API 端點，讓前端介面可透過 API 讀取和儲存所有 LINE 整合設定。

Purpose: 提供標準化的 REST API 介面，支援前端 SPA 架構的設定管理。所有設定操作都經過權限檢查、驗證和清理。

Output:
- Settings_API 類別：繼承 WP_REST_Controller，提供 GET/POST 端點
- 完整的權限控制和錯誤處理
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-後端設定架構/01-RESEARCH.md
@.planning/phases/01-後端設定架構/01-01-SUMMARY.md

# 相關程式碼
@includes/services/class-settings-service.php
@includes/schemas/class-settings-schema.php
@includes/api/class-login-api.php (參考現有 API 結構)
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 Settings_API 類別</name>
  <files>includes/api/class-settings-api.php</files>
  <action>
建立 `includes/api/class-settings-api.php`，繼承 `WP_REST_Controller`。

類別結構：

```php
namespace BuygoLineNotify\API;

use BuygoLineNotify\Services\SettingsService;
use BuygoLineNotify\Schemas\Settings_Schema;

class Settings_API extends \WP_REST_Controller {
    protected $namespace = 'buygo-line-notify/v1';
    protected $rest_base = 'settings';

    // 敏感欄位定義（用於遮蔽回應）
    private const SENSITIVE_FIELDS = [
        'messaging_api' => ['channel_access_token', 'channel_secret'],
        'login' => ['channel_id', 'channel_secret'],
    ];
```

需實作的方法：

1. **register_routes()**
   註冊以下路由：
   - GET `/settings` - 取得所有設定
   - GET `/settings/{group}` - 取得特定群組設定
   - POST `/settings/{group}` - 更新特定群組設定

   ```php
   register_rest_route($this->namespace, '/' . $this->rest_base, [
       [
           'methods' => \WP_REST_Server::READABLE,
           'callback' => [$this, 'get_settings'],
           'permission_callback' => [$this, 'get_settings_permissions_check'],
       ],
   ]);

   register_rest_route($this->namespace, '/' . $this->rest_base . '/(?P<group>[a-z_]+)', [
       [
           'methods' => \WP_REST_Server::READABLE,
           'callback' => [$this, 'get_settings_group'],
           'permission_callback' => [$this, 'get_settings_permissions_check'],
           'args' => [
               'group' => [
                   'required' => true,
                   'validate_callback' => [$this, 'validate_group'],
               ],
           ],
       ],
       [
           'methods' => \WP_REST_Server::EDITABLE,
           'callback' => [$this, 'update_settings_group'],
           'permission_callback' => [$this, 'update_settings_permissions_check'],
           'args' => [
               'group' => [
                   'required' => true,
                   'validate_callback' => [$this, 'validate_group'],
               ],
           ],
       ],
   ]);
   ```

2. **get_settings_permissions_check($request): bool**
   - 檢查 `current_user_can('manage_options')`
   - 未登入或非管理員回傳 false

3. **update_settings_permissions_check($request): bool**
   - 同上，檢查 `manage_options` capability

4. **validate_group($param, $request, $key): bool**
   - 檢查 group 是否在 Settings_Schema::GROUPS 中

5. **get_settings($request): WP_REST_Response**
   - 呼叫 SettingsService::get_all_groups()
   - 遮蔽敏感欄位（使用 mask_value 方法）
   - 回傳 { success: true, data: {...} }

6. **get_settings_group($request): WP_REST_Response|WP_Error**
   - 取得 group 參數
   - 呼叫 SettingsService::get_group($group)
   - 遮蔽敏感欄位
   - 回傳 { success: true, data: {...} }

7. **update_settings_group($request): WP_REST_Response|WP_Error**
   - 取得 group 參數和 JSON body
   - 呼叫 SettingsService::set_group($group, $data)
   - 如果是 WP_Error，直接回傳
   - 成功回傳 { success: true, message: '設定已更新', data: {...} }

8. **mask_value(string $value): string** (private)
   - 長度 <= 8：全部遮蔽
   - 長度 > 8：保留最後 4 字元，其餘遮蔽
   - 範例：`abc12345678` → `*******5678`

9. **mask_sensitive_fields(string $group, array $data): array** (private)
   - 根據 SENSITIVE_FIELDS 遮蔽對應欄位
   - 新增 `{field}_set` 欄位標示原值是否存在

錯誤處理：
- 無效群組：回傳 WP_Error('invalid_settings_group', '無效的設定群組', ['status' => 400])
- 驗證失敗：回傳 SettingsService::set_group 的 WP_Error
- 儲存失敗：回傳 WP_Error('settings_update_failed', '設定儲存失敗', ['status' => 500])
  </action>
  <verify>
1. 檔案存在：`ls includes/api/class-settings-api.php`
2. 繼承正確：`grep "extends.*WP_REST_Controller" includes/api/class-settings-api.php`
3. 路由註冊：`grep "register_rest_route" includes/api/class-settings-api.php | wc -l` 應 >= 2
4. 權限檢查：`grep "manage_options" includes/api/class-settings-api.php`
5. PHP 語法檢查：`php -l includes/api/class-settings-api.php`
  </verify>
  <done>
Settings_API 類別完成：
- GET /settings 端點可取得所有設定
- GET /settings/{group} 端點可取得特定群組
- POST /settings/{group} 端點可更新設定
- 敏感欄位自動遮蔽
- 完整的權限檢查和錯誤處理
  </done>
</task>

<task type="auto">
  <name>Task 2: 註冊 API 路由到 Plugin</name>
  <files>includes/class-plugin.php</files>
  <action>
更新 Plugin 類別，在 rest_api_init hook 註冊 Settings_API 路由。

1. 在 load_dependencies() 中新增載入：
   ```php
   require_once BUYGO_LINE_NOTIFY_PATH . 'includes/api/class-settings-api.php';
   ```

2. 在 register_hooks() 或對應方法中新增：
   ```php
   add_action('rest_api_init', [$this, 'register_rest_routes']);
   ```

3. 新增 register_rest_routes() 方法（如果不存在）：
   ```php
   public function register_rest_routes(): void {
       $settings_api = new \BuygoLineNotify\API\Settings_API();
       $settings_api->register_routes();
   }
   ```

   注意：如果已有此方法，只需在其中加入 Settings_API 的路由註冊。

4. 確認載入順序：
   - schemas/class-settings-schema.php（01-01 已加入）
   - services/class-settings-service.php
   - api/class-settings-api.php

注意：參考現有的 Login_API 或其他 API 類別的註冊方式，保持一致性。
  </action>
  <verify>
1. API 載入：`grep "settings-api" includes/class-plugin.php`
2. 路由註冊：`grep "Settings_API" includes/class-plugin.php`
3. PHP 語法檢查：`php -l includes/class-plugin.php`
  </verify>
  <done>
Plugin 更新完成：
- Settings_API 類別在正確時機載入
- rest_api_init hook 註冊路由
- 載入順序正確
  </done>
</task>

<task type="auto">
  <name>Task 3: API 端點功能驗證</name>
  <files>test-settings-api.php</files>
  <action>
建立測試腳本 `test-settings-api.php` 在外掛根目錄，驗證 API 端點功能。

測試腳本內容：

```php
<?php
/**
 * Settings API 測試腳本
 * 執行方式：在 WordPress 環境中載入此檔案
 * 或使用 WP-CLI: wp eval-file test-settings-api.php
 */

// 載入 WordPress
require_once dirname(__FILE__, 4) . '/wp-load.php';

// 確保外掛已啟用
if (!class_exists('BuygoLineNotify\Schemas\Settings_Schema')) {
    die("Error: buygo-line-notify 外掛未啟用\n");
}

use BuygoLineNotify\Schemas\Settings_Schema;
use BuygoLineNotify\Services\SettingsService;

echo "=== Settings Schema 測試 ===\n";

// 測試 1: Schema 結構
$schema = Settings_Schema::get_schema();
$expected_groups = ['messaging_api', 'login', 'button', 'email', 'integrations', 'sync', 'liff'];
$actual_groups = array_keys($schema);
echo "群組數量: " . count($actual_groups) . " (預期 7)\n";
echo "群組名稱: " . implode(', ', $actual_groups) . "\n";

// 測試 2: 預設值
echo "\n=== 預設值測試 ===\n";
$button_defaults = Settings_Schema::get_defaults('button');
echo "button.login_position 預設: " . ($button_defaults['login_position'] ?? 'NULL') . " (預期 before)\n";
echo "button.style 預設: " . ($button_defaults['style'] ?? 'NULL') . " (預期 official)\n";

// 測試 3: 驗證 - 有效資料
echo "\n=== 驗證測試（有效資料）===\n";
$valid_data = [
    'login_position' => 'after',
    'style' => 'minimal',
    'login_text' => '用 LINE 登入',
];
$result = Settings_Schema::validate('button', $valid_data);
if (is_wp_error($result)) {
    echo "ERROR: " . $result->get_error_message() . "\n";
} else {
    echo "驗證通過: " . json_encode($result, JSON_UNESCAPED_UNICODE) . "\n";
}

// 測試 4: 驗證 - 無效資料
echo "\n=== 驗證測試（無效資料）===\n";
$invalid_data = [
    'login_position' => 'invalid_value',
    'style' => 'official',
];
$result = Settings_Schema::validate('button', $invalid_data);
if (is_wp_error($result)) {
    echo "預期的錯誤: " . $result->get_error_message() . "\n";
    $error_data = $result->get_error_data();
    if (isset($error_data['errors'])) {
        echo "錯誤欄位: " . json_encode($error_data['errors'], JSON_UNESCAPED_UNICODE) . "\n";
    }
} else {
    echo "WARNING: 應該要驗證失敗但通過了\n";
}

// 測試 5: SettingsService 群組操作
echo "\n=== SettingsService 測試 ===\n";
$button_settings = SettingsService::get_group('button');
echo "讀取 button 群組: " . json_encode($button_settings, JSON_UNESCAPED_UNICODE) . "\n";

echo "\n=== 測試完成 ===\n";
```

注意：
- 這是開發測試用腳本，不要提交到版本控制
- 完成測試後可刪除
  </action>
  <verify>
1. 測試腳本存在：`ls test-settings-api.php`
2. 使用 WP-CLI 執行測試（如果可用）：
   ```bash
   cd /Users/fishtv/Local\ Sites/buygo/app/public && wp eval-file /Users/fishtv/Development/buygo-line-notify/test-settings-api.php
   ```
   或在瀏覽器載入測試（需登入 WordPress 管理員）

3. 預期輸出：
   - 群組數量: 7
   - 預設值正確
   - 有效資料驗證通過
   - 無效資料驗證失敗
  </verify>
  <done>
API 功能驗證完成：
- Schema 結構正確
- 預設值正確
- 驗證邏輯正確（有效資料通過，無效資料拒絕）
- SettingsService 群組操作正常
  </done>
</task>

</tasks>

<verification>
整體驗證步驟：

1. **PHP 語法檢查**
   ```bash
   php -l includes/api/class-settings-api.php
   php -l includes/class-plugin.php
   ```

2. **REST API 端點測試（需 WordPress 環境）**
   使用 curl 或 Postman 測試：

   ```bash
   # 取得所有設定（需管理員身份）
   curl -X GET "https://test.buygo.me/wp-json/buygo-line-notify/v1/settings" \
     -H "Cookie: [管理員登入 cookie]"

   # 取得特定群組
   curl -X GET "https://test.buygo.me/wp-json/buygo-line-notify/v1/settings/button" \
     -H "Cookie: [管理員登入 cookie]"

   # 更新設定
   curl -X POST "https://test.buygo.me/wp-json/buygo-line-notify/v1/settings/button" \
     -H "Content-Type: application/json" \
     -H "X-WP-Nonce: [nonce]" \
     -H "Cookie: [管理員登入 cookie]" \
     -d '{"login_position": "after", "style": "minimal"}'

   # 未授權測試（預期 403）
   curl -X GET "https://test.buygo.me/wp-json/buygo-line-notify/v1/settings"
   ```

3. **敏感資料遮蔽確認**
   - GET /settings 回應中，channel_access_token 應顯示為 `****1234` 格式
   - channel_access_token_set 應為 true（如果有值）
</verification>

<success_criteria>
Plan 01-02 完成條件：

1. [ ] Settings_API 類別存在於 includes/api/class-settings-api.php
2. [ ] GET /wp-json/buygo-line-notify/v1/settings 端點可用
3. [ ] GET /wp-json/buygo-line-notify/v1/settings/{group} 端點可用
4. [ ] POST /wp-json/buygo-line-notify/v1/settings/{group} 端點可用
5. [ ] 未登入用戶存取返回 401/403
6. [ ] 非管理員存取返回 403
7. [ ] 敏感欄位在回應中被遮蔽
8. [ ] 無效群組返回 400 錯誤
9. [ ] 驗證失敗返回清楚的錯誤訊息
10. [ ] 所有 PHP 檔案語法正確
</success_criteria>

<output>
完成後建立 `.planning/phases/01-後端設定架構/01-02-SUMMARY.md`
</output>
